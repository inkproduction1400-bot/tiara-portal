This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: node_modules/**, .next/**, .vercel/**, dist/**, .turbo/**, .git/**, .DS_Store, *.log, *.lock, coverage/**, playwright-report/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  workflows/
    api-smoke.yml
app/
  dev/
    docs/
      [[...slug]]/
        page.tsx
      page.tsx
    page.tsx
content/
  docs/
    runbooks/
      local-smoke.md
    assignments.md
    index.md
docs/
  openapi.yaml
lib/
  audit.ts
  db.ts
  mdx.ts
  supabaseServer.ts
  tasksLoader.ts
  validate.ts
pages/
  api/
    casts/
      [id].ts
      index.ts
    questionnaire/
      [kind]/
        load.ts
        save.ts
    shifts/
      [id].ts
      index.ts
    stores/
      index.ts
    webhooks/
      chatwoot.ts
      line.ts
    health.ts
    tasks.ts
  docs/
    coding-rules.tsx
    openapi.yaml
  _app.tsx
  actions.tsx
  casts.tsx
  erd.tsx
  index.tsx
  progress.tsx
  questionnaire.tsx
  rules.tsx
  wbs.tsx
public/
  data/
    tasks.json
  docs/
    WBS.xlsx
    è³ªå•ç¥¨ãƒˆã‚™ãƒ©ãƒ•ãƒˆ.numbers
scripts/
  seed.ts
  test-api.sh
styles/
  globals.css
supabase/
  .temp/
    cli-latest
    gotrue-version
    pooler-url
    postgres-version
    project-ref
    rest-version
    storage-version
  migrations/
    0001_init.sql
    0002_unique_cast_name.sql
    0003_mvp_plus_columns.sql
    0004_rls_minimal.sql
    0005_shift_search_indexes.sql
    0006_shifts_status_check_add_canceled.sql
    20250921051301_unique_shift_cast_start.sql
    20250921051302_unique_store_name.sql
    20250921055945_audit_logs.sql
    20250921061332_audit_logs_add_ip_useragent.sql
    20250921090304_rls_strict_all_deny.sql
    20250921091553_rls_strict_all_deny.sql
.gitignore
next-env.d.ts
package.json
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="content/docs/assignments.md">
# Assignments API æ¤œè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

Tiara API ã«ãŠã‘ã‚‹ã€Œã‚­ãƒ£ã‚¹ãƒˆã®ã‚¢ã‚µã‚¤ãƒ³ï¼ˆå‡ºå‹¤äºˆå®šãƒ»å‰²å½“ï¼‰ã€æ©Ÿèƒ½ã®æ¤œè¨¼æ‰‹é †ã§ã™ã€‚  
NestJS + Prisma ã«ã¦å®Ÿè£…ã•ã‚Œã€`shops/:shopId/assignments` é…ä¸‹ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## ğŸ“˜ 1. æ¦‚è¦

| è¦ç´  | å†…å®¹ |
|------|------|
| ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ | `/api/v1/shops/:shopId/assignments` |
| å¯¾è±¡ãƒ¢ãƒ‡ãƒ« | `ShopAssignment` |
| ä¸»ã‚­ãƒ¼ | `id` (UUID) |
| ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ | `(shopId, castId, assignedFrom)` |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | `planned / assigned / working / completed / cancelled` |
| èªå¯ | `x-user-id` ãƒ˜ãƒƒãƒ€å¿…é ˆï¼ˆadmin ã¾ãŸã¯ staff ãƒ­ãƒ¼ãƒ«ï¼‰ |

---

## âš™ï¸ 2. å‰æ

ä»¥ä¸‹ã®å¤‰æ•°ã‚’ç’°å¢ƒã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

```bash
USER_ID=<ç®¡ç†è€…ã® UUID>   # admin@example.com ã®ID
SHOP_ID=<åº—èˆ—ID>
CAST_ID=<ã‚­ãƒ£ã‚¹ãƒˆID>
API=http://localhost:4001
DATE=$(date -u +%F)
ç’°å¢ƒå¤‰æ•°ã‚’ .env ã‹ã‚‰èª­ã¿ãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
alias DENV='npx dotenv -e .env --'
USER_ID=$(DENV bash -lc 'psql "$OWNER_DATABASE_URL" -At -c "SELECT id FROM users WHERE email='\''admin@example.com'\'' LIMIT 1;"')
ğŸ§± 3. æ–°è¦ã‚¢ã‚µã‚¤ãƒ³ä½œæˆ (POST)
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
POST /api/v1/shops/:shopId/assignments

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹
bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
curl -sS -X POST "$API/api/v1/shops/$SHOP_ID/assignments" \
  -H "x-user-id: $USER_ID" \
  -H "Content-Type: application/json" \
  -d "{
    \"castId\": \"$CAST_ID\",
    \"assignedFrom\": \"${DATE}T19:00:00Z\",
    \"priority\": 1
  }" | jq .
æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
json
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
{
  "id": "7b4784b8-3fea-42ee-803c-6d2b2b4ca20e",
  "shopId": "dcb32f1b-ccc4-4f90-868d-0f90e04f32fe",
  "castId": "3fc8eebf-9699-4bae-a98b-218b66df1e15",
  "assignedFrom": "2025-11-01T19:00:00.000Z",
  "assignedTo": null,
  "status": "planned",
  "priority": 1,
  "createdAt": "2025-11-01T12:18:04.210Z",
  "updatedAt": "2025-11-01T12:18:04.210Z"
}
ã‚¨ãƒ©ãƒ¼ä¾‹ï¼ˆé‡è¤‡ã‚¹ãƒ­ãƒƒãƒˆï¼‰
åŒä¸€ shopId + castId + assignedFrom ã§å†åº¦ POST ã™ã‚‹ã¨ï¼š

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
HTTP/1.1 409 Conflict
{
  "message": "Duplicate slot for this shop/cast/assignedFrom",
  "error": "Conflict",
  "statusCode": 409
}
ğŸ” 4. ä¸€è¦§å–å¾— (GET)
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
GET /api/v1/shops/:shopId/assignments?date=YYYY-MM-DD

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹
bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
curl -sS "$API/api/v1/shops/$SHOP_ID/assignments?date=$DATE" \
  -H "x-user-id: $USER_ID" | jq .
æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
json
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
[
  {
    "id": "7539f313-aa95-4c1a-b4bc-e72083b24fd8",
    "shopId": "dcb32f1b-ccc4-4f90-868d-0f90e04f32fe",
    "castId": "3fc8eebf-9699-4bae-a98b-218b66df1e15",
    "assignedFrom": "2025-11-01T18:00:00.000Z",
    "status": "planned",
    "priority": 1
  },
  {
    "id": "7b4784b8-3fea-42ee-803c-6d2b2b4ca20e",
    "shopId": "dcb32f1b-ccc4-4f90-868d-0f90e04f32fe",
    "castId": "3fc8eebf-9699-4bae-a98b-218b66df1e15",
    "assignedFrom": "2025-11-01T19:00:00.000Z",
    "assignedTo": "2025-11-01T21:00:00.000Z",
    "status": "assigned",
    "priority": 3
  }
]
âœï¸ 5. æ›´æ–° (PATCH)
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
PATCH /api/v1/shops/:shopId/assignments/:id

æ›´æ–°é …ç›®
priorityï¼ˆæ•´æ•°ï¼‰

statusï¼ˆplanned / assigned / working / completed / cancelledï¼‰

assignedToï¼ˆæ—¥æ™‚ï¼‰

ä¾‹1: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å„ªå…ˆåº¦ã‚’æ›´æ–°
bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
ASSIGN_ID=<POSTã§å¾—ãŸid>

curl -sS -X PATCH "$API/api/v1/shops/$SHOP_ID/assignments/$ASSIGN_ID" \
  -H "x-user-id: $USER_ID" -H "Content-Type: application/json" \
  -d '{"priority":3,"status":"assigned"}' | jq .
çµæœï¼š

json
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
{
  "id": "7b4784b8-3fea-42ee-803c-6d2b2b4ca20e",
  "status": "assigned",
  "priority": 3
}
ä¾‹2: çµ‚äº†æ™‚åˆ»ã‚’ä»˜ä¸
bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
curl -sS -X PATCH "$API/api/v1/shops/$SHOP_ID/assignments/$ASSIGN_ID" \
  -H "x-user-id: $USER_ID" -H "Content-Type: application/json" \
  -d "{\"assignedTo\":\"${DATE}T21:00:00Z\"}" | jq .
ğŸš« 6. ã‚¨ãƒ©ãƒ¼ä»•æ§˜ä¸€è¦§
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹	æ„å‘³	å¯¾å¿œæ–¹æ³•
400	ValidationPipe ã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸æ­£	å‹ãƒ»å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèª
401	x-user-id ãƒ˜ãƒƒãƒ€ãŒãªã„	ãƒ˜ãƒƒãƒ€ã‚’è¿½åŠ ã™ã‚‹
403	ãƒ­ãƒ¼ãƒ«ä¸ä¸€è‡´ (required roles: admin, staff)	ãƒ¦ãƒ¼ã‚¶ã« admin or staff ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
404	ä¸å­˜åœ¨ã®ã‚·ãƒ§ãƒƒãƒ—/ã‚¢ã‚µã‚¤ãƒ³ID	IDèª¤ã‚Š
409	ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„é•å	åŒä¸€ã‚¹ãƒ­ãƒƒãƒˆé‡è¤‡ã€‚PATCH ã§æ›´æ–°ã™ã‚‹
500	Prismaä¾‹å¤–ãªã©å†…éƒ¨ã‚¨ãƒ©ãƒ¼	docker compose logs api ã§ã‚¹ã‚¿ãƒƒã‚¯ç¢ºèª

ğŸ§© 7. Swagger UI ç¢ºèª
ç’°å¢ƒ	URL
é–‹ç™º	http://localhost:4001/docs
æœ¬ç•ªãƒ‘ã‚¹æ¤œè¨¼	http://localhost:4001/api/v1/docs

Swagger ä¸Šã§ shops/{shopId}/assignments ã‚’é–‹ãã€
Try it out â†’ Execute ã‚’æŠ¼ä¸‹ã—ã¦ POST / GET / PATCH ã‚’é †ã«ç¢ºèªã§ãã¾ã™ã€‚

ğŸ’¡ 8. è£œè¶³Tips
8.1 ä¾¿åˆ©ãªã‚·ã‚§ãƒ«é–¢æ•°
ã‚ˆãä½¿ã†æ“ä½œã‚’ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
# scripts/assignments.sh (æŠœç²‹)
post_assign () {
  local date="$1" time="$2" prio="${3:-1}"
  curl -sS -X POST "$API/api/v1/shops/$SHOP_ID/assignments" \
    -H "x-user-id: $USER_ID" -H "Content-Type: application/json" \
    -d "{\"castId\":\"$CAST_ID\",\"assignedFrom\":\"${date}T${time}\",\"priority\":${prio}}" | jq .
}

list_assign () {
  local date="$1"
  curl -sS "$API/api/v1/shops/$SHOP_ID/assignments?date=$date" \
    -H "x-user-id: $USER_ID" | jq .
}

patch_assign () {
  local id="$1" payload="$2"
  curl -sS -X PATCH "$API/api/v1/shops/$SHOP_ID/assignments/$id" \
    -H "x-user-id: $USER_ID" -H "Content-Type: application/json" \
    -d "$payload" | jq .
}
å‘¼ã³å‡ºã—ä¾‹ï¼š

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
. scripts/assignments.sh
DATE=$(date -u +%F)
post_assign "$DATE" "19:00:00Z" 2
list_assign "$DATE"
âœ… 9. æƒ³å®šãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª
No	ãƒ†ã‚¹ãƒˆå†…å®¹	æœŸå¾…çµæœ
1	æ–°è¦ã‚¢ã‚µã‚¤ãƒ³ï¼ˆåˆå›POSTï¼‰	201 Created
2	åŒä¸€æ¡ä»¶ã§å†POST	409 Conflict
3	PATCHã§statusæ›´æ–°	200 OK, statuså¤‰æ›´åæ˜ 
4	PATCHã§assignedToè¿½åŠ 	200 OK, çµ‚äº†æ™‚åˆ»åæ˜ 
5	GETã§ä¸¡ä»¶å–å¾—	2ä»¶å‡ºåŠ›ï¼ˆ18æ™‚/19æ™‚ï¼‰
6	x-user-idãªã—ã§POST	401 Unauthorized
7	ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ã§POST	403 Forbidden
8	ä¸æ­£ãªUUIDæŒ‡å®š	400 Bad Request

ğŸ§¾ 10. å‚è€ƒ
NestJS Controller: src/assignments/assignments.controller.ts

Prisma Model: prisma/schema.prisma â†’ model ShopAssignment

Business Logic: src/assignments/assignments.service.ts

Error Handling: P2002 (unique constraint) â†’ 409 Conflict

Â© 2025 Tiara API Development Team / Nagai

yaml
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹

---

ã“ã‚Œã‚’ `docs/assignments.md` ã¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã™ã‚Œã°ã€  
APIãƒ†ã‚¹ãƒˆæ‹…å½“è€…ãƒ»å¾Œç¶šé–‹ç™ºè€…ãŒã™ãå†ç¾ã§ãã‚‹å®Œå…¨ãª Runbook ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚
</file>

<file path="content/docs/index.md">
# Tiara API é–‹ç™ºãƒãƒ¼ã‚¿ãƒ«

ã‚ˆã†ã“ãï¼ã“ã“ã¯ Tiara API ãƒªãƒã‚¸ãƒˆãƒªã®é–‹ç™ºè€…å‘ã‘ãƒãƒ¼ã‚¿ãƒ«ã§ã™ã€‚  
æ—¥ã€…ã®é–‹ç™ºã§ã€Œæœ€åˆã«é–‹ãå ´æ‰€ã€ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

---

## ç›®æ¬¡

- ğŸ‘Ÿ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ
- ğŸ§° ã‚ˆãä½¿ã†è³‡æ–™
- ğŸ§ª ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
- ğŸ§¾ é‹ç”¨ãƒãƒ¼ãƒˆ / ãƒ©ãƒ³ãƒ–ãƒƒã‚¯
- ğŸ›  ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ Make ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
- ğŸ§± ã‚¹ã‚­ãƒ¼ãƒ / ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ğŸ§­ API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆSwaggerï¼‰

---

## ğŸ‘Ÿ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

1. `.env` ã‚’æº–å‚™ï¼ˆDB / API ãƒãƒ¼ãƒˆç­‰ï¼‰
2. ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–  
   ```bash
   make bootstrap
èµ·å‹•

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
make up
å‹•ä½œç¢ºèªï¼ˆã‚¹ãƒ¢ãƒ¼ã‚¯ï¼‰

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
make smoke
å‚è€ƒï¼šåˆæœŸåŒ–ã‚„ä¸€é€£ã®ç¢ºèªæ‰‹é †ã¯ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ»ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ ã«è©³ç´°ã‚ã‚Šã€‚

ğŸ§° ã‚ˆãä½¿ã†è³‡æ–™
ğŸ—‚ Assignments æ©Ÿèƒ½ã®ä»•æ§˜ã¨ç¢ºèªæ‰‹é † â†’ docs/assignments.md

ğŸ§ª ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ»ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ â†’ docs/runbooks/local-smoke.md

ğŸ§ª ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
æœ€ä½é™ã®å¥åº·ãƒã‚§ãƒƒã‚¯ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèªï¼š

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
make up
make smoke
/api/v1/health ãŒ ok: true ã‚’è¿”ã™

Nest ã®ãƒ­ã‚°ã« Mapped {/api/v1/shops/:shopId/assignments, ...} ãŒå‡ºã¦ã„ã‚‹

è©³ç´°ãªæ‰‹é †ï¼ˆSHOP/CAST ä½œæˆã€å‰²å½“ã® POST/LIST/PATCH ãªã©ï¼‰ã¯
ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ»ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ ã‚’å‚ç…§ã€‚

ğŸ§¾ é‹ç”¨ãƒãƒ¼ãƒˆ / ãƒ©ãƒ³ãƒ–ãƒƒã‚¯
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ã‚¹ãƒ¢ãƒ¼ã‚¯æ‰‹é † â†’ runbooks/local-smoke.md

ï¼ˆå°†æ¥ï¼‰ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°/æœ¬ç•ªã®ãƒ­ãƒ¼ãƒ³ãƒæ‰‹é † â†’ runbooks/launch-stg.md / runbooks/launch-prod.md

ï¼ˆå°†æ¥ï¼‰éšœå®³å¯¾å¿œãƒ¡ãƒ¢ â†’ runbooks/incidents.md

ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã¯**ã€Œå¤±æ•—ã‚’å†ç¾ã§ãã‚‹ã»ã©å…·ä½“çš„ã«ã€**æ›¸ãã®ãŒé‰„å‰‡ã§ã™ã€‚
ä¾‹ï¼šä½¿ã£ãŸã‚³ãƒãƒ³ãƒ‰ã€ç’°å¢ƒå¤‰æ•°ã€æœŸå¾…çµæœã€å®Ÿçµæœã€ãƒ­ã‚°ã®æŠœç²‹ã€æ¬¡ã®åˆ†å²â€¦ã¾ã§ã€‚

ğŸ›  ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ Make ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
scripts/assignments.sh

post / list / patch ã‚’é–¢æ•°åŒ–ã€‚x-user-id ã¯è‡ªå‹•ã§ admin@example.com ã® ID ã‚’è§£æ±º

ä¾‹ï¼š

bash
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
./scripts/assignments.sh post "$SHOP_ID" "$CAST_ID" "2025-11-01T18:00:00Z" 1
./scripts/assignments.sh list "$SHOP_ID" "2025-11-01"
./scripts/assignments.sh patch "$SHOP_ID" "$ASSIGN_ID" status=assigned priority=3 assignedTo=2025-11-01T21:00:00Z
scripts/bootstrap-role-admin.sql

roles ã® admin/staff ä½œæˆã€admin@example.com ã®ä½œæˆã¨ admin ä»˜ä¸

Make ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆæŠœç²‹ï¼‰
text
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
make build        # nest build
make up           # build + docker compose up -d
make logs         # ç›´è¿‘ãƒ­ã‚°
make down         # åœæ­¢
make bootstrap    # admin ä»˜ä¸ï¼ˆOWNER_DATABASE_URL å¿…é ˆï¼‰
make smoke        # æœ€å°ã‚¹ãƒ¢ãƒ¼ã‚¯ï¼ˆhealth / assignments ãƒ«ãƒ¼ãƒˆï¼‰
make assign-post  # ã‚¢ã‚µã‚¤ãƒ³ä½œæˆï¼ˆFROM ãªã©å¤‰æ•°ã§æŒ‡å®šï¼‰
make assign-list  # æŒ‡å®šæ—¥ã®ä¸€è¦§
make assign-patch # æ—¢å­˜ã‚¢ã‚µã‚¤ãƒ³ã®æ›´æ–°
è©³ç´°ãªå¼•æ•°ã‚„ä¾‹ã¯ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ»ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ ã‚’å‚ç…§ã€‚

ğŸ§± ã‚¹ã‚­ãƒ¼ãƒ / ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
Prisma ã‚¹ã‚­ãƒ¼ãƒï¼šprisma/schema.prisma

DB å¤‰æ›´ã¯ å¿…ãš Prisma Migration çµŒç”±ã§è¡Œã„ã€migrate deploy ã‚’é©ç”¨

Neon(æœ¬ç•ª) ã§ã¯ OWNER ã¨ APP ã®æ¥ç¶šæ–‡å­—åˆ—ã®é•ã„ã«æ³¨æ„ï¼ˆæ¨©é™ & _prisma_migrations ã®æœ‰ç„¡ï¼‰

ğŸ§­ API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆSwaggerï¼‰
é–‹ç™º: http://localhost:4000/docs

æœ¬ç•ª: https://<your-host>/api/v1/docs

æœ¬ä½“ã¯ api/v1 ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€‚
Swagger ã® Servers ã« / ã¨ /api/v1 ã‚’ä¸¡æ–¹ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚

yaml
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹

---

## ã©ã†ã€Œãƒªãƒ³ã‚¯ã•ã›ã‚‹ã‹ã€ï¼ˆãƒã‚¤ãƒ³ãƒˆã ã‘ï¼‰

- **ç›¸å¯¾ãƒªãƒ³ã‚¯**ã‚’ä½¿ãˆã° GitHub ä¸Šã§ãã®ã¾ã¾æ©Ÿèƒ½ã—ã¾ã™ã€‚  
  ä¾‹ï¼š`[ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ¢ãƒ¼ã‚¯](./runbooks/local-smoke.md)`ã€`[Assignments](./assignments.md)` ã®ã‚ˆã†ã« **`./`** ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
- æ—¢ã«ä½œæˆæ¸ˆã¿ã®  
  - `docs/assignments.md`  
  - `docs/runbooks/local-smoke.md`  
  ã¨ãƒ‘ã‚¹/ãƒ•ã‚¡ã‚¤ãƒ«åã‚’**ä¸€è‡´**ã•ã›ã¦ãã ã•ã„ï¼ˆãƒ•ã‚©ãƒ«ãƒ€å/å¤§æ–‡å­—å°æ–‡å­—ã®ã‚ºãƒ¬ã«æ³¨æ„ï¼‰ã€‚

---

## ãŠã¾ã‘ï¼ˆä»»æ„ï¼šGitHub Pages ã§å…¬é–‹ã—ãŸã„å ´åˆï¼‰

GitHub ã®ã€ŒSettings â†’ Pagesã€ã§ **Source: GitHub Actions** ã‚’é¸ã³ã€ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ `docs/` ã‚’é™çš„å…¬é–‹ã§ãã¾ã™ï¼ˆMarkdown â†’ ãã®ã¾ã¾é…ä¿¡ï¼‰ã€‚

`.github/workflows/pages.yml`

```yml
name: Publish docs to GitHub Pages
on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/pages.yml'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
ã“ã‚Œã§ https://<org>.github.io/<repo>/ ã« docs/ ç›´ä¸‹ãŒå‡ºã¾ã™ã€‚
ã‚‚ã—å°†æ¥ MkDocs ãªã©ã§ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚„æ¤œç´¢ã‚’ä»˜ã‘ãŸã„å ´åˆã¯ã€ãã®ã¨ãã« mkdocs.yml ã‚’è¿½åŠ ã™ã‚Œã° OKã€‚

ä»•ä¸Šã’ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
docs/index.md ã‚’ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§ä½œæˆ

docs/assignments.md / docs/runbooks/local-smoke.md ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

README.md ã®å…ˆé ­è¿‘ãã«ã€Œé–‹ç™ºãƒãƒ¼ã‚¿ãƒ« â†’ docs/index.mdã€ã¸ã®ãƒªãƒ³ã‚¯ã‚’1è¡Œè¿½åŠ 

md
ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
ğŸ‘‰ é–‹ç™ºè€…å‘ã‘ãƒãƒ¼ã‚¿ãƒ«ã¯ **[docs/index.md](./docs/index.md)** ã‚’å‚ç…§
git add docs && git commit -m "docs: add dev portal and link runbooks" â†’ push
</file>

<file path="lib/mdx.ts">
// lib/mdx.ts
import { compileMDX } from 'next-mdx-remote/rsc';
import remarkGfm from 'remark-gfm';
import rehypeSlug from 'rehype-slug';
import rehypeAutolinkHeadings from 'rehype-autolink-headings';
import fs from 'node:fs/promises';
import path from 'node:path';

export async function loadDoc(slugParts: string[]) {
  const rel = path.join('content', 'docs', ...slugParts) + (slugParts.at(-1)?.endsWith('.md') ? '' : '.md');
  const abs = path.join(process.cwd(), rel);
  const source = await fs.readFile(abs, 'utf8');
  const { content } = await compileMDX({
    source,
    options: {
      parseFrontmatter: true,
      mdxOptions: {
        remarkPlugins: [remarkGfm],
        rehypePlugins: [rehypeSlug, [rehypeAutolinkHeadings, { behavior: 'wrap' }]],
      },
    },
  });
  return content;
}
</file>

<file path="lib/db.ts">
import { createClient } from '@supabase/supabase-js';

const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const service = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!url || !anon) {
  throw new Error('Supabase env missing: set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local');
}

export const supabase = createClient(url, anon, { auth: { persistSession: false } });
export const supabaseAdmin = service
  ? createClient(url, service, { auth: { persistSession: false } })
  : null;
</file>

<file path="lib/supabaseServer.ts">
// /lib/supabaseServer.ts
import { createClient } from "@supabase/supabase-js";

const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// APIãƒ«ãƒ¼ãƒˆå°‚ç”¨ï¼ˆã‚µãƒ¼ãƒãƒ¼ã®ã¿ï¼‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
export const supabaseAdmin = createClient(url, serviceRoleKey, {
  auth: { persistSession: false, autoRefreshToken: false },
});
</file>

<file path="lib/tasksLoader.ts">
// lib/tasksLoader.ts
export type Task = {
    title: string;
    start?: string;   // YYYY-MM-DD
    end?: string;     // YYYY-MM-DD
    started?: boolean;
    done?: boolean;
    progress?: number; // 0..100
    owner?: string;
    status?: string;
  };
  
  export async function loadTasks(): Promise<Task[]> {
    try {
      const r = await fetch('/api/tasks');
      if (r.ok) {
        const json = await r.json();
        return Array.isArray(json?.tasks) ? json.tasks : Array.isArray(json) ? json : [];
      }
    } catch {}
    const r2 = await fetch('/data/tasks.json');
    return await r2.json();
  }
</file>

<file path="lib/validate.ts">
// lib/validate.ts
import { z } from 'zod';

export const pageSchema = z.object({
  page:  z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(30),
  sort:  z.string().optional(),
});

export const dateRangeSchema = z.object({
  from: z.string().datetime().optional(),
  to:   z.string().datetime().optional(),
});

export const shiftsQuerySchema = pageSchema
  .merge(dateRangeSchema)
  .extend({
    store_id: z.string().uuid().optional(),
    cast_id:  z.string().uuid().optional(),
    status:   z.enum(['scheduled','confirmed','canceled','finished']).optional(),
    role:     z.enum(['cast']).optional(),
    expand:   z.enum(['names']).optional(),
  });

export const castsQuerySchema = pageSchema.extend({
  keyword:   z.string().optional(),
  owner:     z.string().optional(),
  genre:     z.string().optional(),
  drinkable: z.coerce.boolean().optional(),
  wage_min:  z.coerce.number().optional(),
  active:    z.coerce.boolean().optional(),
  sort:      z.string().optional(), // ä¾‹: "rating,wage,name"
});

export const storesQuerySchema = pageSchema.extend({
  keyword: z.string().optional(),
  active:  z.coerce.boolean().optional(),
  sort:    z.string().optional(),
});

// çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
export type ApiError = { ok:false; code:'VALIDATION_ERROR'|'DB_ERROR'|'INTERNAL_ERROR'; message:string };
export const err = (code:ApiError['code'], message:string):ApiError => ({ ok:false, code, message });
</file>

<file path="pages/api/casts/[id].ts">
import type { NextApiRequest, NextApiResponse } from 'next';
import { supabaseAdmin as supabase } from '@/lib/db';
import { z } from 'zod';

type ApiError = {
  ok: false;
  code: 'VALIDATION_ERROR' | 'DB_ERROR' | 'INTERNAL_ERROR';
  message: string;
};
const bad = (code: ApiError['code'], message: string, status = 400) => ({
  status,
  body: { ok: false, code, message } as ApiError,
});

// éƒ¨åˆ†æ›´æ–°ç”¨ã‚¹ã‚­ãƒ¼ãƒï¼ˆå…¨éƒ¨ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
const CastPatch = z
  .object({
    store_id: z.string().uuid().optional(),
    name: z.string().min(1).optional(),
    nickname: z.string().optional(),
    wage: z.number().int().min(0).nullable().optional(),
    rating: z.number().min(0).max(5).nullable().optional(),
    genre: z.array(z.string()).nullable().optional(),
    drinkable: z.boolean().nullable().optional(),
    owner: z.string().nullable().optional(),
    active: z.boolean().optional(),
    // ã»ã‹å°†æ¥ã‚«ãƒ©ãƒ ãŒæ¥ã¦ã‚‚è½ã¡ãªã„ã‚ˆã†ã« strict
  })
  .strict()
  .refine((obj) => Object.keys(obj).length > 0, {
    message: 'empty body',
  });

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (!supabase) {
    const e = bad('INTERNAL_ERROR', 'Service role is not configured', 500);
    return res.status(e.status).json(e.body);
  }
  if (req.method !== 'PATCH') {
    const e = bad('VALIDATION_ERROR', 'Method Not Allowed', 405);
    return res.status(e.status).json(e.body);
  }

  const { id } = req.query as { id?: string };
  if (!id) {
    const e = bad('VALIDATION_ERROR', 'id is required', 400);
    return res.status(e.status).json(e.body);
  }

  // å…¥åŠ›ãƒãƒªãƒ‡
  const parsed = CastPatch.safeParse(req.body);
  if (!parsed.success) {
    const e = bad('VALIDATION_ERROR', JSON.stringify(parsed.error.issues, null, 2), 400);
    return res.status(e.status).json(e.body);
  }
  const patch = parsed.data;

  // å¯¾è±¡å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆ404ï¼‰
  const { data: existing, error: exErr } = await supabase
    .from('casts')
    .select('id, store_id, name')
    .eq('id', id)
    .maybeSingle();
  if (exErr) {
    const e = bad('DB_ERROR', exErr.message, 500);
    return res.status(e.status).json(e.body);
  }
  if (!existing) {
    const e = bad('VALIDATION_ERROR', 'cast not found', 404);
    return res.status(e.status).json(e.body);
  }

  // store_id ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ stores ã®å­˜åœ¨ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆ404ï¼‰
  if (patch.store_id) {
    const { data: st, error: stErr } = await supabase
      .from('stores')
      .select('id')
      .eq('id', patch.store_id)
      .maybeSingle();
    if (stErr) {
      const e = bad('DB_ERROR', stErr.message, 500);
      return res.status(e.status).json(e.body);
    }
    if (!st) {
      const e = bad('VALIDATION_ERROR', 'store not found', 404);
      return res.status(e.status).json(e.body);
    }
  }

  // æ›´æ–°ï¼ˆUNIQUE (store_id, name) è¡çªã¯ 409ï¼‰
  const { data, error } = await supabase
    .from('casts')
    .update(patch)
    .eq('id', id)
    .select('*')
    .single();

  if (error) {
    if ((error as any).code === '23505') {
      return res
        .status(409)
        .json({ ok: false, code: 'DB_ERROR', message: 'duplicate cast (store_id,name)' });
    }
    const e = bad('DB_ERROR', error.message, 500);
    return res.status(e.status).json(e.body);
  }

  return res.status(200).json({ ok: true, item: data });
}
</file>

<file path="pages/api/questionnaire/[kind]/load.ts">
// pages/api/questionnaire/[kind]/load.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { createClient } from '@supabase/supabase-js';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'GET') return res.status(405).json({ ok: false, error: 'Method Not Allowed' });

  const { kind } = req.query; // 'schema' | 'answers'
  if (kind !== 'schema' && kind !== 'answers') return res.status(400).json({ ok: false, error: 'invalid kind' });

  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const key = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
  if (!url || !key) return res.status(400).json({ ok: false, error: 'Supabaseæœªè¨­å®š' });

  const supabase = createClient(url, key, { auth: { persistSession: false } });

  const { data, error } = await supabase
    .from('questionnaire_store')                      // Aæ¡ˆï¼šæ–°ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚Bæ¡ˆãªã‚‰ questionnaire_answers
    .select('*')
    .eq('page_key', 'questionnaire')
    .eq('kind', kind as string)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();

  if (error) return res.status(500).json({ ok: false, error: error.message });
  return res.status(200).json({ ok: true, data });
}
</file>

<file path="pages/api/questionnaire/[kind]/save.ts">
// pages/api/questionnaire/[kind]/save.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { createClient } from '@supabase/supabase-js';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') return res.status(405).json({ ok: false, error: 'Method Not Allowed' });

  const { kind } = req.query; // 'schema' | 'answers'
  if (kind !== 'schema' && kind !== 'answers') return res.status(400).json({ ok: false, error: 'invalid kind' });

  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const key = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
  if (!url || !key) return res.status(400).json({ ok: false, error: 'Supabaseæœªè¨­å®š' });

  const body = req.body || {};
  const supabase = createClient(url, key, { auth: { persistSession: false } });

  const { data, error } = await supabase
    .from('questionnaire_store')                      // Bæ¡ˆã‚’é¸ã¶ãªã‚‰ questionnaire_answers ã«å¤‰æ›´
    .insert({
      page_key: 'questionnaire',
      kind: kind as string,
      version: body.version ?? 'v1',
      author: body.author ?? null,
      data: body.data,                                // å›ç­” or ã‚¹ã‚­ãƒ¼ãƒã® JSON
    })
    .select()
    .single();

  if (error) return res.status(500).json({ ok: false, error: error.message });
  return res.status(200).json({ ok: true, data });
}
</file>

<file path="pages/api/shifts/[id].ts">
// /pages/api/shifts/[id].ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { supabaseAdmin as supabase } from '@/lib/db';

const STATUSES = new Set(['scheduled','confirmed','finished','canceled']);
const ROLES = new Set(['cast','manager','other']);

function parseDate(v?: string) {
  if (!v) return undefined;
  const t = Date.parse(v);
  return Number.isNaN(t) ? undefined : new Date(t).toISOString();
}

async function logAudit(action: string, payload: any, entity_id?: string) {
  try {
    await supabase!.from('audit_logs').insert({
      actor: 'api',
      action,
      entity: 'shift',
      entity_id: entity_id ?? null,
      payload,
    });
  } catch {}
}

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (!supabase) return res.status(500).json({ ok: false, error: 'Service role is not configured' });
  const { id } = req.query as { id: string };

  if (req.method !== 'PATCH') {
    return res.status(405).json({ ok: false, error: 'Method Not Allowed' });
  }

  const {
    status,         // optional
    starts_at,      // optional
    ends_at,        // optional
    store_id,       // optional
    memo,           // optional
    pay_rate,       // optional
    role,           // optional
  } = (req.body ?? {}) as Record<string, any>;

  // å­˜åœ¨ç¢ºèª
  const { data: ex, error: exErr } = await supabase.from('shifts').select('id').eq('id', id).maybeSingle();
  if (exErr) return res.status(500).json({ ok: false, error: exErr.message });
  if (!ex) return res.status(404).json({ ok: false, error: 'shift not found' });

  // æœ€å°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const patch: any = {};
  if (status !== undefined) {
    if (!STATUSES.has(status)) return res.status(400).json({ ok: false, error: 'invalid status' });
    patch.status = status;
    patch.canceled_at = status === 'canceled' ? new Date().toISOString() : null;
  }
  if (role !== undefined) {
    if (!ROLES.has(role)) return res.status(400).json({ ok: false, error: 'invalid role' });
    patch.role = role;
  }
  if (starts_at !== undefined) {
    const s = parseDate(starts_at);
    if (!s) return res.status(400).json({ ok: false, error: 'starts_at must be ISO date' });
    patch.starts_at = s;
  }
  if (ends_at !== undefined) {
    const e = parseDate(ends_at);
    if (ends_at && !e) return res.status(400).json({ ok: false, error: 'ends_at must be ISO date' });
    patch.ends_at = e ?? null;
  }
  if (store_id !== undefined) patch.store_id = store_id ?? null;
  if (memo !== undefined) patch.memo = memo ?? null;
  if (pay_rate !== undefined) patch.pay_rate = pay_rate ?? null;

  try {
    const { data, error } = await supabase.from('shifts').update(patch).eq('id', id).select('*').single();
    if (error) return res.status(500).json({ ok: false, error: error.message });

    await logAudit('patch_shift', { id, body: req.body }, id);
    return res.status(200).json({ ok: true, item: data });
  } catch (e: any) {
    await logAudit('error_shift_patch', { id, error: String(e), body: req.body }, id);
    return res.status(500).json({ ok: false, error: e?.message ?? 'unknown error' });
  }
}
</file>

<file path="pages/api/health.ts">
// pages/api/health.ts
import type { NextApiRequest, NextApiResponse } from 'next';

export default function handler(_req: NextApiRequest, res: NextApiResponse) {
  res.status(200).json({ ok: true, time: new Date().toISOString() });
}
</file>

<file path="pages/api/tasks.ts">
// pages/api/tasks.ts
import type { NextApiRequest, NextApiResponse } from "next";
import { supabaseAdmin } from "../../lib/supabaseServer";

type Task = {
  title: string;
  start?: string;   // YYYY-MM-DD
  end?: string;
  started?: boolean;
  done?: boolean;
  progress?: number;
  row_index?: number; // è¡¨ç¤ºé †å›ºå®šç”¨
};

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    if (req.method === "GET") {
      // ä¸¦ã³é †ã¯ row_index â†’ start â†’ title ã®å„ªå…ˆé †ä½ã§å›ºå®š
      const { data, error } = await supabaseAdmin
        .from("tasks")
        .select("*")
        .order("row_index", { ascending: true, nullsFirst: false })
        .order("start", { ascending: true, nullsFirst: false })
        .order("title", { ascending: true });

      if (error) throw error;

      const payload = (data || []).map((r: any) => ({
        title: r.title,
        start: r.start || "",
        end: r.end || "",
        started: !!r.started,
        done: !!r.done,
        progress: r.progress ?? 0,
        row_index: r.row_index ?? null,
      }));

      return res.status(200).json(payload);
    }

    if (req.method === "POST") {
      const body = typeof req.body === "string" ? JSON.parse(req.body) : req.body;
      const arrRaw: Task[] = Array.isArray(body) ? body : [];

      // è»½ã„æ­£è¦åŒ–ï¼ˆtitleã®trimã€ç©ºæ–‡å­—ã¯é™¤å¤–ï¼‰
      const arr: Task[] = arrRaw
        .map((t) => ({ ...t, title: (t.title ?? "").trim() }))
        .filter((t) => t.title.length > 0);

      // æ—¢å­˜ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§ã‚’å–å¾—ï¼ˆå®Œå…¨åŒæœŸã®ãŸã‚ï¼‰
      const { data: existing, error: exErr } = await supabaseAdmin.from("tasks").select("title");
      if (exErr) throw exErr;
      const existingTitles = new Set((existing || []).map((x: any) => x.title));

      // upsertï¼ˆrow_index æœªæŒ‡å®šã¯é…åˆ—é †ã§æ¡ç•ªï¼‰
      if (arr.length) {
        const upsertPayload = arr.map((t, i) => ({
          title: t.title,
          start: t.start || null,
          end: t.end || null,
          started: !!t.started,
          done: !!t.done,
          progress: t.progress ?? 0,
          row_index: typeof t.row_index === "number" ? t.row_index : i + 1,
          updated_at: new Date().toISOString(),
        }));

        const { error: upsertError } = await supabaseAdmin
          .from("tasks")
          .upsert(upsertPayload, { onConflict: "title" }); // title ã« UNIQUE åˆ¶ç´„å‰æ

        if (upsertError) throw upsertError;
      }

      // é€ã‚‰ã‚Œã¦ã“ãªã‹ã£ãŸã‚¿ã‚¤ãƒˆãƒ«ã¯å‰Šé™¤ï¼ˆå®Œå…¨åŒæœŸï¼‰
      const incomingTitles = new Set(arr.map((t) => t.title));
      const toDelete = [...existingTitles].filter((t) => !incomingTitles.has(t));
      if (toDelete.length) {
        const { error: delErr } = await supabaseAdmin
          .from("tasks")
          .delete()
          .in("title", toDelete);
        if (delErr) throw delErr;
      }

      return res.status(200).json({ ok: true });
    }

    res.setHeader("Allow", "GET, POST");
    return res.status(405).end();
  } catch (e: any) {
    console.error(e);
    return res.status(500).json({ error: e.message || "Internal Server Error" });
  }
}
</file>

<file path="pages/docs/openapi.yaml">
openapi: 3.0.3
info:
  title: Tiara Portal API
  version: 0.1.0
servers:
  - url: http://localhost:3000
paths:
  /api/casts:
    get:
      summary: List casts
      parameters:
        - in: query; name: page; schema: { type: integer, minimum: 1, default: 1 }
        - in: query; name: limit; schema: { type: integer, minimum: 1, maximum: 100, default: 30 }
        - in: query; name: keyword; schema: { type: string }
        - in: query; name: owner; schema: { type: string }
        - in: query; name: genre; schema: { type: string }
        - in: query; name: drinkable; schema: { type: boolean }
        - in: query; name: wage_min; schema: { type: number }
        - in: query; name: sort; schema: { type: string }
      responses:
        "200": { description: OK }
        "400": { description: Validation error }
  /api/stores:
    get:
      summary: List stores
      parameters:
        - in: query; name: page; schema: { type: integer, default: 1 }
        - in: query; name: limit; schema: { type: integer, default: 30 }
        - in: query; name: keyword; schema: { type: string }
        - in: query; name: active; schema: { type: boolean }
        - in: query; name: sort; schema: { type: string }
      responses:
        "200": { description: OK }
        "400": { description: Validation error }
  /api/shifts:
    get:
      summary: List shifts
      parameters:
        - in: query; name: page; schema: { type: integer, default: 1 }
        - in: query; name: limit; schema: { type: integer, default: 30 }
        - in: query; name: sort; schema: { type: string }
        - in: query; name: store_id; schema: { type: string, format: uuid }
        - in: query; name: cast_id;  schema: { type: string, format: uuid }
        - in: query; name: status;   schema: { type: string, enum: [scheduled, confirmed, canceled, finished] }
        - in: query; name: role;     schema: { type: string, enum: [cast] }
        - in: query; name: from;     schema: { type: string, format: date-time }
        - in: query; name: to;       schema: { type: string, format: date-time }
        - in: query; name: expand;   schema: { type: string, enum: [names] }
      responses:
        "200": { description: OK }
        "400": { description: Validation error }
</file>

<file path="pages/_app.tsx">
import type { AppProps } from "next/app";
import "../styles/globals.css";

export default function App({ Component, pageProps }: AppProps) {
  return <Component {...pageProps} />;
}
</file>

<file path="pages/casts.tsx">
// pages/casts.tsx
import { useEffect, useState } from 'react';

type Cast = {
  id: string;
  name: string;
  nickname?: string;
  wage?: number;
  rating?: number;
  genre?: string[];
  drinkable?: boolean;
  owner?: string;
  active?: boolean;
};

export default function CastsPage() {
  const [list, setList] = useState<Cast[]>([]);
  const [keyword, setKeyword] = useState('');

  useEffect(() => {
    const controller = new AbortController();
    const url = `/api/casts?limit=50${keyword ? `&keyword=${encodeURIComponent(keyword)}` : ''}`;
    fetch(url, { signal: controller.signal })
      .then((r) => r.json())
      .then((j) => setList(j.data ?? []))
      .catch(() => {});
    return () => controller.abort();
  }, [keyword]);

  return (
    <main style={{ fontFamily: 'system-ui, sans-serif', padding: 16 }}>
      <h1>ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§</h1>
      <input
        placeholder="åå‰ã§æ¤œç´¢"
        value={keyword}
        onChange={(e) => setKeyword(e.target.value)}
        style={{ padding: 8, margin: '12px 0', width: 280 }}
      />
      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
        <thead>
          <tr>
            <th align="left">åå‰</th>
            <th align="left">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
            <th align="right">æ™‚çµ¦</th>
            <th align="right">è©•ä¾¡</th>
            <th align="left">ã‚¿ã‚°</th>
            <th align="center">é£²ã‚ã‚‹</th>
          </tr>
        </thead>
        <tbody>
          {list.map((c) => (
            <tr key={c.id}>
              <td>{c.name}</td>
              <td>{c.nickname ?? '-'}</td>
              <td align="right">{c.wage ?? '-'}</td>
              <td align="right">{c.rating ?? '-'}</td>
              <td>{(c.genre ?? []).join(', ')}</td>
              <td align="center">{c.drinkable ? 'â—¯' : 'âˆ’'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </main>
  );
}
</file>

<file path="styles/globals.css">
body {
    margin: 0;
    padding: 0;
    background: #f9fafb;
    color: #111827;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  
  h1 {
    font-size: 1.8rem;
    margin-bottom: 1rem;
    color: #1e3a8a;
  }
  
  h2 {
    margin-top: 1.5rem;
    color: #2563eb;
  }
  
  a {
    color: #2563eb;
    text-decoration: none;
  }
  
  a:hover {
    text-decoration: underline;
  }
</file>

<file path="supabase/.temp/cli-latest">
v2.40.7
</file>

<file path="supabase/.temp/gotrue-version">
v2.179.0
</file>

<file path="supabase/.temp/postgres-version">
17.6.1.005
</file>

<file path="supabase/.temp/project-ref">
kemrpytjgikyxpgtmkdm
</file>

<file path="supabase/.temp/rest-version">
v13.0.5
</file>

<file path="supabase/.temp/storage-version">
custom-metadata
</file>

<file path="supabase/migrations/0001_init.sql">
-- supabase/migrations/0001_init.sql
-- Tiara Portal / å‹¤æ€ åŸºç›¤ åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
-- å¯¾è±¡: stores / casts / shifts / audit_logs
-- æ—¢å­˜: tasks, questionnaire_answers ã¯å¤‰æ›´ã—ãªã„

-- ===== Extensions =====
create extension if not exists "pgcrypto";     -- gen_random_uuid()
create extension if not exists "uuid-ossp";    -- uuid_generate_v4()

-- ===== Common: updated_at è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ =====
create or replace function set_updated_at()
returns trigger
language plpgsql
as $$
begin
  new.updated_at := now();
  return new;
end;
$$;

-- =========================================================
-- storesï¼ˆåº—èˆ—ï¼‰
-- =========================================================
create table if not exists public.stores (
  id          uuid primary key default gen_random_uuid(),
  name        text not null,
  address     text,
  phone       text,
  created_at  timestamptz not null default now(),
  updated_at  timestamptz not null default now()
);

comment on table  public.stores is 'å‡ºåº—ï¼ˆæ‹ ç‚¹ï¼‰æƒ…å ±';
comment on column public.stores.name    is 'åº—èˆ—å';
comment on column public.stores.address is 'ä½æ‰€';
comment on column public.stores.phone   is 'é›»è©±ç•ªå·';

create index if not exists idx_stores_name on public.stores using btree (name);

drop trigger if exists trg_stores_updated_at on public.stores;
create trigger trg_stores_updated_at
before update on public.stores
for each row execute function set_updated_at();

-- =========================================================
-- castsï¼ˆã‚­ãƒ£ã‚¹ãƒˆï¼‰
-- =========================================================
create table if not exists public.casts (
  id          uuid primary key default gen_random_uuid(),
  store_id    uuid references public.stores(id) on delete set null,
  name        text not null,
  nickname    text,
  rating      numeric(3,2) default 0 check (rating between 0 and 5),
  wage        integer,                -- æ™‚çµ¦(å††)
  genre       text[],                 -- ã‚¿ã‚°é…åˆ—ï¼ˆä¾‹: {'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼','æ–°äºº'}ï¼‰
  drinkable   boolean default false,  -- åŒä¼´/é£²é…’å¯å¦ã®ãƒ“ãƒƒãƒˆã¨ã—ã¦æµç”¨å¯
  owner       text,                   -- æ‰€å±/ã‚ªãƒ¼ãƒŠãƒ¼åç­‰
  active      boolean default true,
  created_at  timestamptz not null default now(),
  updated_at  timestamptz not null default now()
);

comment on table  public.casts is 'ã‚­ãƒ£ã‚¹ãƒˆã®åŸºæœ¬æƒ…å ±';
comment on column public.casts.rating is '0.00ã€œ5.00';

create index if not exists idx_casts_store   on public.casts using btree (store_id);
create index if not exists idx_casts_active  on public.casts using btree (active);
create index if not exists idx_casts_name    on public.casts using btree (name);

drop trigger if exists trg_casts_updated_at on public.casts;
create trigger trg_casts_updated_at
before update on public.casts
for each row execute function set_updated_at();

-- =========================================================
-- shiftsï¼ˆã‚·ãƒ•ãƒˆï¼‰
-- =========================================================
create table if not exists public.shifts (
  id          uuid primary key default gen_random_uuid(),
  cast_id     uuid not null references public.casts(id) on delete cascade,
  store_id    uuid references public.stores(id) on delete set null,
  starts_at   timestamptz not null,
  ends_at     timestamptz not null,
  status      text not null default 'scheduled' check (status in ('scheduled','confirmed','absent')),
  memo        text,
  created_at  timestamptz not null default now(),
  updated_at  timestamptz not null default now(),
  constraint chk_time_window check (ends_at > starts_at)
);

comment on table  public.shifts is 'ã‚­ãƒ£ã‚¹ãƒˆã®å‡ºå‹¤äºˆå®š/å®Ÿç¸¾';
comment on column public.shifts.status is 'scheduled/confirmed/absent';

-- æ¤œç´¢ç”¨: ã‚­ãƒ£ã‚¹ãƒˆÃ—é–‹å§‹æ™‚åˆ»ã€åº—èˆ—Ã—é–‹å§‹æ™‚åˆ»
create index if not exists idx_shifts_cast_time  on public.shifts using btree (cast_id, starts_at desc);
create index if not exists idx_shifts_store_time on public.shifts using btree (store_id, starts_at desc);

drop trigger if exists trg_shifts_updated_at on public.shifts;
create trigger trg_shifts_updated_at
before update on public.shifts
for each row execute function set_updated_at();

-- =========================================================
-- audit_logsï¼ˆç›£æŸ»ãƒ­ã‚°ï¼‰
-- =========================================================
create table if not exists public.audit_logs (
  id          uuid primary key default gen_random_uuid(),
  actor       text not null,            -- user id / system
  action      text not null,            -- created/updated/deleted/webhook_received ãªã©
  entity      text not null,            -- casts/shifts/stores/... è‡ªç”±è¨˜è¿°
  entity_id   uuid,
  payload     jsonb,
  created_at  timestamptz not null default now()
);

create index if not exists idx_audit_created on public.audit_logs using btree (created_at desc);
create index if not exists idx_audit_entity  on public.audit_logs using btree (entity, created_at desc);

-- =========================================================
-- RLS / RBACï¼ˆæœ€å°ã‚»ãƒƒãƒˆï¼‰
-- å½¹å‰²: admin / cast / store_viewer
-- æ–¹é‡:
--   ãƒ»stores, casts, shifts ã¯ ä¸€æ—¦ read ã‚’ç·©ã‚ï¼ˆå…¨ä»¶é–²è¦§å¯ï¼‰â†’ å¾Œç¶šPRã§ store_id / æ‰€å± ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿å°å…¥
--   ãƒ»write ã¯ admin ã®ã¿ï¼ˆJWT ã‚¯ãƒ¬ãƒ¼ãƒ : role=adminï¼‰
--   ãƒ»audit_logs ã¯ admin ã®ã¿é–²è¦§ã€insert ã¯ adminï¼ˆâ€»Service Roleã¯RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼‰
-- =========================================================

alter table public.stores     enable row level security;
alter table public.casts      enable row level security;
alter table public.shifts     enable row level security;
alter table public.audit_logs enable row level security;

-- ===== SELECT: æš«å®šã§å…¨å…¬é–‹ï¼ˆå¾Œã§ tighten ã™ã‚‹ï¼‰=====
drop policy if exists "public read stores" on public.stores;
create policy "public read stores"
  on public.stores for select
  using (true);

drop policy if exists "public read casts" on public.casts;
create policy "public read casts"
  on public.casts for select
  using (true);

drop policy if exists "public read shifts" on public.shifts;
create policy "public read shifts"
  on public.shifts for select
  using (true);

-- ===== WRITE: admin ã®ã¿ =====
-- stores
drop policy if exists "admin write stores" on public.stores;
create policy "admin write stores"
  on public.stores for all
  using (coalesce(auth.jwt() ->> 'role','') = 'admin')
  with check (coalesce(auth.jwt() ->> 'role','') = 'admin');

-- casts
drop policy if exists "admin write casts" on public.casts;
create policy "admin write casts"
  on public.casts for all
  using (coalesce(auth.jwt() ->> 'role','') = 'admin')
  with check (coalesce(auth.jwt() ->> 'role','') = 'admin');

-- shifts
drop policy if exists "admin write shifts" on public.shifts;
create policy "admin write shifts"
  on public.shifts for all
  using (coalesce(auth.jwt() ->> 'role','') = 'admin')
  with check (coalesce(auth.jwt() ->> 'role','') = 'admin');

-- ===== audit_logs: admin é–²è¦§ + admin è¿½è¨˜ã®ã¿ =====
drop policy if exists "admin read audit"  on public.audit_logs;
create policy "admin read audit"
  on public.audit_logs for select
  using (coalesce(auth.jwt() ->> 'role','') = 'admin');

drop policy if exists "admin insert audit" on public.audit_logs;
create policy "admin insert audit"
  on public.audit_logs for insert
  with check (coalesce(auth.jwt() ->> 'role','') = 'admin');

-- å‚è€ƒ: Service Role ã¯ RLS ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒå´ã‹ã‚‰ã®ç›£æŸ»æ›¸ãè¾¼ã¿ã¯ã“ã®ã¾ã¾ã§å¯
</file>

<file path="supabase/migrations/0002_unique_cast_name.sql">
-- ç›®çš„: casts ã® (store_id, name) ã‚’ä¸€æ„ã«ã—ã¦ã€åŒä¸€åº—èˆ—ã§ã®é‡è¤‡ç™»éŒ²ã‚’é˜²ã
-- æ³¨æ„: æ—¢å­˜é‡è¤‡ãŒã‚ã‚‹ã¨ä¸€æ„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã™ã€‚
--       äº‹å‰ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼†è§£æ¶ˆã—ã¦ã‹ã‚‰é©ç”¨ã—ã¦ãã ã•ã„ï¼ˆä¸‹ã«å‚è€ƒSQLã‚ã‚Šï¼‰ã€‚

-- ========= å‚è€ƒ: é‡è¤‡ç¢ºèª (æ‰‹å‹•å®Ÿè¡Œç”¨) =========
-- select store_id, name, count(*) as cnt
-- from public.casts
-- group by store_id, name
-- having count(*) > 1
-- order by cnt desc;

-- ========= ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã®è¿½åŠ æ‰‹é † =========
-- 1) ã¾ãšä¸€æ„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼ˆå­˜åœ¨ã™ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
create unique index if not exists uq_casts_store_name_idx
  on public.casts (store_id, name);

-- 2) ãã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æµç”¨ã—ã¦ã€Œè¡¨ãƒ¬ãƒ™ãƒ«ã®åˆ¶ç´„ã€ã‚’ä»˜ä¸ï¼ˆé‡è¤‡åã§ã®å†å®Ÿè¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã‚¬ãƒ¼ãƒ‰ï¼‰
do $$
begin
  if not exists (
    select 1
    from pg_constraint
    where conname = 'uq_casts_store_name'
      and conrelid = 'public.casts'::regclass
  ) then
    alter table public.casts
      add constraint uq_casts_store_name
      unique using index uq_casts_store_name_idx;
  end if;
end$$;

-- ========= è£œè¶³ =========
-- ãƒ»store_id ãŒ NULL ã®è¡Œã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¤å®šã®å¯¾è±¡å¤–ï¼ˆNULLâ‰ NULLï¼‰ã§ã™ã€‚
--   NULLã‚‚å«ã‚ã¦å³å¯†ã«ä¸€æ„ã«ã—ãŸã„å ´åˆã¯ã€store_id ã‚’ NOT NULL ã«ã™ã‚‹é‹ç”¨ã«æƒãˆã¦ãã ã•ã„ã€‚
-- ãƒ»å¤§æ–‡å­—å°æ–‡å­—/è¡¨è¨˜ã‚†ã‚Œã‚’å¸åã—ãŸã„å ´åˆã¯ã€ä¿å­˜å‰ã« lower(name) ã§æ­£è¦åŒ–ã™ã‚‹ç­‰ã®ã‚¢ãƒ—ãƒªå´çµ±ä¸€ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
</file>

<file path="supabase/migrations/0003_mvp_plus_columns.sql">
-- ============================================
-- 0003: MVP+ columns (stores / casts / shifts)
-- ============================================

-- stores -------------------------------------------------
alter table public.stores
  add column if not exists code text,                                   -- å†…éƒ¨ç”¨ã‚³ãƒ¼ãƒ‰ï¼ˆåº—èˆ—ã‚³ãƒ¼ãƒ‰ï¼‰
  add column if not exists active boolean not null default true,        -- ç¨¼åƒãƒ•ãƒ©ã‚°
  add column if not exists notes text;                                   -- å‚™è€ƒ

-- ã‚³ãƒ¼ãƒ‰ã‚„åå‰ã§ã®æ¤œç´¢ç”¨
create index if not exists idx_stores_code on public.stores (code);
create index if not exists idx_stores_lower_name on public.stores (lower(name));

-- ä»»æ„ï¼šåº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ„ã«ã—ãŸã„å ´åˆï¼ˆnullé‡è¤‡ã¯è¨±å®¹ï¼‰
create unique index if not exists uq_stores_code on public.stores (code);

-- casts --------------------------------------------------
alter table public.casts
  add column if not exists code text,                                   -- ç¤¾å†…ç®¡ç†ã‚³ãƒ¼ãƒ‰
  add column if not exists phone text,
  add column if not exists email text,
  add column if not exists status text not null default 'active'        -- 'active' | 'inactive' | 'retired' æƒ³å®š
    check (status in ('active','inactive','retired')),
  add column if not exists deleted_at timestamptz,                      -- ã‚½ãƒ•ãƒˆå‰Šé™¤
  add column if not exists profile_note text,                           -- ç´¹ä»‹æ–‡/ãƒ¡ãƒ¢
  add column if not exists tags text[] default '{}'::text[];            -- ä»»æ„ã‚¿ã‚°

-- ã‚ˆãä½¿ã†æ¤œç´¢ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
create index if not exists idx_casts_store on public.casts (store_id);
create index if not exists idx_casts_status on public.casts (status);
create index if not exists idx_casts_lower_name on public.casts (lower(name));

-- shifts -------------------------------------------------
alter table public.shifts
  add column if not exists role text not null default 'cast'            -- 'cast' | 'staff' ç­‰
    check (role in ('cast','staff')),
  add column if not exists pay_rate int,                                -- å½“æ™‚ç‚¹ã®æ™‚çµ¦ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
  add column if not exists memo text,
  add column if not exists canceled_at timestamptz;

-- æ—¢å­˜: uq_shifts_cast_start (cast_id, starts_at) ã¯ 0002c ã§ä½œæˆæ¸ˆã¿æƒ³å®š
create index if not exists idx_shifts_store_start on public.shifts (store_id, starts_at);
</file>

<file path="supabase/migrations/0004_rls_minimal.sql">
-- ==================================================
-- 0004: RLS/RBAC minimum
-- - app_users ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ­ãƒ¼ãƒ«ã‚’ä¿æŒ
-- - èªè¨¼æ¸ˆã¿ã¯èª­ã¿å–ã‚Šå¯ã€æ›¸ãè¾¼ã¿ã¯ admin ã®ã¿
-- ==================================================

-- ãƒ­ãƒ¼ãƒ«ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆauth.users ã¨ç´ä»˜ã‘ï¼‰
create table if not exists public.app_users (
  user_id uuid primary key references auth.users(id) on delete cascade,
  role text not null check (role in ('admin','cast','store_viewer')),
  cast_id uuid references public.casts(id),    -- å°†æ¥: cast ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®æœ¬äººç´ä»˜ã‘ã«åˆ©ç”¨
  store_id uuid references public.stores(id),  -- å°†æ¥: åº—èˆ—ãƒ“ãƒ¥ãƒ¼ã‚¢ã®ç¯„å›²åˆ¶é™ã«åˆ©ç”¨
  created_at timestamptz not null default now()
);

create index if not exists idx_app_users_role on public.app_users(role);

-- RLS ã‚’æœ‰åŠ¹åŒ–
alter table public.stores enable row level security;
alter table public.casts  enable row level security;
alter table public.shifts enable row level security;
-- ï¼ˆç›£æŸ»ãƒ­ã‚°ãŒã‚ã‚Œã°ï¼‰alter table public.audit_logs enable row level security;

-- ä¾¿åˆ©: admin åˆ¤å®šï¼ˆå°†æ¥ãƒãƒªã‚·ãƒ¼ã§ä½¿ã„å›ã—ï¼‰
create or replace function public.is_admin()
returns boolean language sql stable as $$
  select exists (
    select 1 from public.app_users au
    where au.user_id = auth.uid() and au.role = 'admin'
  );
$$;

-- ========== SELECTï¼ˆé–²è¦§ï¼‰ ==========
-- èªè¨¼æ¸ˆã¿ãªã‚‰é–²è¦§å¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦ cast/store_viewer ã®ã¿ã«çµã£ã¦ã‚‚OKï¼‰
drop policy if exists sel_stores_all on public.stores;
create policy sel_stores_all on public.stores
  for select using (auth.uid() is not null);

drop policy if exists sel_casts_all on public.casts;
create policy sel_casts_all on public.casts
  for select using (auth.uid() is not null);

drop policy if exists sel_shifts_all on public.shifts;
create policy sel_shifts_all on public.shifts
  for select using (auth.uid() is not null);

-- ========== INSERT/UPDATE/DELETEï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ ==========
drop policy if exists mut_stores_admin on public.stores;
create policy mut_stores_admin on public.stores
  for all
  to authenticated
  using (public.is_admin())
  with check (public.is_admin());

drop policy if exists mut_casts_admin on public.casts;
create policy mut_casts_admin on public.casts
  for all
  to authenticated
  using (public.is_admin())
  with check (public.is_admin());

drop policy if exists mut_shifts_admin on public.shifts;
create policy mut_shifts_admin on public.shifts
  for all
  to authenticated
  using (public.is_admin())
  with check (public.is_admin());

-- å‚è€ƒ: ç›£æŸ»ãƒ­ã‚°ã¯ admin ã®ã¿é–²è¦§ãƒ»æ›¸è¾¼
-- drop policy if exists sel_audit_admin on public.audit_logs;
-- create policy sel_audit_admin on public.audit_logs
--   for select using (public.is_admin());
-- drop policy if exists ins_audit_admin on public.audit_logs;
-- create policy ins_audit_admin on public.audit_logs
--   for insert with check (public.is_admin());
</file>

<file path="supabase/migrations/0005_shift_search_indexes.sql">
-- caståˆ¥ã®æœŸé–“çµã‚Šè¾¼ã¿
create index if not exists idx_shifts_cast_starts
  on public.shifts (cast_id, starts_at);

-- storeåˆ¥ã®æœŸé–“çµã‚Šè¾¼ã¿
create index if not exists idx_shifts_store_starts
  on public.shifts (store_id, starts_at);

-- starts_at å˜ä½“ã®ã‚½ãƒ¼ãƒˆæœ€é©åŒ–
create index if not exists idx_shifts_starts_at
  on public.shifts (starts_at);
</file>

<file path="supabase/migrations/0006_shifts_status_check_add_canceled.sql">
-- allow 'canceled' in shifts.status
ALTER TABLE public.shifts
  DROP CONSTRAINT IF EXISTS shifts_status_check;

ALTER TABLE public.shifts
  ADD CONSTRAINT shifts_status_check
  CHECK (status IN ('scheduled','confirmed','finished','canceled'));

-- æ—¢å®šå€¤ã‚‚å¿µã®ãŸã‚æ˜ç¤º
ALTER TABLE public.shifts
  ALTER COLUMN status SET DEFAULT 'scheduled';
</file>

<file path="supabase/migrations/20250921051301_unique_shift_cast_start.sql">
create unique index if not exists uq_shifts_cast_start
  on public.shifts (cast_id, starts_at);
do $$
begin
  if not exists (
    select 1 from pg_constraint
    where conname = 'uq_shifts_cast_start'
      and conrelid = 'public.shifts'::regclass
  ) then
    alter table public.shifts
      add constraint uq_shifts_cast_start
      unique using index uq_shifts_cast_start;
  end if;
end$$;
</file>

<file path="supabase/migrations/20250921051302_unique_store_name.sql">
create unique index if not exists uq_stores_name_idx on public.stores (name);
do $$
begin
  if not exists (
    select 1 from pg_constraint
    where conname = 'uq_stores_name'
      and conrelid = 'public.stores'::regclass
  ) then
    alter table public.stores
      add constraint uq_stores_name
      unique using index uq_stores_name_idx;
  end if;
end$$;
</file>

<file path="supabase/migrations/20250921055945_audit_logs.sql">
-- 0005: audit_logs
create extension if not exists pgcrypto;

create table if not exists public.audit_logs (
  id          uuid primary key default gen_random_uuid(),
  created_at  timestamptz not null default now(),
  actor       text not null,                            -- 'system/line' ãªã©
  action      text not null check (
                action in ('created','updated','deleted','webhook_received','login','other')
              ),
  entity      text not null,                            -- 'casts' / 'stores' / 'line' ãªã©
  entity_id   text,
  payload     jsonb,
  ip          text,
  user_agent  text
);

create index if not exists idx_audit_created_at on public.audit_logs (created_at desc);
create index if not exists idx_audit_entity on public.audit_logs (entity, entity_id);
create index if not exists idx_audit_action on public.audit_logs (action);

-- RLS: admin ã®ã¿é–²è¦§/æ›¸è¾¼ï¼ˆService Role ã¯å¸¸ã«ãƒã‚¤ãƒ‘ã‚¹ï¼‰
alter table public.audit_logs enable row level security;

drop policy if exists sel_audit_admin on public.audit_logs;
create policy sel_audit_admin
  on public.audit_logs for select
  to authenticated using (public.is_admin());

drop policy if exists mut_audit_admin on public.audit_logs;
create policy mut_audit_admin
  on public.audit_logs for all
  to authenticated using (public.is_admin())
  with check (public.is_admin());
</file>

<file path="supabase/migrations/20250921090304_rls_strict_all_deny.sql">
-- RLS å…¨æœ‰åŠ¹åŒ– + æ—¢å­˜ãƒãƒªã‚·ãƒ¼æ’¤å»ï¼ˆService Role ã§ã®ã¿æ“ä½œã™ã‚‹é‹ç”¨ï¼‰
-- ä½•åº¦æµã—ã¦ã‚‚å®‰å…¨ãªã‚ˆã†ã« IF EXISTS / IF NOT EXISTS ã‚’å¤šç”¨

-- 1) æ—¢å­˜ãƒãƒªã‚·ãƒ¼å‰Šé™¤ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
drop policy if exists sel_stores_all  on public.stores;
drop policy if exists sel_casts_all   on public.casts;
drop policy if exists sel_shifts_all  on public.shifts;
drop policy if exists mut_stores_admin on public.stores;
drop policy if exists mut_casts_admin  on public.casts;
drop policy if exists mut_shifts_admin on public.shifts;

-- 2) RLSæœ‰åŠ¹åŒ–ï¼ˆã™ã§ã«ONãªã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
alter table public.stores enable row level security;
alter table public.casts  enable row level security;
alter table public.shifts enable row level security;

-- 3) â€œæ˜ç¤ºãƒãƒªã‚·ãƒ¼ãªã—â€ = å…¨Deny
-- ï¼ˆService Role ã¯ RLS ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ API ã¯å‹•ä½œã—ã¾ã™ï¼‰

-- 4) å‚è€ƒï¼šå°†æ¥ã®åº—èˆ—ã‚¹ã‚³ãƒ¼ãƒ—é–²è¦§ãƒãƒªã‚·ãƒ¼é››å½¢ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã®ã¾ã¾ã‚³ãƒŸãƒƒãƒˆï¼‰
-- create policy sel_stores_by_owner on public.stores
--   for select to authenticated
--   using (owner = auth.uid()::text);
</file>

<file path="supabase/migrations/20250921091553_rls_strict_all_deny.sql">
-- æ—¢å­˜ãƒãƒªã‚·ãƒ¼æ’¤å»
drop policy if exists sel_stores_all  on public.stores;
drop policy if exists sel_casts_all   on public.casts;
drop policy if exists sel_shifts_all  on public.shifts;
drop policy if exists mut_stores_admin on public.stores;
drop policy if exists mut_casts_admin  on public.casts;
drop policy if exists mut_shifts_admin on public.shifts;

-- RLSæœ‰åŠ¹åŒ–ï¼ˆ=æ˜ç¤ºãƒãƒªã‚·ãƒ¼ãªã—â†’å…¨Denyã€‚Service Roleã®ã¿å¯ï¼‰
alter table public.stores enable row level security;
alter table public.casts  enable row level security;
alter table public.shifts enable row level security;
</file>

<file path="next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
/// <reference path="./.next/types/routes.d.ts" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information.
</file>

<file path="README.md">
# Tiara System Portal (å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ )

ä¸­æ´²äººææ´¾é£ã€Œãƒ†ã‚£ã‚¢ãƒ©ãƒãƒƒãƒˆã€å‘ã‘ã®å‹¤æ€ ãƒ»é…è»Šãƒ»é€£çµ¡åŸºç›¤ã€‚  
PWAï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰ï¼‹ Web ç®¡ç†ã‚’æƒ³å®šã€‚**Backend MVPï¼ˆå®‰å…¨ãƒ»å†ç¾ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰**ã¾ã§æ•´å‚™æ¸ˆã¿ã€‚

---

## ğŸ“¦ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Next.js** (API Routes)
- **Supabase (Postgres)**ï¼šRLS / Migration / Studio
- **TypeScript**
- **ts-node**ï¼ˆseedï¼‰
- **zod**ï¼ˆAPIãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

---

## ğŸ” ç’°å¢ƒå¤‰æ•°

`.env.local`ï¼ˆ**ã‚³ãƒŸãƒƒãƒˆã—ãªã„**ï¼‰ã«ä»¥ä¸‹ã‚’è¨­å®šï¼š

```env
NEXT_PUBLIC_SUPABASE_URL=...           # Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL
NEXT_PUBLIC_SUPABASE_ANON_KEY=...      # anon ã‚­ãƒ¼ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆç”¨ï¼‰
SUPABASE_SERVICE_ROLE_KEY=...          # Service Role ã‚­ãƒ¼ï¼ˆAPI/seed ç”¨ãƒ»å³é‡ç®¡ç†ï¼‰
</file>

<file path="docs/openapi.yaml">
openapi: 3.0.3
info:
  title: Tiara System Portal API
  version: 0.1.0
  description: |
    å‹¤æ€ ç®¡ç†MVPå‘ã‘ã®ç¤¾å†…APIå®šç¾©ã€‚
    - RLSã¯DBå´ã§ **å…¨Deny**ã€æœ¬APIã¯ Service Role çµŒç”±ã®ã¿æƒ³å®šï¼ˆå¤–éƒ¨å…¬é–‹ãªã—ï¼‰ã€‚
    - ã™ã¹ã¦ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ `{ ok:true, ... }`ã€ã‚¨ãƒ©ãƒ¼ã¯ `{ ok:false, code, message }`ã€‚

servers:
  - url: http://localhost:3000
    description: Local Dev
  - url: https://{vercel_project}.vercel.app
    description: Vercel Preview/Prod
    variables:
      vercel_project:
        default: tiara-portal

tags:
  - name: Casts
  - name: Stores
  - name: Shifts
  - name: Webhooks

paths:
  /api/casts:
    get:
      tags: [Casts]
      summary: List casts
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - in: query
          name: keyword
          schema: { type: string }
          description: éƒ¨åˆ†ä¸€è‡´ï¼ˆnameï¼‰
        - in: query
          name: owner
          schema: { type: string }
        - in: query
          name: genre
          schema: { type: string }
          description: ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆå˜ä¸€å€¤ï¼‰ã€‚è¤‡æ•°ã¯å°†æ¥æ‹¡å¼µã€‚
        - in: query
          name: drinkable
          schema: { type: boolean }
        - in: query
          name: wage_min
          schema: { type: number }
        - in: query
          name: active
          schema: { type: boolean }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PaginatedCasts' }
        '400': { $ref: '#/components/responses/ValidationError' }
        '500': { $ref: '#/components/responses/DbError' }
    post:
      tags: [Casts]
      summary: Create cast
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CastCreate' }
      responses:
        '200':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  item: { $ref: '#/components/schemas/Cast' }
                required: [ok, item]
        '400': { $ref: '#/components/responses/ValidationError' }
        '404': { $ref: '#/components/responses/NotFound' }   # store_id ä¸æ­£
        '409': { $ref: '#/components/responses/Conflict' }   # (store_id,name) ä¸€æ„é•å
        '500': { $ref: '#/components/responses/DbError' }

  /api/casts/{id}:
    patch:
      tags: [Casts]
      summary: Update cast (partial)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CastUpdate' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  item: { $ref: '#/components/schemas/Cast' }
                required: [ok, item]
        '400': { $ref: '#/components/responses/ValidationError' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409': { $ref: '#/components/responses/Conflict' }
        '500': { $ref: '#/components/responses/DbError' }

  /api/stores:
    get:
      tags: [Stores]
      summary: List stores
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - in: query
          name: keyword
          schema: { type: string }
          description: éƒ¨åˆ†ä¸€è‡´ï¼ˆnameï¼‰
        - in: query
          name: active
          schema: { type: boolean }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PaginatedStores' }
        '400': { $ref: '#/components/responses/ValidationError' }
        '500': { $ref: '#/components/responses/DbError' }

  /api/shifts:
    get:
      tags: [Shifts]
      summary: List shifts
      description: |
        `expand=names` ã‚’ä»˜ã‘ã‚‹ã¨ `cast_name` / `store_name` ã‚’åŒæ¢±ã—ãŸãƒ•ãƒ©ãƒƒãƒˆæ§‹é€ ã§è¿”å´ã—ã¾ã™ã€‚
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - in: query
          name: store_id
          schema: { type: string, format: uuid }
        - in: query
          name: cast_id
          schema: { type: string, format: uuid }
        - in: query
          name: status
          schema:
            type: string
            enum: [scheduled, confirmed, canceled, finished]
        - in: query
          name: role
          schema:
            type: string
            enum: [cast]
        - $ref: '#/components/parameters/From'
        - $ref: '#/components/parameters/To'
        - in: query
          name: expand
          schema:
            type: string
            enum: [names]
          description: åå‰ã‚’åŒæ¢±ï¼ˆ`names`ï¼‰
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PaginatedShifts'
                  - $ref: '#/components/schemas/PaginatedShiftsExpanded'
        '400': { $ref: '#/components/responses/ValidationError' }
        '500': { $ref: '#/components/responses/DbError' }
    post:
      tags: [Shifts]
      summary: Create shift
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ShiftCreate' }
      responses:
        '200':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  item: { $ref: '#/components/schemas/Shift' }
                required: [ok, item]
        '400': { $ref: '#/components/responses/ValidationError' }
        '404': { $ref: '#/components/responses/NotFound' } # FKä¸æ•´åˆãªã©
        '500': { $ref: '#/components/responses/DbError' }

  /api/shifts/{id}:
    patch:
      tags: [Shifts]
      summary: Update shift (partial)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ShiftUpdate' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  item: { $ref: '#/components/schemas/Shift' }
                required: [ok, item]
        '400': { $ref: '#/components/responses/ValidationError' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/DbError' }

  /api/webhooks/line:
    post:
      tags: [Webhooks]
      summary: LINE Webhook stub (audit only)
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object, additionalProperties: true }
      responses:
        '200':
          description: OK (ç›£æŸ»ãƒ­ã‚°ã«ä¿å­˜)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  audit_id: { type: string, format: uuid }
                required: [ok]
        '500': { $ref: '#/components/responses/DbError' }

  /api/webhooks/chatwoot:
    post:
      tags: [Webhooks]
      summary: Chatwoot Webhook stub (audit only)
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object, additionalProperties: true }
      responses:
        '200':
          description: OK (ç›£æŸ»ãƒ­ã‚°ã«ä¿å­˜)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  audit_id: { type: string, format: uuid }
                required: [ok]
        '500': { $ref: '#/components/responses/DbError' }

components:
  parameters:
    Page:
      in: query
      name: page
      schema: { type: integer, minimum: 1, default: 1 }
    Limit:
      in: query
      name: limit
      schema: { type: integer, minimum: 1, maximum: 100, default: 30 }
    Sort:
      in: query
      name: sort
      schema: { type: string }
      description: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€‚`-` ã§é™é †ï¼ˆä¾‹ï¼š`rating,-wage,name`ï¼‰
    From:
      in: query
      name: from
      schema: { type: string, format: date-time }
      description: starts_at ã®ä¸‹é™ï¼ˆå«ã‚€ï¼‰
    To:
      in: query
      name: to
      schema: { type: string, format: date-time }
      description: starts_at ã®ä¸Šé™ï¼ˆæœªæº€ï¼‰

  responses:
    ValidationError:
      description: å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆzodï¼‰
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ApiError' }
          examples:
            example:
              value: { ok: false, code: VALIDATION_ERROR, message: "limit must be <= 100" }
    DbError:
      description: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ApiError' }
    NotFound:
      description: ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ApiError' }
          examples:
            example:
              value: { ok: false, code: DB_ERROR, message: "not found" }
    Conflict:
      description: ä¸€æ„åˆ¶ç´„é•åãªã©ç«¶åˆ
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ApiError' }
          examples:
            example:
              value: { ok: false, code: DB_ERROR, message: "duplicate key value violates unique constraint" }

  schemas:
    ApiError:
      type: object
      properties:
        ok: { type: boolean, example: false }
        code:
          type: string
          enum: [VALIDATION_ERROR, DB_ERROR, INTERNAL_ERROR]
        message: { type: string }
      required: [ok, code, message]

    PaginationMeta:
      type: object
      properties:
        ok: { type: boolean, example: true }
        page: { type: integer, minimum: 1 }
        limit: { type: integer, minimum: 1, maximum: 100 }
        total: { type: integer, minimum: 0 }
        hasNext: { type: boolean }
      required: [ok, page, limit, total, hasNext]

    Store:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        address: { type: string, nullable: true }
        phone: { type: string, nullable: true }
        code: { type: string, nullable: true }
        active: { type: boolean }
        notes: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [id, name, active, created_at, updated_at]

    Cast:
      type: object
      properties:
        id: { type: string, format: uuid }
        store_id: { type: string, format: uuid }
        name: { type: string }
        nickname: { type: string, nullable: true }
        rating: { type: number, nullable: true }
        wage: { type: number, nullable: true }
        genre:
          type: array
          items: { type: string }
          nullable: true
        drinkable: { type: boolean, nullable: true }
        owner: { type: string, nullable: true }
        active: { type: boolean }
        code: { type: string, nullable: true }
        phone: { type: string, nullable: true }
        email: { type: string, nullable: true }
        status: { type: string, nullable: true }
        profile_note: { type: string, nullable: true }
        tags:
          type: array
          items: { type: string }
          nullable: true
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        deleted_at: { type: string, format: date-time, nullable: true }
      required: [id, store_id, name, active, created_at, updated_at]

    # --- Casts requests ---
    CastCreate:
      type: object
      properties:
        store_id: { type: string, format: uuid }
        name: { type: string }
        nickname: { type: string }
        wage: { type: number }
        rating: { type: number }
        genre:
          type: array
          items: { type: string }
        drinkable: { type: boolean }
        owner: { type: string }
      required: [store_id, name]

    CastUpdate:
      type: object
      description: ã„ãšã‚Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä»»æ„ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰
      properties:
        store_id: { type: string, format: uuid }
        name: { type: string }
        nickname: { type: string, nullable: true }
        wage: { type: number, nullable: true }
        rating: { type: number, nullable: true }
        genre:
          type: array
          items: { type: string }
          nullable: true
        drinkable: { type: boolean, nullable: true }
        owner: { type: string, nullable: true }
        active: { type: boolean, nullable: true }
        code: { type: string, nullable: true }
        phone: { type: string, nullable: true }
        email: { type: string, nullable: true }
        status: { type: string, nullable: true }
        profile_note: { type: string, nullable: true }
        tags:
          type: array
          items: { type: string }
          nullable: true

    Shift:
      type: object
      properties:
        id: { type: string, format: uuid }
        cast_id: { type: string, format: uuid }
        store_id: { type: string, format: uuid, nullable: true }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }
        status:
          type: string
          enum: [scheduled, confirmed, canceled, finished]
        memo: { type: string, nullable: true }
        role:
          type: string
          enum: [cast]
        pay_rate: { type: number, nullable: true }
        canceled_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required:
        [id, cast_id, starts_at, ends_at, status, role, created_at, updated_at]

    # --- Shifts requests ---
    ShiftCreate:
      type: object
      properties:
        cast_id: { type: string, format: uuid }
        store_id: { type: string, format: uuid, nullable: true }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }
        status:
          type: string
          enum: [scheduled, confirmed, canceled, finished]
        role:
          type: string
          enum: [cast]
        pay_rate: { type: number }
        memo: { type: string }
      required: [cast_id, starts_at, ends_at, status, role]

    ShiftUpdate:
      type: object
      description: ã„ãšã‚Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ä»»æ„ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰
      properties:
        cast_id: { type: string, format: uuid }
        store_id: { type: string, format: uuid, nullable: true }
        starts_at: { type: string, format: date-time }
        ends_at: { type: string, format: date-time }
        status:
          type: string
          enum: [scheduled, confirmed, canceled, finished]
        role:
          type: string
          enum: [cast]
        pay_rate: { type: number, nullable: true }
        memo: { type: string, nullable: true }

    ShiftExpanded:
      allOf:
        - $ref: '#/components/schemas/Shift'
        - type: object
          properties:
            cast_name: { type: string, nullable: true }
            store_name: { type: string, nullable: true }

    PaginatedCasts:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            items:
              type: array
              items: { $ref: '#/components/schemas/Cast' }

    PaginatedStores:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            items:
              type: array
              items: { $ref: '#/components/schemas/Store' }

    PaginatedShifts:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            items:
              type: array
              items: { $ref: '#/components/schemas/Shift' }

    PaginatedShiftsExpanded:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            items:
              type: array
              items: { $ref: '#/components/schemas/ShiftExpanded' }
</file>

<file path="lib/audit.ts">
// lib/audit.ts
import { supabaseAdmin } from '@/lib/db';

export type AuditInput = {
  actor: string;
  action: 'created'|'updated'|'deleted'|'webhook_received'|'login'|'other';
  entity: string;
  entityId?: string;
  payload?: any;
  ip?: string | null;
  userAgent?: string | null;
};

export async function writeAudit(input: AuditInput) {
  if (!supabaseAdmin) {
    const err = new Error('[audit] supabaseAdmin is undefined (no service role?)');
    console.error(err.message);
    throw err;
  }
  const { data, error } = await supabaseAdmin
    .from('audit_logs')
    .insert({
      actor: input.actor,
      action: input.action,
      entity: input.entity,
      entity_id: input.entityId ?? null,
      payload: input.payload ?? null,
      ip: input.ip ?? null,
      user_agent: input.userAgent ?? null,
    })
    .select('id')
    .single();

  if (error) throw error;
  return data?.id ?? null;
}
</file>

<file path="pages/api/stores/index.ts">
import type { NextApiRequest, NextApiResponse } from 'next';
import { supabaseAdmin as supabase } from '@/lib/db';
import { z } from 'zod';

type ApiError = { ok: false; code: 'VALIDATION_ERROR' | 'DB_ERROR' | 'INTERNAL_ERROR'; message: string };
const bad = (code: ApiError['code'], message: string, status = 400) =>
  ({ status, body: { ok: false, code, message } as ApiError });

const SORTS = new Set(['name','created_at','updated_at','code']);

const querySchema = z.object({
  keyword: z.string().optional(),
  active:  z.coerce.boolean().optional(),
  page:  z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(30),
  sort:  z.string().optional(),    // ä¾‹: "name,-updated_at"
});

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'GET') {
    const e = bad('VALIDATION_ERROR', 'Method Not Allowed', 405);
    return res.status(e.status).json(e.body);
  }
  if (!supabase) {
    const e = bad('INTERNAL_ERROR', 'Service role is not configured', 500);
    return res.status(e.status).json(e.body);
  }

  const parsed = querySchema.safeParse(req.query);
  if (!parsed.success) {
    const e = bad('VALIDATION_ERROR', parsed.error.message, 400);
    return res.status(e.status).json(e.body);
  }
  const { keyword, active, page, limit, sort } = parsed.data;

  const rFrom = (page - 1) * limit;
  const rTo   = rFrom + limit - 1;

  // COUNT
  let cq = supabase.from('stores').select('*', { count: 'exact', head: true });
  if (keyword) cq = cq.ilike('name', `%${keyword}%`);
  if (active !== undefined) cq = cq.eq('active', active);

  const { count: total, error: cntErr } = await cq;
  if (cntErr) {
    const e = bad('DB_ERROR', cntErr.message, 500);
    return res.status(e.status).json(e.body);
  }
  if ((total ?? 0) === 0 || rFrom >= (total ?? 0)) {
    return res.status(200).json({ ok: true, items: [], page, limit, total: total ?? 0, hasNext: false });
  }

  // DATA
  let q = supabase.from('stores').select('*');
  if (keyword) q = q.ilike('name', `%${keyword}%`);
  if (active !== undefined) q = q.eq('active', active);

  if (sort) {
    const parts = sort.split(',').map(s => s.trim()).filter(Boolean);
    for (const p of parts) {
      const asc = !p.startsWith('-');
      const key = p.replace(/^[+-]/,'');
      if (SORTS.has(key)) q = q.order(key as any, { ascending: asc, nullsFirst: !asc });
    }
  } else {
    q = q.order('updated_at', { ascending: false }).order('name', { ascending: true });
  }

  q = q.range(rFrom, rTo);

  const { data, error } = await q;
  if (error) {
    const e = bad('DB_ERROR', error.message, 500);
    return res.status(e.status).json(e.body);
  }

  res.status(200).json({
    ok: true,
    items: data ?? [],
    page, limit,
    total: total ?? 0,
    hasNext: rTo + 1 < (total ?? 0),
  });
}
</file>

<file path="pages/api/webhooks/chatwoot.ts">
// pages/api/webhooks/chatwoot.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { writeAudit } from '@/lib/audit';

export const config = {
  api: { bodyParser: { sizeLimit: '1mb' } }, // å¿…è¦ãªã‚‰èª¿æ•´
};

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    const id = await writeAudit({
      actor: 'system/chatwoot',
      action: 'webhook_received',
      entity: 'chatwoot',
      payload: { headers: req.headers, body: req.body },
      ip: (req.headers['x-forwarded-for'] as string) ?? req.socket.remoteAddress ?? null,
      userAgent: req.headers['user-agent'] ?? null,
    });

    // ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ã‚ˆã† audit_id ã‚’è¿”ã™ï¼ˆé‹ç”¨ã§ä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰
    res.status(200).json({ ok: true, audit_id: id });
  } catch (e: any) {
    console.error('[webhooks/chatwoot] audit error:', e);
    res.status(500).json({ ok: false, error: String(e?.message ?? e) });
  }
}
</file>

<file path="pages/api/webhooks/line.ts">
// pages/api/webhooks/line.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { writeAudit } from '@/lib/audit';

export const config = { api: { bodyParser: { sizeLimit: '1mb' } } };

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    const id = await writeAudit({
      actor: 'system/line',
      action: 'webhook_received',
      entity: 'line',
      payload: { headers: req.headers, body: req.body },
      ip: (req.headers['x-forwarded-for'] as string) ?? req.socket.remoteAddress ?? null,
      userAgent: req.headers['user-agent'] ?? null,
    });
    res.status(200).json({ ok: true, audit_id: id });
  } catch (e: any) {
    console.error('[webhook/line] audit error:', e);
    res.status(500).json({ ok: false, error: String(e?.message ?? e) });
  }
}
</file>

<file path="pages/docs/coding-rules.tsx">
// pages/docs/coding-rules.tsx
// Next.js (Pages Router) â€” Coding Rules page for Tiara Portal
// Place at: pages/docs/coding-rules.tsx

import React from 'react';

const Page: React.FC = () => {
  return (
    <main className="min-h-screen bg-[#0b1020] text-[#e6e8ef]">
      <header className="max-w-4xl mx-auto px-4 py-10">
        <h1 className="text-3xl font-bold tracking-tight">Tiara Portal â€” Coding Rules</h1>
        <p className="mt-2 text-sm text-[#9aa3b2]">
          æœ€çµ‚æ›´æ–°ï¼š2025-09-22ï¼ˆv1.0ï¼‰ / Next.js + TypeScript + NestJS + Prisma + PostgreSQL
        </p>
      </header>

      <div className="max-w-4xl mx-auto px-4 pb-24 space-y-8">
        <Nav />

        <Section id="intro" title="0. å‰æ">
          <ul className="list-disc pl-6 space-y-2">
            <li>è¨€èªï¼š<b>TypeScript 5+</b>ï¼ˆ<code>strict</code>ã€<code>noImplicitAny</code> æœ‰åŠ¹ï¼‰</li>
            <li>APIï¼š<b>NestJS</b>ã€ORMï¼š<b>Prisma</b>ã€DBï¼š<b>PostgreSQL 16</b></li>
            <li>ãƒ•ãƒ­ãƒ³ãƒˆï¼š<b>Next.js</b>ï¼ˆCast PWA / Adminï¼‰</li>
            <li>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼š<b>Amazon S3</b>ï¼ˆprivateã€SSEã€æœ‰åŠ¹æœŸé™ä»˜ãç½²åURLï¼‰</li>
            <li>ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼š<b>30ä»¶å›ºå®š</b>ï¼ˆAPI/ãƒ•ãƒ­ãƒ³ãƒˆçµ±ä¸€ï¼‰</li>
            <li>æ™‚åˆ»ï¼šDBã¯<b>UTC</b>ã€è¡¨ç¤ºã¯ <b>Asia/Tokyo</b></li>
          </ul>
        </Section>

        <Section id="naming" title="1. å‘½åè¦å‰‡ / ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ">
          <ul className="list-disc pl-6 space-y-2">
            <li>å¤‰æ•°/é–¢æ•°ï¼š<b>camelCase</b>ã€ã‚¯ãƒ©ã‚¹/å‹/Enumï¼š<b>PascalCase</b>ã€å®šæ•°ï¼š<b>UPPER_SNAKE_CASE</b></li>
            <li>API ãƒ«ãƒ¼ãƒˆï¼š<b>kebab-case</b>ï¼ˆä¾‹ï¼š<code>/api/v1/cast-profiles</code>ï¼‰</li>
            <li>DBï¼šãƒ†ãƒ¼ãƒ–ãƒ«/ã‚«ãƒ©ãƒ ã¯ <b>snake_case</b>ï¼ˆPrisma ã® <code>@@map</code>/<code>@map</code> ã‚’åˆ©ç”¨ï¼‰</li>
          </ul>

          <h4 className="mt-4 font-semibold">NestJS ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä¾‹ï¼‰</h4>
          <Code
            lang="txt"
            code={`/api
  src/
    modules/
      auth/
        auth.controller.ts
        auth.service.ts
        auth.module.ts
        dto/
      casts/
      shops/
    common/
      guards/
      interceptors/
      filters/
      pipes/
      utils/
    prisma/
      prisma.module.ts
      prisma.service.ts
    main.ts`}
          />

          <h4 className="mt-4 font-semibold">Next.js ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä¾‹ï¼‰</h4>
          <Code
            lang="txt"
            code={`/web-admin
  app/
    (routes)/
    components/
    features/
    hooks/
    lib/
    styles/`}
          />
        </Section>

        <Section id="ts" title="2. TypeScript ã®æ›¸ãæ–¹">
          <ul className="list-disc pl-6 space-y-2">
            <li><code>// @ts-ignore</code> ã¯åŸå‰‡ç¦æ­¢ï¼ˆã‚„ã‚€ã‚’å¾—ãªã„å ´åˆã¯ç†ç”±ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…é ˆï¼‰</li>
            <li>å¤–éƒ¨å…¬é–‹ DTO ã¨å†…éƒ¨ Entity/Model ã¯åˆ†é›¢ï¼ˆ<b>æœ€å°å…¬é–‹</b>ã®åŸå‰‡ï¼‰</li>
            <li>API ã§ã¯æ—¥æ™‚ã¯ <b>ISO8601æ–‡å­—åˆ—</b> ã§ã‚„ã‚Šå–ã‚Š</li>
            <li>ãƒ¦ãƒ‹ã‚ªãƒ³/Enumã¯<b>æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«å‹</b>ã‚’å„ªå…ˆï¼ˆä¾‹ï¼š<code>'pending' | 'approved' | 'rejected'</code>ï¼‰</li>
          </ul>
        </Section>

        <Section id="nest" title="3. NestJSï¼ˆAPIï¼‰">
          <h4 className="font-semibold mb-2">Controller / Service</h4>
          <ul className="list-disc pl-6 space-y-2">
            <li>Controller ã¯è–„ãï¼ˆæ¤œè¨¼ãƒ»å…¥å‡ºåŠ›æ•´å½¢ï¼‰ã€Service ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯é›†ç´„</li>
            <li>Repositoryï¼ˆPrismaï¼‰ã¯ã•ã‚‰ã«è–„ãã€ãƒ‡ãƒ¼ã‚¿å–å¾—è²¬å‹™ã«é™å®š</li>
          </ul>
          <Code
            lang="ts"
            code={`// casts.controller.ts
@Post(':id/store-flags')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('STAFF','ADMIN')
async upsertFlags(
  @Param('id', ParseUUIDPipe) id: string,
  @Body() dto: UpsertFlagsDto,
) {
  return this.castsService.upsertFlags(id, dto);
}`}
          />

          <h4 className="font-semibold mb-2 mt-6">DTO / Validation</h4>
          <ul className="list-disc pl-6 space-y-2">
            <li><b>class-validator</b> å¿…é ˆã€‚<code>transform: true</code>ã€<code>whitelist: true</code></li>
          </ul>
          <Code
            lang="ts"
            code={`export class SearchCastsDto {
  @IsOptional() @IsUUID() handlerId?: string;
  @IsOptional() @IsInt() @Min(0) hourlyMin?: number;
  @IsOptional() @IsInt() @Min(0) hourlyMax?: number;
  @IsOptional() @IsIn(['and','or']) logic: 'and' | 'or' = 'and';
  @IsOptional() @IsUUID() excludeNgForShopId?: string;
  @IsOptional() @IsInt() @Min(1) page: number = 1; // 30ä»¶å›ºå®š
}`}
          />

          <h4 className="font-semibold mb-2 mt-6">èªè¨¼ãƒ»èªå¯ãƒ»APIãƒãƒªã‚·ãƒ¼</h4>
          <ul className="list-disc pl-6 space-y-2">
            <li>API ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š<b>/api/v1</b></li>
            <li>èªè¨¼ï¼š<b>JWT</b>ã€èªå¯ï¼š<b>Guard + RBAC</b>ï¼ˆ<code>@Roles()</code>ï¼‰</li>
            <li>ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼š<b>30ä»¶å›ºå®š</b>ã€<code>?page=1</code> ã‹ã‚‰é–‹å§‹</li>
            <li>ã‚¨ãƒ©ãƒ¼å½¢å¼ï¼š<code>{`{ error_code, message, details? }`}</code></li>
          </ul>

          <h4 className="font-semibold mb-2 mt-6">ãƒ­ã‚®ãƒ³ã‚° / ç›£æŸ» / ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
          <ul className="list-disc pl-6 space-y-2">
            <li>å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« <b>request_id</b> ä»˜ä¸ã€JSON ãƒ­ã‚°</li>
            <li>é‡è¦æ“ä½œï¼ˆNGç™»éŒ²ã€ã‚·ãƒ•ãƒˆç¢ºå®šã€å¿œå‹Ÿæ‰¿èªï¼‰ã¯ <b>audit_logs</b> ã« JSON diff ä¿å­˜</li>
            <li>N+1å›é¿ã€‚å¿…è¦ãª <code>include/select</code> ã®ã¿ä½¿ç”¨</li>
          </ul>
        </Section>

        <Section id="prisma" title="4. Prisma / DB">
          <ul className="list-disc pl-6 space-y-2">
            <li>ãƒ†ãƒ¼ãƒ–ãƒ«/ã‚«ãƒ©ãƒ ã¯ <b>snake_case</b>ï¼ˆ<code>@@map</code>/<code>@map</code>ï¼‰</li>
            <li>ä¸»ã‚­ãƒ¼ã¯ <b>UUID v4</b>ï¼ˆ<code>default(uuid())</code>ï¼‰</li>
            <li><code>created_at</code>/<code>updated_at</code> ã¯ã‚¢ãƒ—ãƒªå±¤ã§ç®¡ç†</li>
            <li>å¤–éƒ¨IDï¼ˆä¾‹ï¼šLINE <code>sub</code>ï¼‰ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„</li>
            <li>å‚ç…§æ•´åˆï¼šFK ã«ã‚ˆã‚‹ã€‚å±¥æ­´ã¯ç›£æŸ»ãƒ­ã‚°ã§è¿½è·¡</li>
          </ul>
          <h4 className="font-semibold mb-2 mt-4">ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h4>
          <ul className="list-disc pl-6 space-y-2">
            <li>PRæ¯ã« <code>prisma migrate dev --create-only</code> ã‚’ç™ºè¡Œã—å·®åˆ†ãƒ¬ãƒ“ãƒ¥ãƒ¼</li>
            <li>ç ´å£Šçš„å¤‰æ›´ã¯æ®µéšå°å…¥ï¼ˆè¿½åŠ â†’ä¸¡å¯¾å¿œâ†’å‰Šé™¤ï¼‰</li>
          </ul>
        </Section>

        <Section id="frontend" title="5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.js / Reactï¼‰">
          <ul className="list-disc pl-6 space-y-2">
            <li>Server Component ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯å¿…è¦æœ€å°é™</li>
            <li>ãƒ‡ãƒ¼ã‚¿å–å¾—ã¯ <b>fetcherï¼ˆSWR/React Query ç­‰ï¼‰</b> ã«é›†ç´„ã—ã€UI ç›´æ¥ fetch ã‚’é¿ã‘ã‚‹</li>
            <li>å½“æ—¥å‡ºå‹¤ 100åã§ã‚‚å¿«é©è¡¨ç¤ºï¼ˆ<b>ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</b> æ¤œè¨ï¼‰</li>
            <li>ä¸€è¦§ã¯ 30ä»¶å›ºå®šãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‹ã‚µãƒãƒªä»¶æ•°</li>
            <li>ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼šãƒ•ã‚©ãƒ¼ãƒ  labelã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã€å°åˆ·ç”¨ CSS</li>
          </ul>
        </Section>

        <Section id="security" title="6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ / å€‹äººæƒ…å ±">
          <ul className="list-disc pl-6 space-y-2">
            <li>XSS/SQLi/SSRF å¯¾ç­–ã€‚å¤–éƒ¨URLå–å¾—ã¯ç¦æ­¢ï¼ˆå¿…è¦æ™‚ã¯ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼‰</li>
            <li>S3 ç½²åURLï¼š<b>æœ€å°æ¨©é™ IAM</b>ã€TTL çŸ­ã‚ï¼ˆ~10åˆ†ï¼‰ã€Content-Type å›ºå®š</li>
            <li>èº«åˆ†è¨¼ã¯ <b>S3ã‚­ãƒ¼ã®ã¿ä¿æŒ</b>ã€URLã¯éƒ½åº¦ç½²åã€‚<b>90æ—¥ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«</b>ï¼ˆè¦ä»¶ã§èª¿æ•´ï¼‰</li>
            <li>ãƒ­ã‚°ã«PIIã‚’å‡ºã•ãªã„ã€‚ãƒˆãƒ¼ã‚¯ãƒ³/IDã¯ãƒã‚¹ã‚¯</li>
          </ul>
        </Section>

        <Section id="test" title="7. ãƒ†ã‚¹ãƒˆ / å“è³ª">
          <ul className="list-disc pl-6 space-y-2">
            <li>Unitï¼šJestï¼ˆService/Utilï¼‰</li>
            <li>Integrationï¼šSupertestï¼ˆController + Prisma with test DBï¼‰</li>
            <li>E2Eï¼šä¸»è¦ãƒ•ãƒ­ãƒ¼ï¼ˆå¿œå‹Ÿâ†’æ‰¿èªâ†’æœ¬ç™»éŒ²ã€å½“æ—¥å‡ºå‹¤ä¸€è¦§ã€NGé™¤å¤–ãƒãƒƒãƒãƒ³ã‚°ï¼‰</li>
            <li>ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ï¼š<b>lines 70% / ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« 90%</b></li>
            <li>ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯ <b>factory</b> ã§ç”Ÿæˆã€å›ºå®šIDä¾å­˜ã‚’é¿ã‘ã‚‹</li>
          </ul>
        </Section>

        <Section id="docs" title="8. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ / å¤‰æ›´ç®¡ç†">
          <ul className="list-disc pl-6 space-y-2">
            <li>OpenAPIï¼ˆSwaggerï¼‰ã¯å¸¸ã«æ›´æ–°ã€‚PRã«å·®åˆ†ã®ã‚¹ã‚¯ã‚·ãƒ§/ãƒªãƒ³ã‚¯ã‚’æ·»ä»˜</li>
            <li>æ±ºå®šäº‹é …ã¯ ADRï¼ˆè»½é‡ï¼‰ã§ <code>/docs/adr/</code> ã«ä¿å­˜</li>
            <li>ERD ãŒå”¯ä¸€ã®çœŸå®Ÿæºã€‚å¤‰æ›´ã¯ ERD â†’ PR â†’ Prisma åæ˜ ã®é †</li>
          </ul>
        </Section>

        <Section id="retry" title="9. ä¾‹å¤–ãƒ»ãƒªãƒˆãƒ©ã‚¤æ–¹é‡ / Webhook">
          <ul className="list-disc pl-6 space-y-2">
            <li>S3ãƒ»å¤–éƒ¨APIã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§3å›ï¼‰</li>
            <li>DBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã¯æ˜ç¤ºãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€å†è©¦è¡Œã¯ idempotency key</li>
            <li>Webhook ã¯ç½²åæ¤œè¨¼å¿…é ˆã€‚200ä»¥å¤–ã¯å†è©¦è¡Œ</li>
          </ul>
        </Section>

        <Section id="pr-check" title="10. PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ">
          <ul className="list-disc pl-6 space-y-2">
            <li>TypeScript ã‚¨ãƒ©ãƒ¼ãªã—ã€<code>any</code> å›é¿ã€å‹å®šç¾©å¦¥å½“</li>
            <li>DTO ã® <code>class-validator</code> ãŒå®Œå…¨</li>
            <li>ãƒšãƒ¼ã‚¸ãƒ³ã‚°30ä»¶å›ºå®šãƒ»æ¤œç´¢æ¡ä»¶ãŒ API ã¨ä¸€è‡´</li>
            <li>ç›£æŸ»ãƒ­ã‚°ï¼ˆè¿½åŠ /æ›´æ–°/å‰Šé™¤ï¼‰ãŒè¨˜éŒ²ã•ã‚Œã‚‹</li>
            <li>S3 ã¯ <b>s3_key ã®ã¿</b> ä¿å­˜ï¼ˆç›´ãƒªãƒ³ã‚¯ä¿å­˜ãªã—ï¼‰</li>
            <li>ãƒ­ã‚°/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« PII ãŒå«ã¾ã‚Œãªã„</li>
          </ul>
        </Section>

        <Section id="starter" title="ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼åŒæ¢±ï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰">
          <h4 className="font-semibold">.prettierrcï¼ˆæ¨å¥¨ï¼‰</h4>
          <Code
            lang="json"
            code={`{
  "singleQuote": true,
  "semi": true,
  "trailingComma": "all",
  "printWidth": 100,
  "tabWidth": 2
}`}
          />
          <h4 className="mt-4 font-semibold">.eslintrc.jsï¼ˆæ¨å¥¨ï¼‰</h4>
          <Code
            lang="js"
            code={`module.exports = {
  root: true,
  parser: '@typescript-eslint/parser',
  plugins: ['@typescript-eslint', 'import'],
  extends: ['next/core-web-vitals', 'plugin:@typescript-eslint/recommended'],
  rules: {
    'import/order': [
      'error',
      {
        groups: ['builtin', 'external', 'internal', ['parent', 'sibling', 'index']],
        pathGroups: [{ pattern: '@/**', group: 'internal' }],
        'newlines-between': 'always',
        alphabetize: { order: 'asc', caseInsensitive: true }
      }
    ],
    '@typescript-eslint/no-explicit-any': 'error'
  }
};`}
          />
          <h4 className="mt-4 font-semibold">package.jsonï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹ï¼‰</h4>
          <Code
            lang="json"
            code={`{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint .",
    "format": "prettier --write ."
  }
}`}
          />
          <h4 className="mt-4 font-semibold">tsconfig.jsonï¼ˆæŠœç²‹ï¼‰</h4>
          <Code
            lang="json"
            code={`{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "jsx": "preserve",
    "baseUrl": ".",
    "paths": { "@/*": ["*"] },
    "strict": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true
  }
}`}
          />
          <h4 className="mt-4 font-semibold">.gitignoreï¼ˆæŠœç²‹ï¼‰</h4>
          <Code lang="txt" code={`node_modules\n.next\n.env.local\naudit.json`} />
        </Section>

        <footer className="pt-8 border-t border-[#24304a] text-xs text-[#9aa3b2]">
          <p>Â© Tiara Portal Team â€” Coding Rules v1.0ï¼ˆç¢ºå®šï¼‰ã€‚å¿…è¦ã«å¿œã˜ã¦ADRã§æ›´æ–°ã—ã¦ãã ã•ã„ã€‚</p>
        </footer>
      </div>
    </main>
  );
};

export default Page;

/* ------------------------- UI Helpers ------------------------- */
const Nav: React.FC = () => (
  <nav className="sticky top-0 z-10 -mt-6 backdrop-blur bg-[#0b1020]/80 border-y border-[#24304a]">
    <div className="max-w-4xl mx-auto px-4 py-3 text-sm overflow-x-auto whitespace-nowrap">
      <a className="mr-4 hover:underline" href="#intro">0. å‰æ</a>
      <a className="mr-4 hover:underline" href="#naming">1. å‘½å/æ§‹æˆ</a>
      <a className="mr-4 hover:underline" href="#ts">2. TypeScript</a>
      <a className="mr-4 hover:underline" href="#nest">3. NestJS</a>
      <a className="mr-4 hover:underline" href="#prisma">4. Prisma/DB</a>
      <a className="mr-4 hover:underline" href="#frontend">5. Frontend</a>
      <a className="mr-4 hover:underline" href="#security">6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</a>
      <a className="mr-4 hover:underline" href="#test">7. ãƒ†ã‚¹ãƒˆ</a>
      <a className="mr-4 hover:underline" href="#docs">8. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>
      <a className="mr-4 hover:underline" href="#retry">9. ãƒªãƒˆãƒ©ã‚¤/Webhook</a>
      <a className="mr-4 hover:underline" href="#pr-check">10. PRãƒã‚§ãƒƒã‚¯</a>
      <a className="hover:underline" href="#starter">ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼</a>
    </div>
  </nav>
);

const Section: React.FC<{ id: string; title: string; children: React.ReactNode }> = ({
  id,
  title,
  children,
}) => (
  <section
    id={id}
    className="bg-[#111733] border border-[#24304a] rounded-2xl p-6 shadow-[0_0_0_1px_rgba(255,255,255,0.02)_inset]"
  >
    <h2 className="text-xl font-semibold mb-3">{title}</h2>
    <div className="text-sm leading-relaxed text-[#d5d9e3]">{children}</div>
  </section>
);

const Code: React.FC<{ lang?: string; code: string }> = ({ lang, code }) => (
  <pre className="relative mt-3 overflow-x-auto rounded-xl border border-[#24304a] bg-[#0a0f22] p-4 text-xs">
    {lang ? <span className="absolute right-3 top-2 text-[10px] text-[#8fa1c1]">{lang}</span> : null}
    <code>{code}</code>
  </pre>
);
</file>

<file path="pages/progress.tsx">
// pages/progress.tsx
import Head from "next/head";
import dynamic from "next/dynamic";
import { useEffect, useMemo, useState } from "react";
import dayjs from "dayjs";
import { loadTasks, type Task } from "../lib/tasksLoader";

function weekRange(base: dayjs.Dayjs) {
  return { start: base.startOf("week"), end: base.endOf("week") };
}
function overlapsWeek(start: string | undefined, end: string | undefined, wkStart: dayjs.Dayjs, wkEnd: dayjs.Dayjs) {
  const ymd = (s?: string) => (s && /^\d{4}-\d{2}-\d{2}$/.test(s) ? dayjs(s).startOf("day") : null);
  if (!start && !end) return false;
  const s = ymd(start) ?? dayjs("1900-01-01");
  const e = ymd(end) ?? dayjs("2999-12-31");
  return s.isBefore(wkEnd) && e.isAfter(wkStart);
}

function ProgressInner() {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      try {
        const data = await loadTasks();
        setTasks(data);
        setLoading(false);
      } catch (e: any) {
        setError(e?.message || "èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        setLoading(false);
      }
    })();
  }, []);

  const summary = useMemo(() => {
    if (tasks.length === 0) return { avg: 0, total: 0, started: 0, finished: 0 };
    const avg = Math.round(tasks.reduce((acc, t) => acc + (t.progress ?? 0), 0) / tasks.length);
    const now = dayjs();
    const ymd = (s?: string) => (s && /^\d{4}-\d{2}-\d{2}$/.test(s) ? dayjs(s).startOf("day") : null);
    const started = tasks.filter((t) => (t.start && ymd(t.start)?.isBefore(now)) || t.started).length;
    const finished = tasks.filter((t) => t.progress === 100 || t.done).length;
    return { avg, total: tasks.length, started, finished };
  }, [tasks]);

  const now = dayjs();
  const thisWeek = weekRange(now);
  const nextWeek = weekRange(now.add(1, "week"));

  const tasksThisWeek = useMemo(
    () => tasks.filter((t) => overlapsWeek(t.start, t.end, thisWeek.start, thisWeek.end)),
    [tasks, thisWeek.start, thisWeek.end]
  );
  const tasksNextWeek = useMemo(
    () => tasks.filter((t) => overlapsWeek(t.start, t.end, nextWeek.start, nextWeek.end)),
    [tasks, nextWeek.start, nextWeek.end]
  );

  return (
    <>
      <Head><title>é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title></Head>
      <main style={{ fontFamily: "system-ui, sans-serif", padding: "2rem" }}>
        <h1>ğŸ“ˆ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

        {loading && <p>èª­ã¿è¾¼ã¿ä¸­...</p>}
        {error && <p style={{ color: "crimson" }}>ã‚¨ãƒ©ãƒ¼ï¼š{error}</p>}

        {!loading && !error && (
          <>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(4, minmax(0, 1fr))", gap: "12px", margin: "16px 0" }}>
              <Card title="å¹³å‡é€²æ—"><Big>{summary.avg}%</Big></Card>
              <Card title="ã‚¿ã‚¹ã‚¯ç·æ•°"><Big>{summary.total}</Big></Card>
              <Card title="é–‹å§‹æ¸ˆã¿"><Big>{summary.started}</Big></Card>
              <Card title="å®Œäº†æ¸ˆã¿"><Big>{summary.finished}</Big></Card>
            </div>

            <Section title={`ğŸ—“ ä»Šé€± (${thisWeek.start.format("YYYY/MM/DD")} - ${thisWeek.end.format("YYYY/MM/DD")})`} tasks={tasksThisWeek} />
            <Section title={`ğŸ—“ æ¥é€± (${nextWeek.start.format("YYYY/MM/DD")} - ${nextWeek.end.format("YYYY/MM/DD")})`} tasks={tasksNextWeek} />
          </>
        )}
      </main>
    </>
  );
}

function Card(props: { title: string; children: any }) {
  return (
    <div style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 8, padding: 12, boxShadow: "0 1px 2px rgba(0,0,0,0.04)" }}>
      <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 6 }}>{props.title}</div>
      <div>{props.children}</div>
    </div>
  );
}
function Big(props: { children: any }) {
  return <div style={{ fontSize: 28, fontWeight: 700, color: "#111827" }}>{props.children}</div>;
}
function Section(props: { title: string; tasks: Task[] }) {
  return (
    <section style={{ marginTop: 24 }}>
      <h2 style={{ color: "#2563eb" }}>{props.title}</h2>
      {props.tasks.length === 0 ? (
        <p style={{ color: "#6b7280" }}>è©²å½“ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      ) : (
        <div style={{ marginTop: 8, display: "grid", gap: 8 }}>
          {props.tasks.map((t, i) => <TaskItem key={i} task={t} />)}
        </div>
      )}
    </section>
  );
}
function TaskItem({ task }: { task: Task }) {
  const start = task.start ?? "â€”";
  const end = task.end ?? "â€”";
  const pct = Math.max(0, Math.min(100, Math.round(task.progress ?? 0)));
  return (
    <div style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 8, padding: 12 }}>
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12 }}>
        <div style={{ fontWeight: 600, color: "#111827" }}>{task.title}</div>
        <div style={{ fontSize: 12, color: "#6b7280" }}>{start} â†’ {end}</div>
      </div>
      <div style={{ marginTop: 8, height: 10, background: "#f3f4f6", borderRadius: 999 }}>
        <div style={{ width: `${pct}%`, height: "100%", borderRadius: 999, background: "#60a5fa" }} />
      </div>
      <div style={{ marginTop: 6, fontSize: 12, color: "#374151" }}>
        é€²æ—: <strong>{pct}%</strong>
        {task.owner ? <>ã€€/ æ‹…å½“: {task.owner}</> : null}
        {task.status ? <>ã€€/ çŠ¶æ…‹: {task.status}</> : null}
      </div>
    </div>
  );
}

function Progress() { return <ProgressInner />; }
export default dynamic(() => Promise.resolve(Progress), { ssr: false });
</file>

<file path="pages/questionnaire.tsx">
// pages/questionnaire.tsx
'use client';

import { useEffect, useRef, useState } from 'react';

type Question   = { id: string; label: string; placeholder?: string };
type Section    = { id: string; title: string; items: Question[] };
type SchemaData = { version: string; sections: Section[] };
type AnswersData = Record<string, string>;

/** ãƒ•ãƒ«å¹…ï¼‹ç¸¦ã‚ªãƒ¼ãƒˆãƒªã‚µã‚¤ã‚ºã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
function AutoTextarea({
  value,
  onChange,
  placeholder,
  minRows = 3,
  maxPx = 600,
}: {
  value: string;
  onChange: (e: React.ChangeEvent<HTMLTextAreaElement>) => void;
  placeholder?: string;
  minRows?: number;
  maxPx?: number;
}) {
  const ref = useRef<HTMLTextAreaElement | null>(null);

  const autoresize = () => {
    const el = ref.current;
    if (!el) return;
    el.style.height = 'auto';
    const lineHeight = parseInt(getComputedStyle(el).lineHeight || '20', 10);
    const minHeight = lineHeight * minRows + 12;
    el.style.height = Math.max(minHeight, Math.min(el.scrollHeight, maxPx)) + 'px';
  };

  useEffect(() => { autoresize(); }, [value]);
  useEffect(() => { autoresize(); }, []);

  return (
    <textarea
      ref={ref}
      rows={minRows}
      value={value}
      onChange={(e) => { onChange(e); requestAnimationFrame(autoresize); }}
      placeholder={placeholder}
      style={{
        width: '100%',
        boxSizing: 'border-box',
        resize: 'none',
        padding: '12px',
        border: '1px solid #d1d5db',
        borderRadius: 8,
        lineHeight: '1.6',
        fontSize: 14,
        background: '#fff',
        maxHeight: maxPx,
      }}
    />
  );
}

/** åˆæœŸã‚¹ã‚­ãƒ¼ãƒï¼ˆExcelå–è¾¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
const DEFAULT_SCHEMA: SchemaData = {
  version: 'v1',
  sections: [
    {
      id: '1-æ¥­å‹™é‹ç”¨ã®ç¢ºå®šäº‹é …',
      title: '1. æ¥­å‹™ãƒ»é‹ç”¨ã®ç¢ºå®šäº‹é …',
      items: [
        { id: '1-æ¥­å‹™é‹ç”¨ã®ç¢ºå®šäº‹é …-q1', label: 'ã€å½¹å‰²ã¨ç«¯æœ«ã€‘', placeholder: 'ã‚­ãƒ£ã‚¹ãƒˆ/ç®¡ç†è€…ï¼ˆæ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ï¼‰/æ´¾é£å…ˆï¼ˆæ¥å¹´ï¼‰ Ã— ã‚­ãƒ£ã‚¹ãƒˆï¼ã‚¹ãƒãƒ›ï¼ç®¡ç†è€…ãƒ»æ´¾é£å…ˆï¼PC' },
        { id: '1-æ¥­å‹™é‹ç”¨ã®ç¢ºå®šäº‹é …-q2', label: 'ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ­£ã€‘', placeholder: 'ç™»éŒ² â‡¨ é¢è«‡ â‡¨ åˆå¦ â‡¨ å‡ºå‹¤é€£çµ¡ â‡¨ å½“æ—¥æ¬ å‹¤ãƒ»ç·Šæ€¥æ‹›é›† â‡¨ é…ç½® â‡¨ æ—¥å ± â‡¨ è«‹æ±‚ãƒ»è«‹æ±‚æ›¸' },
        { id: '1-æ¥­å‹™é‹ç”¨ã®ç¢ºå®šäº‹é …-q3', label: 'ã€SLA/åå¿œé€Ÿåº¦ã€‘', placeholder: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åæ˜ ã¾ã§ã®ç›®æ¨™ï¼ˆLINEé€£çµ¡ â†’ 10ç§’ä»¥å†…åæ˜ ï¼‰' },
        { id: '1-æ¥­å‹™é‹ç”¨ã®ç¢ºå®šäº‹é …-q4', label: 'ã€ç›£æŸ»ãƒ»å±¥æ­´ã€‘', placeholder: 'èª°ãŒä½•ã‚’ã„ã¤å¤‰ãˆãŸã‹ï¼ˆç›£æŸ»ãƒ­ã‚°ã®ç²’åº¦ï¼‰' },
      ],
    },
    {
      id: '2-ç”»é¢ã«å‡ºã™æƒ…å ±ã®æœ€çµ‚ãƒªã‚¹ãƒˆä¸€è¦§è©³ç´°',
      title: '2. ç”»é¢ã«å‡ºã™æƒ…å ±ã®æœ€çµ‚ãƒªã‚¹ãƒˆï¼ˆä¸€è¦§ãƒ»è©³ç´°ï¼‰',
      items: [
        { id: '2-ç”»é¢ã«å‡ºã™æƒ…å ±ã®æœ€çµ‚ãƒªã‚¹ãƒˆä¸€è¦§è©³ç´°-q1', label: 'ã€ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§30ä»¶/ãƒšãƒ¼ã‚¸å›ºå®šã§è¡¨ç¤ºã™ã‚‹é …ç›®ã®ç¢ºå®šã€‘', placeholder: 'ãƒ¢ãƒƒã‚¯ç”»é¢æå‡ºæ¸ˆã¿ï¼ˆè¦ç¢ºèªï¼‰' },
        { id: '2-ç”»é¢ã«å‡ºã™æƒ…å ±ã®æœ€çµ‚ãƒªã‚¹ãƒˆä¸€è¦§è©³ç´°-q2', label: 'ã€ã‚­ãƒ£ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰è©³ç´°ã§ã®ã¿å‡ºã™é …ç›®ã€‘', placeholder: 'ãƒ¢ãƒƒã‚¯ç”»é¢æå‡ºæ¸ˆã¿ï¼ˆè¦ç¢ºèªï¼‰' },
        { id: '2-ç”»é¢ã«å‡ºã™æƒ…å ±ã®æœ€çµ‚ãƒªã‚¹ãƒˆä¸€è¦§è©³ç´°-q3', label: 'ã€ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒå®šç¾©ã€‘', placeholder: 'ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç¨®é¡ã®ç¢ºå®š' },
        { id: '2-ç”»é¢ã«å‡ºã™æƒ…å ±ã®æœ€çµ‚ãƒªã‚¹ãƒˆä¸€è¦§è©³ç´°-q4', label: 'ã€ä¸¦ã³é †ã®å„ªå…ˆè¦å‰‡ã€‘', placeholder: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•é †ï¼Ÿï¼ˆä¾‹ï¼šè©•ä¾¡ â†’ æ™‚çµ¦ â†’ åå‰ï¼‰' },
      ],
    },
    {
      id: '3-çµã‚Šè¾¼ã¿æ¤œç´¢ã®ä»•æ§˜',
      title: '3. çµã‚Šè¾¼ã¿ãƒ»æ¤œç´¢ã®ä»•æ§˜',
      items: [
        { id: '3-çµã‚Šè¾¼ã¿æ¤œç´¢ã®ä»•æ§˜-q1', label: 'ã€çµã‚Šè¾¼ã¿ç¨®é¡ã€‘', placeholder: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãƒ»æ‹…å½“è€…ãƒ»æ™‚çµ¦ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ãƒ»é£²é…’ã®å¯å¦' },
        { id: '3-çµã‚Šè¾¼ã¿æ¤œç´¢ã®ä»•æ§˜-q2', label: 'ã€è¤‡åˆæ¡ä»¶ã®è§£æ±ºé †ã€‘', placeholder: 'NGé™¤å¤–ï¼ˆåº—èˆ—å´/ã‚­ãƒ£ã‚¹ãƒˆå´ã®åŒæ–¹ï¼‰ â‡¨ å‡ºå‹¤ä¸­ã®ã¿ â‡¨ ã‚½ãƒ¼ãƒˆ' },
      ],
    },
    {
      id: '4-ãƒãƒƒãƒãƒ³ã‚°ã®æ¥­å‹™ãƒ«ãƒ¼ãƒ«',
      title: '4. ãƒãƒƒãƒãƒ³ã‚°ã®æ¥­å‹™ãƒ«ãƒ¼ãƒ«',
      items: [
        { id: '4-ãƒãƒƒãƒãƒ³ã‚°ã®æ¥­å‹™ãƒ«ãƒ¼ãƒ«-q1', label: 'ã€è‡ªå‹•åŒ–ã®ç¯„å›²ã€‘', placeholder: 'ãƒãƒƒãƒãƒ³ã‚°ã®é…ç½®ç¢ºå®šä½œæ¥­ã¯äººåŠ›ã§è‰¯ã„ï¼Ÿ' },
        { id: '4-ãƒãƒƒãƒãƒ³ã‚°ã®æ¥­å‹™ãƒ«ãƒ¼ãƒ«-q2', label: 'ã€æ¡ä»¶ã€‘', placeholder: 'å……è¶³æ¡ä»¶ï¼ˆå¿…è¦äººæ•°ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰ã¨é™¤å¤–æ¡ä»¶ï¼ˆNGåº—èˆ—ï¼‰' },
        { id: '4-ãƒãƒƒãƒãƒ³ã‚°ã®æ¥­å‹™ãƒ«ãƒ¼ãƒ«-q3', label: 'ã€é…ç½®ç¢ºå®šã®æ‰¿èªãƒ•ãƒ­ãƒ¼ã€‘', placeholder: 'èª°ãŒOKã‚’å‡ºã™ã‹ï¼å·®ã—æˆ»ã—ï¼é…ç½®ç¢ºå®šã®æ“ä½œç”»é¢ã¯DBã§åˆã£ã¦ã„ã‚‹ã‹ï¼ã‚­ãƒ£ã‚¹ãƒˆè©³ç´°ç”»é¢ã§åº—èˆ—é¸æŠå¿…é ˆï¼å·®ã—æˆ»ã—ã®ãƒ•ãƒ­ãƒ¼è¦ç¢ºèª' },
      ],
    },
    {
      id: '5-ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ•´åˆæ€§',
      title: '5. ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ»æ•´åˆæ€§',
      items: [
        { id: '5-ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ•´åˆæ€§-q1', label: 'ã€å‡ºå‹¤ãƒ»æ¬ å‹¤ãƒ»ç·Šæ€¥æ‹›é›†ã®é€šçŸ¥çµŒè·¯ã€‘', placeholder: 'LINEã®ã¿ï¼ãƒ¡ãƒ¼ãƒ«ä½µç”¨ãªã®ã‹ï¼Ÿ' },
        { id: '5-ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ•´åˆæ€§-q2', label: 'ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®å®šç¾©ã€‘', placeholder: 'Pushã§å³æ™‚ï¼ãƒãƒ¼ãƒªãƒ³ã‚°ä½•ç§’' },
        { id: '5-ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ•´åˆæ€§-q3', label: 'ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆèº«åˆ†è¨¼ï¼‰ã€‘', placeholder: 'ä¿å­˜å…ˆãƒ»ä¿æŒæœŸé–“ãƒ»ãƒã‚¹ã‚­ãƒ³ã‚°æ–¹é‡ã®ç¢ºå®š' },
      ],
    },
    {
      id: '6-æ¨©é™å¯è¦–æ€§rbac',
      title: '6. æ¨©é™ãƒ»å¯è¦–æ€§ï¼ˆRBACï¼‰',
      items: [
        { id: '6-æ¨©é™å¯è¦–æ€§rbac-q1', label: 'ã€ï¼ˆä»®ï¼‰ã‚­ãƒ£ã‚¹ãƒˆç”¨ã€‘', placeholder: 'è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã‚·ãƒ•ãƒˆç”³è«‹ã€æ‹…å½“ã¸é€£çµ¡ï¼ˆå½“æ—¥æ¬ å‹¤ãƒ»å½“æ—¥å‡ºå‹¤ï¼‰ã€æ—¢èª­æœªèª­ã€é€šçŸ¥ã€å‡ºé€€å‹¤é€£çµ¡' },
        { id: '6-æ¨©é™å¯è¦–æ€§rbac-q2', label: 'ã€ã‚¨ãƒ³ãƒ‰ç”¨ã€‘', placeholder: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã€ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ã€åº—èˆ—ç®¡ç†ã€ãƒãƒ£ãƒƒãƒˆï¼ˆå…¬å¼LINEï¼‰ã€SOSé€šçŸ¥ã€ç”³è«‹æ‰¿èªã€è¨­å®š' },
        { id: '6-æ¨©é™å¯è¦–æ€§rbac-q3', label: 'ã€ï¼ˆä»®ï¼‰æ´¾é£å…ˆãƒ“ãƒ¥ãƒ¼ã€‘', placeholder: 'é–²è¦§ç¯„å›²ï¼ˆè‡ªåº—èˆ—ã®ã¿ï¼‰ã€è©•ä¾¡å…¥åŠ›æ¨©é™' },
      ],
    },
    {
      id: '7-éæ©Ÿèƒ½è¦ä»¶',
      title: '7. éæ©Ÿèƒ½è¦ä»¶',
      items: [
        { id: '7-éæ©Ÿèƒ½è¦ä»¶-q1', label: 'ã€ç›®æ¨™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆP95/P99ï¼‰ã€åŒæ™‚åˆ©ç”¨è€…æƒ³å®šã€‘', placeholder: 'è‡ªç”±è¨˜è¿°' },
        { id: '7-éæ©Ÿèƒ½è¦ä»¶-q2', label: 'ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ãƒªã‚¹ãƒˆã‚¢ã€å€‹äººæƒ…å ±ä¿è­·ï¼ˆã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ»æš—å·åŒ–ãƒ»ãƒã‚¹ã‚­ãƒ³ã‚°ï¼‰ã€‘', placeholder: 'è‡ªç”±è¨˜è¿°' },
        { id: '7-éæ©Ÿèƒ½è¦ä»¶-q3', label: 'ã€ç›£è¦–ï¼ˆæ­»æ´»ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆãƒ»é€šçŸ¥ï¼‰ã¨éšœå®³å¯¾å¿œãƒ•ãƒ­ãƒ¼ã€‘', placeholder: 'è‡ªç”±è¨˜è¿°' },
      ],
    },
    {
      id: '8-linechatwoot-é‹ç”¨è¨­è¨ˆ',
      title: '8. LINE/Chatwoot é‹ç”¨è¨­è¨ˆ',
      items: [
        { id: '8-linechatwoot-é‹ç”¨è¨­è¨ˆ-q1', label: 'ã€å…¬å¼LINEã®æ§‹æˆï¼ˆã‚¹ã‚¿ãƒƒãƒ•è¤‡æ•°ç´ä»˜ã‘ï¼‰ã¨Chatwootã®åå®¹ï¼ˆã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹/ãƒãƒ¼ãƒ /æ¨©é™ï¼‰ã€‘', placeholder: 'è‡ªç”±è¨˜è¿°' },
        { id: '8-linechatwoot-é‹ç”¨è¨­è¨ˆ-q2', label: 'ã€é€å—ä¿¡ã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã€ãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ã™ã‚‹å®šå‹æ–‡ï¼ˆæ¬ å‹¤å—ä»˜ã€ç·Šæ€¥æ‹›é›†ã€ã‚¤ãƒ™ãƒ³ãƒˆå‘ŠçŸ¥ï¼‰ã€‘', placeholder: 'è‡ªç”±è¨˜è¿°' },
        { id: '8-linechatwoot-é‹ç”¨è¨­è¨ˆ-q3', label: 'ã€æ—¢èª­ãƒ»æœªèª­ï¼åå¿œæ™‚é–“ã®KPIã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åæ˜ ã€‘', placeholder: 'è‡ªç”±è¨˜è¿°' },
      ],
    },
  ],
};

const LS_SCHEMA_KEY = 'questionnaire.schema.latest';
const LS_ANS_KEY    = 'questionnaire.answers.latest';

export default function QuestionnairePage() {
  const [author, setAuthor]   = useState('');
  const [schema, setSchema]   = useState<SchemaData>(DEFAULT_SCHEMA);
  const [answers, setAnswers] = useState<AnswersData>({});
  const [editing, setEditing] = useState(false);
  const [saving, setSaving]   = useState(false);
  const [saveMsg, setSaveMsg] = useState<string | null>(null);
  const [errMsg, setErrMsg]   = useState<string | null>(null);

  // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šSupabaseã®æœ€æ–°ï¼ˆç„¡ã‘ã‚Œã° localStorage â†’ DEFAULTï¼‰
  useEffect(() => {
    (async () => {
      try {
        const s = await fetch('/api/questionnaire/schema/load').then(r => r.json()).catch(() => null);
        if (s?.ok && s?.data?.data) {
          setSchema(s.data.data as SchemaData);
          localStorage.setItem(LS_SCHEMA_KEY, JSON.stringify(s.data.data));
        } else {
          const raw = localStorage.getItem(LS_SCHEMA_KEY);
          if (raw) setSchema(JSON.parse(raw));
        }
      } catch {}
      try {
        const a = await fetch('/api/questionnaire/answers/load').then(r => r.json()).catch(() => null);
        if (a?.ok && a?.data?.data) {
          setAnswers(a.data.data as AnswersData);
          localStorage.setItem(LS_ANS_KEY, JSON.stringify(a.data.data));
        } else {
          const raw = localStorage.getItem(LS_ANS_KEY);
          if (raw) setAnswers(JSON.parse(raw));
        }
      } catch {}
    })();
  }, []);

  // ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ï¼šanswers ã®ã‚­ãƒ¼ã‚’è£œå®Œ
  useEffect(() => {
    const ids = new Set(schema.sections.flatMap(sec => sec.items.map(i => i.id)));
    setAnswers(prev => {
      const next = { ...prev };
      ids.forEach(id => { if (!(id in next)) next[id] = ''; });
      return next;
    });
  }, [schema]);

  // å›ç­”ã®è‡ªå‹•ä¿å­˜ï¼ˆ800ms ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  const debRef = useRef<number | null>(null);
  useEffect(() => {
    if (debRef.current) window.clearTimeout(debRef.current);
    debRef.current = window.setTimeout(async () => {
      try {
        setSaving(true);
        const res = await fetch('/api/questionnaire/answers/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ author, data: answers }),
        });
        const json = await res.json();
        if (!json?.ok) throw new Error(json?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setSaveMsg('è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ');
        localStorage.setItem(LS_ANS_KEY, JSON.stringify(answers));
      } catch {
        localStorage.setItem(LS_ANS_KEY, JSON.stringify(answers));
        setSaveMsg('ãƒ­ãƒ¼ã‚«ãƒ«ã«è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰');
      } finally {
        setSaving(false);
        setTimeout(() => setSaveMsg(null), 1500);
      }
    }, 800);
    return () => { if (debRef.current) window.clearTimeout(debRef.current); };
  }, [answers, author]);

  const onChangeAnswer = (id: string, val: string) =>
    setAnswers(prev => ({ ...prev, [id]: val }));

  // ã‚¹ã‚­ãƒ¼ãƒä¿å­˜
  const saveSchema = async () => {
    try {
      setErrMsg(null);
      setSaving(true);
      const res = await fetch('/api/questionnaire/schema/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ author, data: schema }),
      });
      const json = await res.json();
      if (!json?.ok) throw new Error(json?.error || 'ã‚¹ã‚­ãƒ¼ãƒä¿å­˜å¤±æ•—');
      localStorage.setItem(LS_SCHEMA_KEY, JSON.stringify(schema));
      setSaveMsg('ã‚¹ã‚­ãƒ¼ãƒã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (e: any) {
      setErrMsg(e?.message ?? 'ã‚¹ã‚­ãƒ¼ãƒä¿å­˜å¤±æ•—');
    } finally {
      setSaving(false);
      setTimeout(() => setSaveMsg(null), 1500);
    }
  };

  // é …ç›®è¿½åŠ 
  const addQuestion = (secId: string) => {
    setSchema(prev => {
      const copy: SchemaData = JSON.parse(JSON.stringify(prev));
      const sec = copy.sections.find(s => s.id === secId)!;
      const newId = `${secId}-q${sec.items.length + 1}`;
      sec.items.push({ id: newId, label: `ã€æ–°è¦é …ç›® ${sec.items.length + 1}ã€‘` });
      return copy;
    });
  };

  return (
    <main
      style={{
        margin: '0 auto',
        maxWidth: 960,
        padding: 24,
        fontFamily: 'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif',
        color: '#111827',
      }}
    >
      <h1 style={{ fontSize: 24, fontWeight: 800, marginBottom: 8 }}>
        è³ªå•ç¥¨ï¼ˆå˜ä¸€ãƒšãƒ¼ã‚¸ãƒ»å¸¸ã«æœ€æ–°ï¼è‡ªå‹•ä¿å­˜ï¼‰
      </h1>
      <p style={{ fontSize: 13, color: '#4b5563', marginBottom: 20 }}>
        Excelã‹ã‚‰å–ã‚Šè¾¼ã‚“ã è³ªå•ã‚’åˆæœŸè¡¨ç¤ºã€‚å›ç­”ã¯è‡ªå‹•ä¿å­˜ï¼ˆAPIçµŒç”±ï¼å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã€‚
      </p>

      {/* ãƒ˜ãƒƒãƒ€ãƒ¼æ“ä½œè¡Œ */}
      <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 20 }}>
        <label style={{ fontSize: 13 }}>ä½œæˆè€…ï¼ˆä»»æ„ï¼‰</label>
        <input
          value={author}
          onChange={(e) => setAuthor(e.target.value)}
          placeholder="ä¾‹ï¼šæ°¸äº•"
          style={{
            border: '1px solid #d1d5db',
            borderRadius: 6,
            padding: '6px 8px',
            width: 220,
            boxSizing: 'border-box',
          }}
        />
        <div style={{ marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 12, fontSize: 13 }}>
          <label style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <input type="checkbox" checked={editing} onChange={(e) => setEditing(e.target.checked)} />
            è³ªå•ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
          </label>
          <button
            onClick={saveSchema}
            disabled={!editing || saving}
            style={{
              padding: '6px 10px',
              borderRadius: 8,
              background: editing && !saving ? '#111827' : '#9ca3af',
              color: '#fff',
              fontWeight: 700,
              border: 'none',
              cursor: editing && !saving ? 'pointer' : 'default',
            }}
          >
            {saving ? 'ä¿å­˜ä¸­â€¦' : 'ã‚¹ã‚­ãƒ¼ãƒä¿å­˜'}
          </button>
        </div>
      </div>

      {/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
      {schema.sections.map((sec) => (
        <section
          key={sec.id}
          style={{
            border: '1px solid #e5e7eb',
            borderRadius: 12,
            padding: 20,
            background: '#fff',
            boxShadow: '0 1px 2px rgba(0,0,0,0.04)',
            marginBottom: 24,
          }}
        >
          {/* ã‚¿ã‚¤ãƒˆãƒ«è¡Œ */}
          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
            {editing ? (
              <input
                value={sec.title}
                onChange={(e) =>
                  setSchema((prev) => {
                    const copy: SchemaData = JSON.parse(JSON.stringify(prev));
                    copy.sections.find((x) => x.id === sec.id)!.title = e.target.value;
                    return copy;
                  })
                }
                style={{
                  fontSize: 18,
                  fontWeight: 700,
                  border: '1px solid #d1d5db',
                  borderRadius: 8,
                  padding: '8px 10px',
                  width: '100%',
                  boxSizing: 'border-box',
                }}
              />
            ) : (
              <h2 style={{ fontSize: 18, fontWeight: 700, margin: 0 }}>{sec.title}</h2>
            )}
            {editing && (
              <button
                onClick={() => addQuestion(sec.id)}
                style={{
                  fontSize: 13,
                  padding: '6px 10px',
                  border: '1px solid #d1d5db',
                  background: '#f9fafb',
                  borderRadius: 8,
                  cursor: 'pointer',
                }}
              >
                é …ç›®ã‚’è¿½åŠ 
              </button>
            )}
          </div>

          {/* è¨­å•ç¾¤ */}
          <div>
            {sec.items.map((q) => (
              <div key={q.id} style={{ marginBottom: 20 }}>
                {editing ? (
                  <input
                    value={q.label}
                    onChange={(e) =>
                      setSchema((prev) => {
                        const copy: SchemaData = JSON.parse(JSON.stringify(prev));
                        const s = copy.sections.find((x) => x.id === sec.id)!;
                        const qi = s.items.find((x) => x.id === q.id)!;
                        qi.label = e.target.value;
                        return copy;
                      })
                    }
                    style={{
                      display: 'block',
                      width: '100%',
                      boxSizing: 'border-box',
                      marginBottom: 8,
                      padding: '8px 10px',
                      border: '1px solid #d1d5db',
                      borderRadius: 6,
                      fontWeight: 700,
                    }}
                  />
                ) : (
                  <label
                    style={{
                      display: 'block',
                      marginBottom: 8,
                      fontSize: 14,
                      fontWeight: 700,
                      color: '#1f2937',
                    }}
                  >
                    {q.label}
                  </label>
                )}

                <AutoTextarea
                  value={answers[q.id] ?? ''}
                  onChange={(e) => onChangeAnswer(q.id, e.target.value)}
                  placeholder={q.placeholder ?? 'è‡ªç”±è¨˜è¿°'}
                  minRows={3}
                  maxPx={600}
                />
              </div>
            ))}
          </div>
        </section>
      ))}

      {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
      <div style={{ marginTop: 12, fontSize: 13 }}>
        {saveMsg && <span style={{ color: '#059669', marginRight: 12 }}>{saveMsg}</span>}
        {errMsg && <span style={{ color: '#dc2626' }}>{errMsg}</span>}
      </div>
    </main>
  );
}
</file>

<file path="pages/rules.tsx">
import Head from "next/head";

export default function Rules() {
  return (
    <>
      <Head>
        <title>Tiara é–‹ç™ºãƒ«ãƒ¼ãƒ«</title>
      </Head>
      <main style={{ fontFamily: "system-ui, sans-serif", padding: "2rem" }}>
        <h1>âš™ï¸ Tiara é–‹ç™ºãƒ«ãƒ¼ãƒ« v1.0</h1>
        <p>
          ç›®çš„ï¼šå¹´å†…MVPï¼ˆã‚­ãƒ£ã‚¹ãƒˆPWA + ã‚¨ãƒ³ãƒ‰/ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ã‚’
          å®‰å®šãƒ»å®‰å…¨ãƒ»ç´ æ—©ãå±Šã‘ã‚‹ã€‚ä»¥å¾Œã®æ¨ªå±•é–‹ãƒ»AIãƒãƒƒãƒãƒ³ã‚°æ‹¡å¼µã‚’è¦‹æ®ãˆãŸä½œã‚Šã«ã™ã‚‹ã€‚
        </p>

        <h2>0.å‰æ</h2>
        <ul>
          <li>ã‚¤ãƒ³ãƒ•ãƒ©: VPS / Linux</li>
          <li>Backend: NestJS + Prisma + PostgreSQL16</li>
          <li>Storage: Amazon S3ï¼ˆprivate, SSE, ç½²åä»˜ãURLï¼‰</li>
          <li>èªè¨¼: ã‚­ãƒ£ã‚¹ãƒˆ=LINE OIDCã€ã‚¨ãƒ³ãƒ‰/ç®¡ç†=Email+PW+JWT</li>
          <li>RBAC: è¤‡æ•°ãƒ­ãƒ¼ãƒ«ï¼ˆroles / user_rolesï¼‰</li>
          <li>ãƒãƒ£ãƒƒãƒˆ: Chatwootï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰</li>
          <li>å‹¤æ€ : MosPã¯å°†æ¥é€£æºã€MVPã¯è‡ªå‰shifts</li>
        </ul>

        <h2>1. ãƒªãƒã‚¸ãƒˆãƒª / ãƒ–ãƒ©ãƒ³ãƒ / ãƒªãƒªãƒ¼ã‚¹</h2>
        <ul>
          <li>å˜ä¸€ãƒ¢ãƒãƒ¬ãƒæ¨å¥¨</li>
          <li>Trunk-Basedé–‹ç™ºã€Conventional Commits</li>
          <li>PRã¯å°ã•ãã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆã€CI greenå¿…é ˆ</li>
          <li>ã‚¿ã‚°/ãƒªãƒªãƒ¼ã‚¹: vX.Y.Z</li>
        </ul>

        <h2>2. ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ï¼ˆå…±é€šï¼‰</h2>
        <ul>
          <li>TypeScript 5+</li>
          <li>Lint: ESLint + Prettier</li>
          <li>å‘½å: camelCase, PascalCase, snake_case</li>
          <li>DB: UTCæ™‚åˆ»ã€created_at/updated_atå¿…é ˆ</li>
          <li>ãƒ•ã‚¡ã‚¤ãƒ«/ç”»åƒã¯S3ã€ã‚µãƒ¼ãƒç›´ç½®ãç¦æ­¢</li>
        </ul>

        <h2>3. Backendï¼ˆNestJSï¼‰</h2>
        <ul>
          <li>å±¤æ§‹æˆ: controller â†’ service â†’ repository(prisma)</li>
          <li>DTOã¯class-validatorå¿…é ˆ</li>
          <li>API: /api/v1, ãƒšãƒ¼ã‚¸ãƒ³ã‚°30ä»¶å›ºå®š</li>
          <li>èªè¨¼: JWTã€èªå¯: Guard+RBAC</li>
          <li>ç›£æŸ»ãƒ­ã‚°: é‡è¦æ“ä½œã¯å·®åˆ†ä¿å­˜</li>
          <li>S3: ç½²åä»˜ãURL TTL=10åˆ†ã€èº«åˆ†è¨¼ã¯90æ—¥ã§å‰Šé™¤</li>
        </ul>

        <h2>4. ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆï¼ˆDBï¼‰</h2>
        <ul>
          <li>ERDã‚’å”¯ä¸€ã®çœŸå®Ÿæºã¨ã™ã‚‹</li>
          <li>ID: UUID v4ã€å¤–éƒ¨IDã¯åˆ¥åˆ—ã§unique</li>
          <li>æ¤œç´¢åˆ—ã«indexä»˜ä¸</li>
        </ul>

        <h2>5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</h2>
        <ul>
          <li>Cast PWA: Next.js/React + TS</li>
          <li>UIã¯ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼æ±ºå®šã‚’å³å®ˆ</li>
          <li>å½“æ—¥å‡ºå‹¤100åã§ã‚‚å¿«é©ã«ï¼ˆä»®æƒ³ãƒªã‚¹ãƒˆæ¤œè¨ï¼‰</li>
          <li>ãƒãƒ£ãƒƒãƒˆUIã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿</li>
        </ul>

        <h2>6. ãƒ†ã‚¹ãƒˆ / å“è³ª</h2>
        <ul>
          <li>Unit=Jest, Integration=Supertest, E2E=å¿œå‹Ÿãƒ•ãƒ­ãƒ¼/å‡ºå‹¤ä¸€è¦§/NGé™¤å¤–</li>
          <li>ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: lines70%, critical path90%</li>
        </ul>

        <h2>7. ãƒ‡ãƒ—ãƒ­ã‚¤ / CI</h2>
        <ul>
          <li>CI: lint â†’ typecheck â†’ test â†’ build â†’ prisma diff</li>
          <li>CD: mainâ†’Stagingè‡ªå‹•ã€Prodã¯æ‰‹å‹•æ‰¿èª</li>
          <li>ç›£è¦–: /health, /ready</li>
        </ul>

        <h2>8. ç›£è¦–ãƒ»é‹ç”¨</h2>
        <ul>
          <li>ãƒ­ã‚°: JSONæ§‹é€ åŒ–ã€ç›¸é–¢ID</li>
          <li>ãƒ¡ãƒˆãƒªã‚¯ã‚¹: Prometheus</li>
          <li>ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°: OpenTelemetry</li>
          <li>SLA: LINEã‚¤ãƒ™ãƒ³ãƒˆâ†’åæ˜  â‰¤10ç§’</li>
        </ul>

        <h2>9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å€‹äººæƒ…å ±</h2>
        <ul>
          <li>S3 IAMã¯ç™ºè¡Œå°‚ç”¨ã€DBã¯å°‚ç”¨ãƒ¦ãƒ¼ã‚¶</li>
          <li>èº«åˆ†è¨¼ã¯æ‰€å®šæœŸé–“ã§å‰Šé™¤</li>
          <li>NG/æŒ‡åæ“ä½œã¯ç›£æŸ»ãƒ­ã‚°å¿…é ˆ</li>
        </ul>

        <h2>10. API ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´„</h2>
        <ul>
          <li>ãƒ™ãƒ¼ã‚¹: /api/v1</li>
          <li>èªè¨¼: Bearer JWT</li>
          <li>ãƒšãƒ¼ã‚¸ãƒ³ã‚°30ä»¶å›ºå®š</li>
          <li>æ—¥ä»˜ã¯ISO8601 UTC</li>
          <li>ã‚¨ãƒ©ãƒ¼å½¢å¼: {"{ error_code, message, details? }"}</li>
        </ul>

        <h2>11. Definition of Done</h2>
        <ul>
          <li>ERD/Swaggeræ›´æ–°æ¸ˆ</li>
          <li>Lint/Typecheck/Test/Buildé€šé</li>
          <li>å…¥åŠ›æ¤œè¨¼+èªå¯Guard+ç›£æŸ»ãƒ­ã‚°ã‚ã‚Š</li>
          <li>ç›£è¦–ç³»ï¼ˆãƒ­ã‚°/ãƒ¡ãƒˆãƒªã‚¯ã‚¹/HCï¼‰æ•´å‚™æ¸ˆ</li>
        </ul>

        <h2>12. PRãƒ¬ãƒ“ãƒ¥ãƒ¼ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
        <ul>
          <li>ä»•æ§˜å·®åˆ†ãŒPRã«å«ã¾ã‚Œã‚‹</li>
          <li>å…¥åŠ›æ¤œè¨¼ãƒ»èªå¯ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹</li>
          <li>ãƒšãƒ¼ã‚¸ãƒ³ã‚°/æ¤œç´¢ãŒæ•´åˆã—ã¦ã„ã‚‹</li>
          <li>S3ç›´ãƒªãƒ³ã‚¯ä¿å­˜ã—ã¦ã„ãªã„</li>
          <li>ãƒ­ã‚°ã«å€‹äººæƒ…å ±ã‚’å‡ºã—ã¦ã„ãªã„</li>
        </ul>

        <h2>13. ç’°å¢ƒå¤‰æ•°ï¼ˆä¾‹ï¼‰</h2>
        <pre>
{`NODE_ENV=production
PORT=8080
DATABASE_URL=postgresql://...
JWT_SECRET=...
LINE_CHANNEL_ID=...
LINE_CHANNEL_SECRET=...
S3_BUCKET=tiara-private
S3_REGION=ap-northeast-1
S3_ACCESS_KEY_ID=...
S3_SECRET_ACCESS_KEY=...
CHATWOOT_BASE_URL=...
CHATWOOT_API_TOKEN=...`}
        </pre>

        <h2>14. å¤‰æ›´æ‰‹ç¶šã</h2>
        <ul>
          <li>Issue â†’ ADR â†’ PRã®é †ã§åæ˜ </li>
          <li>é‡å¤§å¤‰æ›´ã¯ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼‹ç§»è¡Œæ‰‹é †å¿…é ˆ</li>
        </ul>
      </main>
    </>
  );
}
</file>

<file path="pages/wbs.tsx">
// pages/wbs.tsx
import Head from "next/head";
import dynamic from "next/dynamic";
import { useEffect, useMemo, useState } from "react";
import dayjs from "dayjs";
import { loadTasks, type Task } from "../lib/tasksLoader";

// å…¥åŠ›ã‚†ã‚Œã‚’ YYYY-MM-DD ã«æ­£è¦åŒ–ï¼ˆã§ããªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™ï¼‰
const normalizeDateInput = (raw: string) => {
  if (!raw) return "";
  let s = raw.trim();
  s = s.replace(/[./]/g, "-");
  const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (m) return `${m[1]}-${m[2].padStart(2, "0")}-${m[3].padStart(2, "0")}`;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  return s;
};

// å³å¯†ã« YYYY-MM-DD ã®ã¨ãã®ã¿ Dayjs ã‚’è¿”ã™ï¼ˆåˆ¤åˆ¥ä¸èƒ½ã¯ nullï¼‰
const ymd = (s?: string) =>
  s && /^\d{4}-\d{2}-\d{2}$/.test(s) ? dayjs(s).startOf("day") : null;

const calcProgress = (t: Task) => (t.done ? 100 : t.started ? 50 : 0);

const isStarted = (t: Task) => {
  if (t.done) return true;
  const startD = ymd(t.start);
  const today = dayjs().startOf("day");
  if (startD && startD.isAfter(today)) return false;
  if (t.started) return true;
  if (startD && !startD.isAfter(today)) return true;
  return false;
};

const overlaps = (start?: string, end?: string, wkStart?: dayjs.Dayjs, wkEnd?: dayjs.Dayjs) => {
  if (!start && !end) return false;
  const sD = ymd(start) ?? dayjs("1900-01-01");
  const eD = ymd(end) ?? dayjs("2999-12-31");
  return sD.isBefore(wkEnd!) && eD.isAfter(wkStart!);
};

function WbsPageInner() {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      try {
        const data = await loadTasks();
        const normalized = data.map((t) => ({
          ...t,
          start: t.start ? normalizeDateInput(t.start) : "",
          end: t.end ? normalizeDateInput(t.end) : "",
          started: isStarted(t),
          done: !!t.done,
          progress: t.progress ?? calcProgress(t),
        }));
        setTasks(normalized);
        setLoading(false);
      } catch (e: any) {
        setError(e?.message || "èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        setLoading(false);
      }
    })();
  }, []);

  const saveTasks = async (next: Task[]) => {
    setTasks(next);
    await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(next),
    });
  };

  const patchTask = (idx: number, patch: Partial<Task>) => {
    const next = tasks.map((t, i) => {
      if (i !== idx) return t;
      let updated = { ...t, ...patch };
      if (patch.start !== undefined) updated.start = normalizeDateInput(patch.start || "");
      if (patch.end !== undefined) updated.end = normalizeDateInput(patch.end || "");
      if (patch.done !== undefined) {
        if (patch.done && !t.done && !updated.end) updated.end = dayjs().format("YYYY-MM-DD");
        if (!patch.done && t.done) updated.end = "";
      }
      if (patch.started !== undefined) {
        if (patch.started && !t.started && !updated.start) updated.start = dayjs().format("YYYY-MM-DD");
        if (!patch.started && t.started) updated.start = "";
      }
      updated.started = isStarted(updated);
      updated.progress = calcProgress(updated);
      return updated;
    });
    saveTasks(next);
  };

  const summary = useMemo(() => {
    if (tasks.length === 0) return { avg: 0, total: 0, started: 0, finished: 0 };
    const total = tasks.length;
    const started = tasks.filter((t) => isStarted(t)).length;
    const finished = tasks.filter((t) => t.done).length;
    const avg = Math.round(tasks.reduce((acc, t) => acc + (t.progress ?? calcProgress(t)), 0) / total);
    return { avg, total, started, finished };
  }, [tasks]);

  const now = dayjs();
  const thisWeekStart = now.startOf("week");
  const thisWeekEnd = now.endOf("week");
  const nextWeekStart = now.add(1, "week").startOf("week");
  const nextWeekEnd = now.add(1, "week").endOf("week");

  const tasksThisWeek = tasks.filter((t) => overlaps(t.start, t.end, thisWeekStart, thisWeekEnd));
  const tasksNextWeek = tasks.filter((t) => overlaps(t.start, t.end, nextWeekStart, nextWeekEnd));

  return (
    <>
      <Head><title>WBSã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</title></Head>
      <main style={{ fontFamily: "system-ui, sans-serif", padding: "2rem" }}>
        <h1>ğŸ“Š WBSã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h1>

        {loading && <p>èª­ã¿è¾¼ã¿ä¸­...</p>}
        {error && <p style={{ color: "crimson" }}>ã‚¨ãƒ©ãƒ¼ï¼š{error}</p>}

        {!loading && !error && (
          <>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(4, minmax(0, 1fr))", gap: 12, margin: "16px 0" }}>
              <Card title="å¹³å‡é€²æ—"><Big>{summary.avg}%</Big></Card>
              <Card title="ã‚¿ã‚¹ã‚¯ç·æ•°"><Big>{summary.total}</Big></Card>
              <Card title="é–‹å§‹æ¸ˆã¿"><Big>{summary.started}</Big></Card>
              <Card title="å®Œäº†æ¸ˆã¿"><Big>{summary.finished}</Big></Card>
            </div>

            <section style={{ marginTop: 8 }}>
              <h2>ğŸ—“ ä»Šé€±ï¼ˆ{thisWeekStart.format("YYYY/MM/DD")} - {thisWeekEnd.format("YYYY/MM/DD")}ï¼‰</h2>
              {tasksThisWeek.length === 0 ? <p style={{ color: "#6b7280" }}>è©²å½“ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p> : (
                <ul>{tasksThisWeek.map((t, i) => <li key={i}>{t.title}ï¼ˆ{t.start || "â€”"} â†’ {t.end || "â€”"}ï¼‰{t.done ? " âœ…" : isStarted(t) ? " â–¶ï¸" : ""}</li>)}</ul>
              )}
            </section>

            <section style={{ marginTop: 16 }}>
              <h2>ğŸ—“ æ¥é€±ï¼ˆ{nextWeekStart.format("YYYY/MM/DD")} - {nextWeekEnd.format("YYYY/MM/DD")}ï¼‰</h2>
              {tasksNextWeek.length === 0 ? <p style={{ color: "#6b7280" }}>è©²å½“ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p> : (
                <ul>{tasksNextWeek.map((t, i) => <li key={i}>{t.title}ï¼ˆ{t.start || "â€”"} â†’ {t.end || "â€”"}ï¼‰{t.done ? " âœ…" : isStarted(t) ? " â–¶ï¸" : ""}</li>)}</ul>
              )}
            </section>

            <h2 style={{ marginTop: 32 }}>ğŸ“ ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆæœŸé–“å…¥åŠ›ãƒ»é–‹å§‹/åœæ­¢ãƒ»å®Œäº†ã®æ‰‹å‹•æ›´æ–°ï¼‰</h2>
            <div style={{ display: "grid", gap: 8, marginTop: 8 }}>
              {tasks.map((t, i) => (
                <div key={i} style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 10, padding: 12 }}>
                  <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                    <div style={{ fontWeight: 700, flex: 1 }}>{t.title}</div>
                    <div style={{ fontSize: 12, color: "#6b7280" }}>é€²æ—: <strong>{t.progress ?? 0}%</strong></div>
                  </div>
                  <div style={{ display: "flex", gap: 10, alignItems: "center", marginTop: 8 }}>
                    <label>
                      é–‹å§‹
                      <input
                        type="text"
                        placeholder="YYYY-MM-DD"
                        value={t.start || ""}
                        onChange={(e) => patchTask(i, { start: e.target.value })}
                        style={{ marginLeft: 6, padding: "4px 6px", border: "1px solid #d1d5db", borderRadius: 6 }}
                      />
                    </label>
                    <span>â†’</span>
                    <label>
                      çµ‚äº†
                      <input
                        type="text"
                        placeholder="YYYY-MM-DD"
                        value={t.end || ""}
                        onChange={(e) => patchTask(i, { end: e.target.value })}
                        style={{ marginLeft: 6, padding: "4px 6px", border: "1px solid #d1d5db", borderRadius: 6 }}
                      />
                    </label>

                    <button
                      onClick={() =>
                        patchTask(
                          i,
                          isStarted(t)
                            ? { started: false, start: "" }
                            : { started: true, start: t.start || dayjs().format("YYYY-MM-DD") }
                        )
                      }
                      style={{ marginLeft: "auto", padding: "6px 10px", borderRadius: 8, border: "1px solid #d1d5db", background: isStarted(t) ? "#fee2e2" : "#dbeafe", fontWeight: 600 }}
                    >
                      {isStarted(t) ? "â¹ åœæ­¢" : "â–¶ï¸ é–‹å§‹"}
                    </button>

                    <button
                      onClick={() => patchTask(i, { done: !t.done, end: t.done ? "" : t.end || dayjs().format("YYYY-MM-DD") })}
                      style={{ padding: "6px 10px", borderRadius: 8, border: "1px solid #d1d5db", background: t.done ? "#dcfce7" : "#f9fafb", fontWeight: 600 }}
                    >
                      {t.done ? "âœ… å®Œäº†" : "å®Œäº†ã«ã™ã‚‹"}
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}
      </main>
    </>
  );
}

function Card(props: { title?: string; children: any }) {
  return (
    <div style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 8, padding: 12, boxShadow: "0 1px 2px rgba(0,0,0,0.04)" }}>
      {props.title && <div style={{ fontSize: 12, color: "#6b7280", marginBottom: 6 }}>{props.title}</div>}
      <div>{props.children}</div>
    </div>
  );
}
function Big(props: { children: any }) {
  return <div style={{ fontSize: 28, fontWeight: 700, color: "#111827" }}>{props.children}</div>;
}
export default dynamic(() => Promise.resolve(WbsPageInner), { ssr: false });
</file>

<file path="public/data/tasks.json">
[
  {
    "title": "ã‚­ãƒƒã‚¯ã‚ªãƒ•ï¼é€²è¡Œä½“åˆ¶ç¢ºå®š",
    "owner": "PM",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 80,
    "start": "2025-09-19",
    "end": "2025-09-29"
  },
  {
    "title": "å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–¹é‡",
    "owner": "Platform",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 70,
    "start": "2025-09-19",
    "end": "2025-09-30"
  },
  {
    "title": "å¯¾è±¡ç¯„å›²ç¢ºå®šï¼ˆå¹´å†…MVPï¼šã‚¨ãƒ³ãƒ‰ç”¨ï¼ã‚­ãƒ£ã‚¹ãƒˆç”¨ï¼‰",
    "owner": "PM",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 60,
    "start": "2025-09-19",
    "end": "2025-09-30"
  },

  // ===== Epic A: èªè¨¼ï¼IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é‹ç”¨ï¼ˆå…±é€šåŸºç›¤ï¼‰ =====
  {
    "title": "A-1: DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆusers/casts/password_reset_tokensï¼‰",
    "owner": "Backend",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 30,
    "start": "2025-09-28",
    "end": "2025-10-01"
  },
  {
    "title": "A-1-1: users.login_id ã‚’ CI UNIQUEï¼ˆcitextï¼‰ã«å¤‰æ›´",
    "owner": "Backend",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 50,
    "start": "2025-09-28",
    "end": "2025-09-30"
  },
  {
    "title": "A-1-2: casts.cast_code è¿½åŠ ï¼ˆA000..A999â†’B000..ï¼ä¸å¤‰ï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-09-29",
    "end": "2025-10-01"
  },
  {
    "title": "A-1-3: password_reset_tokens æ–°è¨­ï¼ˆæœŸé™ãƒ»ä½¿ç”¨æ¸ˆç®¡ç†ï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-09-30",
    "end": "2025-10-01"
  },
  {
    "title": "A-2: cast_code è‡ªå‹•æ¡ç•ªAPIï¼ˆç«¶åˆé˜²æ­¢ï¼†immutableï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-01",
    "end": "2025-10-03"
  },
  {
    "title": "A-3: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ•ãƒ­ãƒ¼ï¼ˆãƒ¡ãƒ¼ãƒ«/LINEä¸¡å¯¾å¿œï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-02",
    "end": "2025-10-05"
  },
  {
    "title": "A-4: must_change_password ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼ˆåˆå›/å†ç™ºè¡Œæ™‚ï¼‰",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-03",
    "end": "2025-10-06"
  },
  {
    "title": "A-5: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ï¼ˆè‹±å¤§/å°/æ•°å­—ï¼‰UI+APIãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-03",
    "end": "2025-10-06"
  },

  // ===== Epic B: ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ï¼ˆæ‹¡å¼µï¼‰ =====
  {
    "title": "B-1: cast_attributes.drink_level æ¤œç´¢UI/API",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-06",
    "end": "2025-10-09"
  },
  {
    "title": "B-2: cast_photos è¤‡æ•°å†™çœŸï¼‹ä¸¦ã³æ›¿ãˆï¼ˆsort_orderï¼‰",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-06",
    "end": "2025-10-10"
  },

  // ===== Epic C: åº—èˆ—è¦ä»¶ãƒ»KPI =====
  {
    "title": "C-1: shop_requirements CRUD + åº—èˆ—è©³ç´°ã‚¿ãƒ–",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-09",
    "end": "2025-10-12"
  },
  {
    "title": "C-2: KPIã‚«ãƒ¼ãƒ‰ï¼ˆå¿…è¦äººæ•°/å……è¶³ç‡ï¼‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-12",
    "end": "2025-10-15"
  },

  // ===== Epic D: å›ºå®šé…å± =====
  {
    "title": "D-1: shop_fixed_casts CRUD + å„ªå…ˆè¡¨ç¤ºãƒ«ãƒ¼ãƒ«",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-15",
    "end": "2025-10-18"
  },

  // ===== Epic E: ã‚·ãƒ•ãƒˆï¼å‡ºé€€å‹¤ =====
  {
    "title": "E-1: å½“æ—¥ã‚·ãƒ•ãƒˆ read-onlyï¼ˆGET /shiftsï¼‰",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-09",
    "end": "2025-10-11"
  },
  {
    "title": "E-2: ã‚·ãƒ•ãƒˆæ‰¿èªï¼ˆplannedâ†’approvedï¼‰APIï¼‹UI",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-11",
    "end": "2025-10-14"
  },
  {
    "title": "E-3: æ‰¿èªæ™‚ã®ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ï¼ˆaudit_logs.diffï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-14",
    "end": "2025-10-15"
  },
  {
    "title": "E-4: å‡ºé€€å‹¤ read-onlyï¼ˆattendancesï¼‰",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-15",
    "end": "2025-10-18"
  },

  // ===== Epic F: å¿œå‹Ÿæ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
  {
    "title": "F-1: /applications/:id/docs presign API",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-12",
    "end": "2025-10-14"
  },
  {
    "title": "F-2: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UIçµ±åˆï¼ˆé€²æ—ãƒ»å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-14",
    "end": "2025-10-16"
  },

  // ===== Epic G: LINEãƒªãƒ¬ãƒ¼åŸºç›¤ï¼ˆä¸‹åœ°ï¼‰ =====
  {
    "title": "G-1: line_webhook_events ç”Ÿãƒ­ã‚°ä¿å­˜ï¼ˆé‡è¤‡å¯¾ç­–ï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-18",
    "end": "2025-10-20"
  },
  {
    "title": "G-2: line_messages æ­£è¦åŒ–ï¼ˆin/out/type/payloadï¼‰",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-10-20",
    "end": "2025-10-22"
  },

  // ===== Epic H: ãƒãƒ¼ã‚¿ãƒ«æ•´å‚™ï¼DevEx =====
  {
    "title": "H-1: é–‹ç™ºãƒãƒ¼ã‚¿ãƒ«ERDå›³ï¼é–‹ç™ºãƒ«ãƒ¼ãƒ«ã®æœ€æ–°ç‰ˆåæ˜ ",
    "owner": "PM",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 40,
    "start": "2025-09-28",
    "end": "2025-09-30"
  },
  {
    "title": "H-2: /wbs åæ˜ ï¼ˆã‚¿ã‚¹ã‚¯ç²’åº¦ãƒ»ç« ç«‹ã¦æ›´æ–°ï¼‰",
    "owner": "Frontend",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 40,
    "start": "2025-09-28",
    "end": "2025-09-30"
  },

  // ===== ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒªãƒªãƒ¼ã‚¹ï¼ˆç¾è¡Œè¨ˆç”»ã«åˆã‚ã›å†é…ç½®ï¼‰ =====
  {
    "title": "ãƒ‡ãƒ¼ã‚¿å—é ˜ï¼ˆå…ˆæ–¹ã‹ã‚‰ä¾å­˜ï¼‰",
    "owner": "PM",
    "status": "In Progress",
    "started": true,
    "done": false,
    "progress": 50,
    "start": "2025-09-19",
    "end": "2025-10-20"
  },
  {
    "title": "ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-11-03",
    "end": "2025-11-10"
  },
  {
    "title": "å–è¾¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼æ¤œè¨¼",
    "owner": "Backend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-11-17",
    "end": "2025-11-24"
  },
  {
    "title": "å˜ä½“ãƒ†ã‚¹ãƒˆ",
    "owner": "QA",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-11-24",
    "end": "2025-12-01"
  },
  {
    "title": "E2Eãƒ†ã‚¹ãƒˆ",
    "owner": "QA",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-11-24",
    "end": "2025-12-01"
  },
  {
    "title": "æ€§èƒ½ãƒ†ã‚¹ãƒˆ",
    "owner": "QA",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-01",
    "end": "2025-12-08"
  },
  {
    "title": "ã‚¯ãƒ­ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶ï¼ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–",
    "owner": "Frontend",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-01",
    "end": "2025-12-08"
  },
  {
    "title": "UATï¼ˆãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‚åŠ ï¼‰",
    "owner": "PM",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-08",
    "end": "2025-12-15"
  },
  {
    "title": "ç›£è¦–ãƒ»é‹ç”¨Runbook",
    "owner": "Platform",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-08",
    "end": "2025-12-15"
  },
  {
    "title": "ç®¡ç†è€…ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°",
    "owner": "PM",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-08",
    "end": "2025-12-15"
  },
  {
    "title": "æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤",
    "owner": "Platform",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-22",
    "end": "2025-12-29"
  },
  {
    "title": "ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆ",
    "owner": "PM",
    "status": "Planned",
    "started": false,
    "done": false,
    "progress": 0,
    "start": "2025-12-22",
    "end": "2025-12-29"
  }
]
</file>

<file path="scripts/seed.ts">
import { config } from 'dotenv';
import path from 'node:path';
import type {
  PostgrestSingleResponse,
  PostgrestMaybeSingleResponse,
} from '@supabase/supabase-js';
config({ path: path.resolve(process.cwd(), '.env.local') });

import { supabaseAdmin } from '@/lib/db';

function jstOffsetDate(hoursFromNow = 0) {
  const now = new Date();
  const t = new Date(now.getTime() + hoursFromNow * 3600 * 1000);
  return t.toISOString();
}

type StoreRow = { id: string };
type CastInsert = {
  name: string;
  nickname?: string;
  store_id?: string | null;
  wage?: number | null;
  rating?: number | null;
  genre?: string[] | null;
  drinkable?: boolean | null;
  owner?: string | null;
};
type CastRow = { id: string; wage?: number | null };

/** stores.name ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã¨ã—ã¦ç¢ºå®Ÿã« upsertï¼ˆ23505 æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
async function upsertStoreByName(input: {
  name: string;
  address?: string | null;
  phone?: string | null;
}): Promise<StoreRow> {
  const name = input.name.trim();

  // ã¾ãšã¯æ­£æ”»æ³•ã® upsertï¼ˆå‹ã¯æ˜ç¤ºã‚­ãƒ£ã‚¹ãƒˆã§å›ºå®šï¼‰
  const up = (await supabaseAdmin!
    .from('stores')
    .upsert([{ name, address: input.address ?? null, phone: input.phone ?? null }], {
      onConflict: 'name',
      ignoreDuplicates: false,
    })
    .select('id')
    .single()) as PostgrestSingleResponse<StoreRow>;

  // â‘  æˆåŠŸãƒ‘ã‚¹
  if (up.data) return up.data;

  // â‘¡ 23505ï¼ˆé‡è¤‡ã‚­ãƒ¼ï¼‰ã ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (up.error && (up.error as any).code === '23505') {
    const ex = (await supabaseAdmin!
      .from('stores')
      .select('id')
      .eq('name', name)
      .maybeSingle()) as PostgrestMaybeSingleResponse<StoreRow>;
    if (ex.error) throw ex.error;

    if (ex.data) {
      const upd = (await supabaseAdmin!
        .from('stores')
        .update({ address: input.address ?? null, phone: input.phone ?? null })
        .eq('id', ex.data.id)
        .select('id')
        .single()) as PostgrestSingleResponse<StoreRow>;
      if (upd.error) throw upd.error;
      return upd.data!;
    } else {
      const ins = (await supabaseAdmin!
        .from('stores')
        .insert({ name, address: input.address ?? null, phone: input.phone ?? null })
        .select('id')
        .single()) as PostgrestSingleResponse<StoreRow>;
      if (ins.error) throw ins.error;
      return ins.data!;
    }
  }

  // â‘¢ ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ãã®ã¾ã¾æŠ•ã’ã‚‹ï¼ãƒ‡ãƒ¼ã‚¿ãªã—ã¯ç•°å¸¸
  if (up.error) throw up.error;
  throw new Error('Store upsert returned no data');
}

async function main() {
  if (!supabaseAdmin) throw new Error('SUPABASE_SERVICE_ROLE_KEY is required to seed.');

  // stores ã¯ name ä¸€æ„ã§ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆ
  const store = await upsertStoreByName({
    name: 'ä¸­æ´²æœ¬åº—',
    address: 'ç¦å²¡å¸‚åšå¤šåŒºä¸­æ´²',
    phone: '092-000-0000',
  });

  const casts: CastInsert[] = [
    {
      name: 'ã•ãã‚‰',
      nickname: 'Sakura',
      store_id: store.id,
      wage: 2500,
      rating: 4.5,
      genre: ['ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼'],
      drinkable: true,
      owner: 'Tiara',
    },
    {
      name: 'ã‚Šã‚“',
      nickname: 'Rin',
      store_id: store.id,
      wage: 2200,
      rating: 4.1,
      genre: ['æ–°äºº'],
      drinkable: false,
      owner: 'Tiara',
    },
  ];

  // casts ã¯ (store_id, name) ã§è¡çªæ›´æ–°
  // pay_rate ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«ä½¿ã†ãŸã‚ wage ã‚‚ä¸€ç·’ã«å–å¾—
  const { data: castRows, error: cErr } = (await supabaseAdmin
    .from('casts')
    .upsert(casts, { onConflict: 'store_id,name', ignoreDuplicates: false })
    .select('id,wage')) as unknown as { data: CastRow[]; error: any };
  if (cErr) throw cErr;

  // â˜… shifts ã‚’ upsert åŒ–ï¼ˆcast_id, starts_at ã‚’ä¸€æ„ã‚­ãƒ¼ã¨ã™ã‚‹ï¼‰
  // å…ˆã« 0002c ã§ UNIQUE (cast_id, starts_at) ã‚’å…¥ã‚Œã¦ãŠãã¨ã‚ˆã‚Šå®‰å…¨ã§ã™ã€‚
  const starts1 = jstOffsetDate(1);
  const ends1 = jstOffsetDate(5);
  const shiftRows = (castRows ?? []).map((c: CastRow) => ({
    cast_id: c.id,
    store_id: store.id,
    starts_at: starts1,
    ends_at: ends1,
    status: 'scheduled',
    role: 'cast',                         // 0003 ã®è¿½åŠ åˆ—ã«åˆã‚ã›ã‚‹
    pay_rate: c.wage ?? null,             // â† ãã®æ™‚ç‚¹ã®æ™‚çµ¦ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    memo: 'seed',                         // â† è¿½è·¡ç”¨
  }));
  if (shiftRows.length) {
    const { error: sErr } = await supabaseAdmin
      .from('shifts')
      .upsert(shiftRows, { onConflict: 'cast_id,starts_at', ignoreDuplicates: false });
    if (sErr) throw sErr;
  }

  console.log('Seed completed:', {
    store: store.id,
    casts: castRows?.length ?? 0,
    shifts: shiftRows.length,
  });
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
</file>

<file path=".gitignore">
# Node/Next
node_modules/
.next/
out/
.vercel/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-lock.yaml # â†å¿…è¦ãªã‚‰æ®‹ã™
package-lock.json # â†å¿…è¦ãªã‚‰æ®‹ã™

# OS / IDE
.DS_Store
*.swp

# Env
.env*
.vercel

# local only
.env.local
audit.json
</file>

<file path="tsconfig.json">
{
    "compilerOptions": {
      "target": "es2017",
      "lib": ["dom", "dom.iterable", "esnext"],
      "allowJs": false,
      "skipLibCheck": true,
      "strict": true,
      "forceConsistentCasingInFileNames": true,
      "noEmit": true,
      "esModuleInterop": true,
      "module": "esnext",
      "moduleResolution": "bundler",
      "resolveJsonModule": true,
      "isolatedModules": true,
      "jsx": "preserve",
      "incremental": true,
      "types": ["node", "react", "react-dom"],
  
      /* â˜… è¿½åŠ ï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ç”¨ï¼‰ */
      "baseUrl": ".",
      "paths": { "@/*": ["*"] }
    },
    "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
    "exclude": ["node_modules"],
  
    /* â˜… ts-node ã§ seed ç­‰ã‚’å‹•ã‹ã™ãŸã‚ã®ä¸Šæ›¸ãï¼ˆNext ã®è¨­å®šã¯ãã®ã¾ã¾ï¼‰ */
    "ts-node": {
      "compilerOptions": {
        "module": "commonjs",
        "moduleResolution": "node",
        "baseUrl": ".",
        "paths": { "@/*": ["*"] }
      }
    }
  }
</file>

<file path=".github/workflows/api-smoke.yml">
name: API Smoke

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_TELEMETRY_DISABLED: "1"
      NODE_OPTIONS: "--max_old_space_size=2048"
      # ã‚¹ãƒ¢ãƒ¼ã‚¯ã§å©ããƒ™ãƒ¼ã‚¹URLï¼ˆscripts/test-api.sh ãŒèª­ã‚€ï¼‰
      BASE_URL: "http://localhost:3001"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install deps
        run: npm ci

      # æ—©æœŸã« Secrets ãŒç©ºãªã‚‰è½ã¨ã™ï¼ˆä¸­èº«ã¯å‡ºã•ãªã„ï¼‰
      - name: Verify required env
        shell: bash
        run: |
          set -euo pipefail
          required=(NEXT_PUBLIC_SUPABASE_URL NEXT_PUBLIC_SUPABASE_ANON_KEY SUPABASE_SERVICE_ROLE_KEY)
          for k in "${required[@]}"; do
            if [ -z "${!k}" ]; then
              echo "::error title=Missing secret::${k} is not set in repository Secrets"
              exit 1
            fi
          done
          echo "All required env present."

      - name: Build (production)
        run: npm run build

      - name: Start server (port 3001)
        shell: bash
        run: |
          set -euo pipefail
          nohup npm run start -- -p 3001 >/tmp/next.log 2>&1 &
          echo $! > /tmp/next.pid
          # èµ·å‹•å¾…ã¡ï¼ˆæœ€å¤§60ç§’ï¼‰
          for i in $(seq 1 60); do
            if curl -sf http://localhost:3001/api/casts >/dev/null; then
              echo "Server is up on :3001."
              exit 0
            fi
            sleep 1
          done
          echo "::error title=Server did not start in time::see /tmp/next.log"
          tail -n 200 /tmp/next.log || true
          exit 1

      - name: Smoke tests
        run: bash scripts/test-api.sh

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: next-log
          path: /tmp/next.log
</file>

<file path="pages/api/shifts/index.ts">
// /pages/api/shifts/index.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { supabaseAdmin as supabase } from '@/lib/db';

const SORTS = new Set(['starts_at', 'ends_at', 'created_at', 'updated_at', 'pay_rate']);
const STATUSES = new Set(['scheduled','confirmed','finished','canceled']);
const ROLES = new Set(['cast','manager','other']);

function parseDate(v?: string) {
  if (!v) return undefined;
  const t = Date.parse(v);
  return Number.isNaN(t) ? undefined : new Date(t).toISOString();
}

async function logAudit(action: string, payload: any, entity = 'shift', entity_id?: string) {
  try {
    await supabase!.from('audit_logs').insert({
      actor: 'api',
      action,
      entity,
      entity_id: entity_id ?? null,
      payload,
    });
  } catch {
    /* ç›£æŸ»ãƒ­ã‚°å¤±æ•—ã¯APIçµæœã«å½±éŸ¿ã•ã›ãªã„ */
  }
}

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (!supabase) return res.status(500).json({ ok: false, error: 'Service role is not configured' });

  if (req.method === 'GET') {
    // -------- GET (æ—¢å­˜) --------
    const {
      store_id,
      cast_id,
      status, // scheduled/confirmed/canceled/finished
      role,   // 'cast' ãªã©
      from,
      to,
      page = '1',
      limit = '30',
      sort = 'starts_at',
      expand = '',
    } = req.query as Record<string, string>;

    const pageNum = Math.max(1, parseInt(String(page), 10) || 1);
    const limitNum = Math.min(100, Math.max(1, parseInt(String(limit), 10) || 30));
    const start = parseDate(from);
    const end = parseDate(to);
    const rFrom = (pageNum - 1) * limitNum;
    const rTo = rFrom + limitNum - 1;

    const expandSet = new Set(
      String(expand).split(',').map((s) => s.trim()).filter(Boolean)
    );
    const withNames = expandSet.has('names');

    // count
    let cq = supabase.from('shifts').select('*', { count: 'exact', head: true });
    if (store_id) cq = cq.eq('store_id', store_id);
    if (cast_id) cq = cq.eq('cast_id', cast_id);
    if (status) cq = cq.eq('status', status);
    if (role) cq = cq.eq('role', role);
    if (start) cq = cq.gte('starts_at', start);
    if (end) cq = cq.lt('starts_at', end);

    const { count: total, error: cntErr } = await cq;
    if (cntErr) return res.status(500).json({ ok: false, error: cntErr.message });
    if ((total ?? 0) === 0 || rFrom >= (total ?? 0)) {
      return res.status(200).json({ ok: true, items: [], page: pageNum, limit: limitNum, total: total ?? 0, hasNext: false });
    }

    // data
    const selectExpr = withNames ? '*, casts(name), stores(name)' : '*';
    let q = supabase.from('shifts').select(selectExpr);
    if (store_id) q = q.eq('store_id', store_id);
    if (cast_id) q = q.eq('cast_id', cast_id);
    if (status) q = q.eq('status', status);
    if (role) q = q.eq('role', role);
    if (start) q = q.gte('starts_at', start);
    if (end) q = q.lt('starts_at', end);

    if (sort) {
      const parts = sort.split(',').map((s) => s.trim()).filter(Boolean);
      for (const p of parts) {
        const asc = !p.startsWith('-');
        const key = p.replace(/^[+-]/, '');
        if (SORTS.has(key)) q = q.order(key as any, { ascending: asc, nullsFirst: !asc });
      }
    } else {
      q = q.order('starts_at', { ascending: true });
    }

    q = q.range(rFrom, rTo);

    const { data, error } = await q;
    if (error) return res.status(500).json({ ok: false, error: error.message });

    const items = withNames
      ? (data ?? []).map((row: any) => {
          const { casts, stores, ...rest } = row || {};
          return { ...rest, cast_name: casts?.name ?? null, store_name: stores?.name ?? null };
        })
      : data ?? [];

    return res.status(200).json({
      ok: true,
      items,
      page: pageNum,
      limit: limitNum,
      total: total ?? 0,
      hasNext: rTo + 1 < (total ?? 0),
    });
  }

  if (req.method === 'POST') {
    // -------- POSTï¼šcreate/upsert --------
    const {
      id,                 // ä»»æ„ï¼šæŒ‡å®šãŒã‚ã‚Œã°ãã®IDã‚’æ›´æ–°ï¼ˆå­˜åœ¨ã—ãªã„ãªã‚‰ã‚¨ãƒ©ãƒ¼ï¼‰
      cast_id,
      starts_at,
      ends_at,
      store_id = null,
      status = 'scheduled',
      role = 'cast',
      pay_rate = null,
      memo = null,
    } = (req.body ?? {}) as Record<string, any>;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ€å°ï¼‰
    if (!cast_id || !starts_at) {
      return res.status(400).json({ ok: false, error: 'cast_id and starts_at are required' });
    }
    const startsIso = parseDate(starts_at);
    const endsIso = ends_at ? parseDate(ends_at) : null;
    if (!startsIso) return res.status(400).json({ ok: false, error: 'starts_at must be ISO date' });
    if (ends_at && !endsIso) return res.status(400).json({ ok: false, error: 'ends_at must be ISO date' });
    if (status && !STATUSES.has(status)) return res.status(400).json({ ok: false, error: 'invalid status' });
    if (role && !ROLES.has(role)) return res.status(400).json({ ok: false, error: 'invalid role' });

    try {
      let out;

      if (id) {
        // æ˜ç¤ºIDæ›´æ–°ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°404ï¼‰
        const { data: ex, error: exErr } = await supabase.from('shifts').select('id').eq('id', id).maybeSingle();
        if (exErr) return res.status(500).json({ ok: false, error: exErr.message });
        if (!ex) return res.status(404).json({ ok: false, error: 'shift not found' });

        const { data, error } = await supabase
          .from('shifts')
          .update({
            cast_id,
            store_id,
            starts_at: startsIso,
            ends_at: endsIso,
            status,
            role,
            pay_rate,
            memo,
            canceled_at: status === 'canceled' ? new Date().toISOString() : null,
          })
          .eq('id', id)
          .select('*')
          .single();

        if (error) return res.status(500).json({ ok: false, error: error.message });
        out = data;
        await logAudit('update_shift', { id, body: req.body }, 'shift', id);
      } else {
        // id ãªã—ï¼šUNIQUE(cast_id, starts_at) ã§ upsertï¼ˆå®Œå…¨ã«åŒä¸€é–‹å§‹æ™‚åˆ»ãŒå¯¾è±¡ï¼‰
        const payload = [{
          cast_id,
          store_id,
          starts_at: startsIso,
          ends_at: endsIso,
          status,
          role,
          pay_rate,
          memo,
          canceled_at: status === 'canceled' ? new Date().toISOString() : null,
        }];

        const { data, error } = await supabase
          .from('shifts')
          .upsert(payload, { onConflict: 'cast_id,starts_at', ignoreDuplicates: false })
          .select('*')
          .single();

        if (error) return res.status(500).json({ ok: false, error: error.message });
        out = data;
        await logAudit('upsert_shift', { body: req.body }, 'shift', data?.id);
      }

      return res.status(200).json({ ok: true, item: out });
    } catch (e: any) {
      await logAudit('error_shift_post', { error: String(e), body: req.body });
      return res.status(500).json({ ok: false, error: e?.message ?? 'unknown error' });
    }
  }

  return res.status(405).json({ ok: false, error: 'Method Not Allowed' });
}
</file>

<file path="pages/api/casts/index.ts">
import type { NextApiRequest, NextApiResponse } from 'next';
import { supabaseAdmin as supabase } from '@/lib/db';
import { z } from 'zod';

type ApiError = {
  ok: false;
  code: 'VALIDATION_ERROR' | 'DB_ERROR' | 'INTERNAL_ERROR';
  message: string;
};
const bad = (code: ApiError['code'], message: string, status = 400) => ({
  status,
  body: { ok: false, code, message } as ApiError,
});

// ---- GET ç”¨ã®å®šç¾© -----------------------------------------------------------
const SORTS = new Set(['name', 'rating', 'wage', 'created_at', 'updated_at']);

const querySchema = z.object({
  keyword: z.string().optional(),
  owner: z.string().optional(),
  genre: z.string().optional(), // å˜ä¸€å€¤ï¼ˆå¿…è¦ãªã‚‰è¤‡æ•°å¯¾å¿œã¸æ‹¡å¼µï¼‰
  drinkable: z.coerce.boolean().optional(),
  wage_min: z.coerce.number().optional(),
  active: z.coerce.boolean().optional(),
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(30),
  sort: z.string().optional(), // ä¾‹: "rating,-wage,name"
});

// ---- POST ç”¨ã®å®šç¾© ----------------------------------------------------------
const CastCreate = z.object({
  store_id: z.string().uuid(),
  name: z.string().min(1),
  nickname: z.string().optional(),
  wage: z.number().int().min(0).nullable().optional(),
  rating: z.number().min(0).max(5).nullable().optional(),
  genre: z.array(z.string()).nullable().optional(),
  drinkable: z.boolean().nullable().optional(),
  owner: z.string().nullable().optional(),
  // å°†æ¥è¿½åŠ ã‚«ãƒ©ãƒ ãŒæ¥ã¦ã‚‚è½ã¨ã•ãªã„ã‚ˆã†ã«
}).strict();

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (!supabase) {
    const e = bad('INTERNAL_ERROR', 'Service role is not configured', 500);
    return res.status(e.status).json(e.body);
  }

  // ------------------------ POST /api/casts ------------------------
  if (req.method === 'POST') {
    const parsed = CastCreate.safeParse(req.body);
    if (!parsed.success) {
      const e = bad('VALIDATION_ERROR', JSON.stringify(parsed.error.issues, null, 2), 400);
      return res.status(e.status).json(e.body);
    }
    const input = parsed.data;

    // stores FK äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã° 404ï¼‰
    const { data: st, error: stErr } = await supabase
      .from('stores')
      .select('id')
      .eq('id', input.store_id)
      .maybeSingle();
    if (stErr) {
      const e = bad('DB_ERROR', stErr.message, 500);
      return res.status(e.status).json(e.body);
    }
    if (!st) {
      const e = bad('VALIDATION_ERROR', 'store not found', 404);
      return res.status(e.status).json(e.body);
    }

    // INSERTï¼ˆUNIQUE (store_id,name) è¡çªã¯ 409ï¼‰
    const { data, error } = await supabase.from('casts').insert(input).select('*').single();
    if (error) {
      if ((error as any).code === '23505') {
        // duplicate key
        return res
          .status(409)
          .json({ ok: false, code: 'DB_ERROR', message: 'duplicate cast (store_id,name)' });
      }
      const e = bad('DB_ERROR', error.message, 500);
      return res.status(e.status).json(e.body);
    }

    return res.status(200).json({ ok: true, item: data });
  }

  // ------------------------ GET /api/casts -------------------------
  if (req.method === 'GET') {
    const parsed = querySchema.safeParse(req.query);
    if (!parsed.success) {
      const e = bad('VALIDATION_ERROR', parsed.error.message, 400);
      return res.status(e.status).json(e.body);
    }
    const { keyword, owner, genre, drinkable, wage_min, active, page, limit, sort } = parsed.data;

    const rFrom = (page - 1) * limit;
    const rTo = rFrom + limit - 1;

    // COUNT
    let cq = supabase.from('casts').select('*', { count: 'exact', head: true });
    if (keyword) cq = cq.ilike('name', `%${keyword}%`);
    if (owner) cq = cq.eq('owner', owner);
    if (genre) cq = cq.contains('genre', [genre]); // genre: text[]
    if (drinkable !== undefined) cq = cq.eq('drinkable', drinkable);
    if (wage_min !== undefined) cq = cq.gte('wage', wage_min);
    if (active !== undefined) cq = cq.eq('active', active);

    const { count: total, error: cntErr } = await cq;
    if (cntErr) {
      const e = bad('DB_ERROR', cntErr.message, 500);
      return res.status(e.status).json(e.body);
    }
    if ((total ?? 0) === 0 || rFrom >= (total ?? 0)) {
      return res
        .status(200)
        .json({ ok: true, items: [], page, limit, total: total ?? 0, hasNext: false });
    }

    // DATA
    let q = supabase.from('casts').select('*');
    if (keyword) q = q.ilike('name', `%${keyword}%`);
    if (owner) q = q.eq('owner', owner);
    if (genre) q = q.contains('genre', [genre]);
    if (drinkable !== undefined) q = q.eq('drinkable', drinkable);
    if (wage_min !== undefined) q = q.gte('wage', wage_min);
    if (active !== undefined) q = q.eq('active', active);

    if (sort) {
      const parts = sort
        .split(',')
        .map((s) => s.trim())
        .filter(Boolean);
      for (const p of parts) {
        const asc = !p.startsWith('-');
        const key = p.replace(/^[+-]/, '');
        if (SORTS.has(key)) q = q.order(key as any, { ascending: asc, nullsFirst: !asc });
      }
    } else {
      q = q.order('updated_at', { ascending: false }).order('name', { ascending: true });
    }

    q = q.range(rFrom, rTo);

    const { data, error } = await q;
    if (error) {
      const e = bad('DB_ERROR', error.message, 500);
      return res.status(e.status).json(e.body);
    }

    return res.status(200).json({
      ok: true,
      items: data ?? [],
      page,
      limit,
      total: total ?? 0,
      hasNext: rTo + 1 < (total ?? 0),
    });
  }

  // ------------------------ ãã‚Œä»¥å¤– -------------------------
  const e = bad('VALIDATION_ERROR', 'Method Not Allowed', 405);
  return res.status(e.status).json(e.body);
}
</file>

<file path="pages/actions.tsx">
// pages/actions.tsx
import Head from "next/head";

export default function Actions() {
  return (
    <>
      <Head>
        <title>é€²æ—ã‚µãƒãƒª & æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ğŸ’¡2025/09/24æ›´æ–°</title>
      </Head>

      <main style={{ fontFamily: "system-ui, sans-serif", padding: "2rem", lineHeight: 1.6 }}>
        <h1>ğŸš€ é€²æ—ã‚µãƒãƒª & æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h1>
        <p>å¹´å†…MVPã«å‘ã‘ã€å®Ÿè£…æ¸ˆã¿ã¨æ¬¡ã®ä¸€æ‰‹ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«æ•´ç†ã—ã¾ã—ãŸã€‚</p>

        {/* å®Ÿè£…ã‚µãƒãƒª */}
        <h2>âœ… ç¾åœ¨ã®é€²æ—ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰</h2>
        <ul>
          <li>
            <strong>RBACï¼š</strong> è»½é‡Authï¼ˆ<code>x-user-id</code>ï¼‰ï¼‹ <code>Roles</code> ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ï¼
            <code>RolesGuard</code> å®Ÿè£…ã€‚å½¹å‰²ï¼š<code>ADMIN</code> / <code>STAFF</code> /{" "}
            <code>VIEWER</code>ï¼ˆseed ã§ä½œæˆæ¸ˆï¼‰
          </li>
          <li>
            <strong>Applicationsï¼š</strong> ä¸€è¦§ãƒ»è©³ç´°ãƒ»é¢æ¥ç¥¨Upsertãƒ»æ‰¿èªï¼ˆCastè‡ªå‹•ä½œæˆ/æ›´æ–°ï¼‰ãƒ»æ‰¿èªå¾Œè£œå®Œãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã€‚
          </li>
          <li>
            <strong>Castsï¼š</strong> ä¸€è¦§ãƒ»è©³ç´°ãƒ»æœ¬ä½“/å±æ€§/å¸Œæœ›/èƒŒæ™¯ã®æ›´æ–°ã€Applicationâ‡„Cast åŒæœŸã€{" "}
            <strong>NGã®è¿½åŠ /å‰Šé™¤</strong> APIã€‚
          </li>
          <li>
            <strong>Shopsï¼š</strong> ä¸€è¦§/è©³ç´°/ä½œæˆ/æ›´æ–°ï¼ˆè¦æ±‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å…¨å…¥æ›¿ï¼‰ã‚’å®Ÿè£…ã€‚
          </li>
          <li>
            <strong>Swaggerï¼š</strong> DTOã«æ²¿ã£ãŸ Example ã‚’åæ˜ ï¼ˆä¾‹ï¼š<code>POST /applications/:id/docs</code>ï¼‰ã€‚
          </li>
          <li>
            <strong>ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼š</strong> <code>npm run smoke</code>ï¼ˆE2Eæœ€å°ï¼‰ /{" "}
            <code>npm run smoke:rbac</code>ï¼ˆæ¨©é™ç¢ºèªï¼‰ã‚’ <code>scripts/</code> ã«æ•´å‚™ã€‚
          </li>
          <li>
            <strong>Seedï¼š</strong> å½¹å‰²ï¼‹3ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆADMIN/STAFF/VIEWERï¼‰ã‚’è‡ªå‹•æŠ•å…¥ã€‚å‡ºåŠ›IDã‚’ãã®ã¾ã¾ãƒ†ã‚¹ãƒˆã«åˆ©ç”¨å¯èƒ½ã€‚
          </li>
          <li>
            <strong>ç›£æŸ»ãƒ­ã‚°ï¼š</strong> <code>audit_logs</code> ãƒ†ãƒ¼ãƒ–ãƒ«ã«é‡è¦æ“ä½œã‚’è¨˜éŒ²ã€‚
            ä¾‹ï¼š<code>application.approve</code>ãƒ»<code>cast.ng.upsert</code>ãƒ»<code>cast.ng.delete</code>ã€‚
            <br />
            ä¾‹ï¼š<code>diff</code> ã«ã¯ <code>{'{'}migrated, supplementedFields, approvedAt{'}'}</code> ãªã©ã‚’æ ¼ç´ã€‚
          </li>
        </ul>

        {/* ä½¿ã„æ–¹ã®è¦ç‚¹ï¼ˆPM/é–¢ä¿‚è€…å‘ã‘ãƒ¡ãƒ¢ï¼‰ */}
        <details style={{ margin: "1rem 0" }}>
          <summary>
            <strong>â„¹ï¸ å‹•ä½œç¢ºèªã®è¦ç‚¹ï¼ˆæŠœç²‹ï¼‰</strong>
          </summary>
          <ul>
            <li>ãƒ˜ãƒƒãƒ€ <code>x-user-id</code> ã« Seed ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¨­å®šã€‚</li>
            <li>
              <code>POST /applications</code> â†’ <code>PATCH /applications/:id/form</code> â†’{" "}
              <code>PATCH /applications/:id/approve</code>ï¼ˆæ‰¿èªã¯ ADMIN æ¨©é™ï¼‰ã€‚
            </li>
            <li>
              Cast ã¯ <code>GET /casts</code> / <code>GET /casts/:id</code> ã§ç¢ºèªã€‚æ›´æ–°ç³»ã¯ ADMIN/STAFF ã®ã¿ã€‚
            </li>
            <li>
              NGè¿½åŠ /å‰Šé™¤ï¼š<code>POST /casts/:castId/ngs</code> /{" "}
              <code>DELETE /casts/:castId/ngs/:shopId</code>ï¼ˆADMIN/STAFFï¼‰ã€‚
            </li>
          </ul>
        </details>

        {/* æ¬¡ã®ä¸€æ‰‹ */}
        <h2>ğŸ§­ æ¬¡ã®ä¸€æ‰‹ï¼ˆææ¡ˆï¼‰</h2>
        <ol>
          <li>
            <strong>ã‚·ãƒ•ãƒˆ/å‡ºå‹¤ã®æœ€å°ã‚¹ã‚³ãƒ¼ãƒ—å®Ÿè£…</strong>
            <ul>
              <li>ERDã«æ²¿ã£ã¦ <code>shifts</code> / <code>attendances</code> ã® read-only API ã‚’å…ˆè¡Œï¼ˆå½“æ—¥ä¸€è¦§ï¼‰ã€‚</li>
              <li>
                å„ªå…ˆAPIï¼š<code>GET /shifts?from&to&page</code>ã€<code>PATCH /shifts/:id</code>ï¼ˆç¢ºå®š/å–æ¶ˆï¼‰ã€‚
              </li>
            </ul>
          </li>
          <li>
            <strong>å¿œå‹Ÿãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å°ç·š</strong>
            <ul>
              <li>
                <code>POST /applications/:id/docs/presign</code>ï¼ˆS3 ç½²åURLç™ºè¡Œï¼‰ã‚’è¿½åŠ ã—ã€ç¾è¡Œ{" "}
                <code>/docs</code> ç™»éŒ²ã¨æ¥ç¶šã€‚
              </li>
              <li>
                ã‚­ãƒ¼è¦ç´„ï¼š<code>applications/&lt;appId&gt;/&lt;docType&gt;/&lt;uuid&gt;</code>ã€TTLâ‰ˆ10åˆ†ã€privateãƒã‚±ãƒƒãƒˆã€‚
              </li>
            </ul>
          </li>
          <li>
            <strong>ç›£æŸ»ãƒ­ã‚°ã®ç¶™ç¶šå¼·åŒ–</strong>
            <ul>
              <li>é‡è¦æ“ä½œï¼ˆå¿œå‹Ÿæ‰¿èªãƒ»NGç™»éŒ²ãƒ»ã‚·ãƒ•ãƒˆç¢ºå®šï¼‰ã® JSON diff ã‚’è¨˜éŒ²ã™ã‚‹ä»•çµ„ã¿ã‚’ç¶™ç¶šæ•´å‚™ã€‚</li>
              <li>æœ€åˆã¯ã‚¢ãƒ—ãƒªå†…ãƒ­ã‚° â†’ å¾Œæ—¥å¤–éƒ¨é›†ç´„ï¼ˆCloudWatch/Datadogç­‰ï¼‰ã€‚</li>
            </ul>
          </li>
          <li>
            <strong>ãƒ†ã‚¹ãƒˆ/è‡ªå‹•åŒ–ã®å¼·åŒ–</strong>
            <ul>
              <li>
                <code>npm run smoke</code> ã« Shops ã¨ NG æ“ä½œã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ã€‚
              </li>
              <li>Applicationâ‡„Cast åŒæœŸã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’1ã€œ2æœ¬ã ã‘å…ˆã«ï¼ˆå¤‰æ›´å½±éŸ¿ãŒå¤§ãã„ç®‡æ‰€ï¼‰ã€‚</li>
            </ul>
          </li>
          <li>
            <strong>ãƒãƒ¼ã‚¿ãƒ«æ›´æ–°</strong>
            <ul>
              <li>ã€Œé–‹ç™ºãƒ«ãƒ¼ãƒ« v1.0ã€ã€Œã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ« v1.0ã€ã€ŒERDï¼ˆMermaidï¼‰ã€ã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã€‚</li>
              <li>Swaggerã® Example JSON ã¯ DTO æ¨ªã«é…ç½®ã—ã€PR ã§å·®åˆ†ãƒ¬ãƒ“ãƒ¥ãƒ¼çŸ­ç¸®ã‚’æ˜è¨˜ã€‚</li>
            </ul>
          </li>
        </ol>

        {/* PM é€£æºäº‹é … */}
        <h2>ğŸ¤ PM é€£æºãƒã‚¤ãƒ³ãƒˆï¼ˆè¦å›ç­”ï¼‰</h2>
        <ul>
          <li>ã€LIFF/å¿œå‹Ÿã€‘å¿…é ˆé …ç›®ãƒ»åŒæ„æ–‡è¨€ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ï¼ˆè¡¨/è£/ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ï¼‰ã®ç¢ºå®šã€‚</li>
          <li>ã€NGé‹ç”¨ã€‘åº—èˆ—èµ·ç‚¹NGã¯å½“é¢ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é‹ç”¨ã§OKã‹ã€‚</li>
          <li>ã€åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã€‘ä½æ‰€åˆ†å‰²ï¼ˆéƒ½é“åºœçœŒ/å¸‚åŒºï¼‰ãƒ»é›»è©±ãƒ»è¦æ±‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®Excelé››å½¢ç¢ºå®šã€‚</li>
          <li>ã€SLAã€‘ã€ŒLINEã‚¤ãƒ™ãƒ³ãƒˆâ†’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åæ˜  â‰¤ 10ç§’ã€ã®åˆæ„ã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ã€‚</li>
          <li>ã€å„ªå…ˆé †ä½ã€‘æ¬¡å®Ÿè£…ã‚’ã€Œã‚·ãƒ•ãƒˆç®¡ç†ã€ã‹ã‚‰ç€æ‰‹ã§å•é¡Œãªã„ã‹ï¼ˆä»–å„ªå…ˆãŒã‚ã‚Œã°å…¥æ›¿å¯ï¼‰ã€‚</li>
        </ul>

        {/* æŠ€è¡“ãƒã‚§ãƒƒã‚¯ */}
        <h2>ğŸ§° æŠ€è¡“æº–å‚™ãƒã‚§ãƒƒã‚¯</h2>
        <ul>
          <li>.env ãƒ†ãƒ³ãƒ—ãƒ¬ï¼šDB/S3/LINE/JWT ãªã©å¿…é ˆã‚­ãƒ¼ã‚’åˆ—æŒ™ã€‚</li>
          <li>ESLint/Prettier ã‚’ãƒ«ãƒ¼ãƒˆã«é©ç”¨ã€CIï¼ˆlint/typecheck/testï¼‰æœ‰åŠ¹åŒ–ã€‚</li>
          <li>
            Swagger ã‚’ <code>/api/docs</code> ã§å¸¸è¨­ã€PR ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ·»ä»˜ã€‚
          </li>
        </ul>

        {/* ä»Šå¾Œã®æµã‚Œ */}
        <h2>ğŸ“… ä»Šå¾Œã®æµã‚Œ</h2>
        <ol>
          <li>ãƒãƒ¼ã‚¿ãƒ«æ›´æ–° â†’ PMç¢ºèª</li>
          <li>å›ç­”åæ˜  â†’ ERDå·®åˆ†ãªã—ã‚’ç¢ºèª â†’ <strong>Prisma schema ç¢ºå®š</strong></li>
          <li>å„ªå…ˆAPIï¼ˆã‚·ãƒ•ãƒˆ/ç½²åç™ºè¡Œ/ç›£æŸ»ãƒ­ã‚°é››å½¢ï¼‰ã‚’å®Ÿè£… â†’ stg I/F è©¦é¨“ â†’ ç”»é¢çµ±åˆ</li>
          <li>å¿œå‹Ÿã€œæ‰¿èªã€œæœ¬ç™»éŒ²ã®E2Eã‚’é€šã—ã€NGé™¤å¤–ãƒ­ã‚¸ãƒƒã‚¯ã‚‚åˆã‚ã›ã¦æ¤œè¨¼</li>
        </ol>

        <p style={{ marginTop: "2rem", color: "#b42318" }}>
          â€»æœªç¢ºå®šï¼šLIFFåŒæ„æ–‡è¨€ãƒ†ãƒ³ãƒ—ãƒ¬ã€åº—èˆ—ãƒªã‚¹ãƒˆã®è¦æ±‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®šç¾©ã€‚<br />
          â†’ é€£æºå¾Œã€ã‚¹ã‚­ãƒ¼ãƒ/ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³/æ¤œç´¢æ¡ä»¶ã«å³æ™‚åæ˜ ã—ã¾ã™ã€‚
        </p>

        {/* å‚è€ƒï¼šã‚³ãƒãƒ³ãƒ‰ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰ */}
        <details style={{ marginTop: "1rem" }}>
          <summary>
            <strong>ğŸ”§ å‚è€ƒã‚³ãƒãƒ³ãƒ‰ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰</strong>
          </summary>
          <pre style={{ background: "#f6f8fa", padding: "1rem", overflowX: "auto" }}>{`# seedï¼ˆIDã¯RBAC/ã‚¹ãƒ¢ãƒ¼ã‚¯ã§ä½¿ç”¨ï¼‰
npm run seed

# ã‚¹ãƒ¢ãƒ¼ã‚¯ï¼ˆE2Eæœ€å°ï¼RBACï¼‰
export ADMIN_ID=...; export STAFF_ID=...; export VIEWER_ID=...
npm run smoke
npm run smoke:rbac

# å¿œå‹Ÿâ†’æ‰¿èªï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼šSTAFFã§å¿œå‹Ÿâ†’ADMINã§æ‰¿èªï¼‰
BASE=http://localhost:4000/api/v1
H_JSON='content-type: application/json'

APP_RESP=$(
  curl -sS -X POST "$BASE/applications" -H "$H_JSON" -H "x-user-id: $STAFF_ID" \
  -d "$(jq -n --arg ch line --arg em "audit_\${RANDOM}@example.com" --arg ph "+819012345678" \
        '{channel:$ch, email:$em, phone:$ph}')"
)
APP_ID=$(echo "$APP_RESP" | jq -r '.id // empty')

curl -sS -X PATCH "$BASE/applications/$APP_ID/approve" \
  -H "$H_JSON" -H "x-user-id: $ADMIN_ID" -d '{}' | jq .

# NGè¿½åŠ /å‰Šé™¤ï¼ˆSTAFFï¼‰
CAST_ID=$(curl -sS "$BASE/casts?take=1" -H "x-user-id: $STAFF_ID" | jq -r '.[0].userId')
SHOP_ID=$(curl -sS -X POST "$BASE/shops" -H "$H_JSON" -H "x-user-id: $STAFF_ID" \
  -d '{"name":"NGç›£æŸ»ãƒ†ã‚¹ãƒˆåº—"}' | jq -r .id)

curl -sS -X POST "$BASE/casts/$CAST_ID/ngs" \
  -H "$H_JSON" -H "x-user-id: $STAFF_ID" \
  -d "$(jq -n --arg id "$SHOP_ID" --arg src staff --arg reason 'ç›£æŸ»ãƒ†ã‚¹ãƒˆ' \
        '{shopId:$id, source:$src, reason:$reason}')" | jq .

curl -sS -X DELETE "$BASE/casts/$CAST_ID/ngs/$SHOP_ID" \
  -H "x-user-id: $STAFF_ID" | jq .
`}</pre>
        </details>
      </main>
    </>
  );
}
</file>

<file path="package.json">
{
    "name": "tiara-portal",
    "private": true,
    "scripts": {
        "dev": "next dev -p 3000",
        "dev:3001": "next dev -p 3001",
        "build": "next build",
        "start": "next start",
        "lint": "next lint",
        "seed": "ts-node -r tsconfig-paths/register --compiler-options '{\"module\":\"commonjs\"}' scripts/seed.ts",
        "test:api": "bash scripts/test-api.sh"
    },
    "dependencies": {
        "@supabase/supabase-js": "^2.57.4",
        "dayjs": "^1.11.18",
        "next": "^15.5.3",
        "next-mdx-remote": "^5.0.0",
        "react": "^18.3.1",
        "react-dom": "^18.3.1",
        "rehype-autolink-headings": "^7.1.0",
        "rehype-slug": "^6.0.0",
        "remark-gfm": "^4.0.1",
        "zod": "^4.1.11"
    },
    "devDependencies": {
        "@types/node": "^24.5.2",
        "@types/react": "latest",
        "@types/react-dom": "latest",
        "dotenv": "^17.2.2",
        "ts-node": "^10.9.2",
        "tsconfig-paths": "^4.2.0",
        "typescript": "latest"
    }
}
</file>

<file path="scripts/test-api.sh">
#!/usr/bin/env bash
set -euo pipefail

# BASE_URL ã‚’ç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½ã«ï¼ˆä¾‹ï¼šBASE_URL=http://localhost:3001 npm run test:apiï¼‰
BASE_URL="${BASE_URL:-http://localhost:3000}"

# ---- portable ISO8601 (UTC) helpers ----
iso_utc() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }

# Linux(GNU) å„ªå…ˆã€ãƒ€ãƒ¡ãªã‚‰ macOS(BSD) ç”¨ã« "+10 hours" -> "-v+10H" ã«å¤‰æ›ã—ã¦å®Ÿè¡Œ
rel_utc() {
  local spec="$1"     # ä¾‹: "-15 days" / "+10 hours" / "+4 hours"
  if date -u -d "$spec" +"%Y-%m-%dT%H:%M:%SZ" >/dev/null 2>&1; then
    date -u -d "$spec" +"%Y-%m-%dT%H:%M:%SZ"
    return
  fi
  # BSD date å¤‰æ›
  local sign num unit bsd_unit
  sign="${spec%% *}"           # "+10" or "-15"
  unit="${spec#* }"            # "hours" / "days" ãªã©
  num="${sign#[-+]}"           # "10" / "15"
  sign="${sign:0:1}"           # "+" / "-"
  case "$unit" in
    day|days)       bsd_unit="d" ;;
    hour|hours)     bsd_unit="H" ;;
    minute|minutes) bsd_unit="M" ;;
    second|seconds) bsd_unit="S" ;;
    week|weeks)     bsd_unit="w" ;;
    month|months)   bsd_unit="m" ;;
    year|years)     bsd_unit="y" ;;
    *) echo "Unsupported unit: $unit" >&2; return 1 ;;
  esac
  date -u -v"${sign}${num}${bsd_unit}" +"%Y-%m-%dT%H:%M:%SZ"
}

FROM="$(rel_utc "-15 days")"
TO="$(rel_utc "+15 days")"

echo "== casts default =="
curl -fsS "${BASE_URL}/api/casts" | jq .

echo "== casts validation NG =="
# å¤‰ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ 400 ãŒè¿”ã‚‹ã“ã¨ã‚’æœŸå¾…ã€‚-f ã¯ä½¿ã‚ãšã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§åˆ¤å®š
tmpfile="$(mktemp)"
code=$(curl -sS -G "${BASE_URL}/api/casts" \
  --data-urlencode "page=abc" \
  -o "$tmpfile" -w "%{http_code}")
cat "$tmpfile" | jq .
if [ "$code" -ne 400 ]; then
  echo "Expected HTTP 400 but got $code"
  cat "$tmpfile"
  rm -f "$tmpfile"
  exit 1
fi
rm -f "$tmpfile"

echo "== stores keyword =="
curl -fsS -G "${BASE_URL}/api/stores" \
  --data-urlencode "keyword=ä¸­æ´²" | jq .

# storesã®å…ˆé ­ã‚’å–å¾—ï¼ˆCasts/Shiftsã®POSTã«åˆ©ç”¨ï¼‰
first_store=$(curl -fsS "${BASE_URL}/api/stores" | jq -r '.items[0].id')
if [ -z "${first_store}" ] || [ "${first_store}" = "null" ]; then
  echo "No store found. Aborting."
  exit 1
fi

# ---------------------------
# å›å¸°æ¤œçŸ¥: Casts POST -> 409 -> PATCH -> 404
# ---------------------------
echo "== casts POST/PATCH smoke =="

unique_name="__smoke_cast__$(date -u +%s)"
cast_post_payload=$(cat <<JSON
{
  "store_id":"${first_store}",
  "name":"${unique_name}",
  "nickname":"Smoke",
  "wage":2000,
  "rating":4.0,
  "genre":["ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼"],
  "drinkable":true,
  "owner":"Tiara"
}
JSON
)

# POST /api/casts
cast_post_resp=$(curl -sS -X POST "${BASE_URL}/api/casts" \
  -H "Content-Type: application/json" \
  -d "${cast_post_payload}")
echo "$cast_post_resp" | jq .
new_cast_id=$(echo "$cast_post_resp" | jq -r '.item.id')
if [ -z "$new_cast_id" ] || [ "$new_cast_id" = "null" ]; then
  echo "POST /api/casts did not return item.id"
  exit 1
fi

# é‡è¤‡ï¼ˆåŒstore_id+nameï¼‰ã§ 409 ã‚’æœŸå¾…
dup_code=$(curl -s -X POST "${BASE_URL}/api/casts" \
  -H "Content-Type: application/json" \
  -d "{\"store_id\":\"${first_store}\",\"name\":\"${unique_name}\"}" \
  -o /dev/null -w "%{http_code}")
if [ "$dup_code" -ne 409 ]; then
  echo "Expected 409 on duplicate cast, got $dup_code"
  exit 1
fi

# PATCH /api/casts/[id]
cast_patch_resp=$(curl -sS -X PATCH "${BASE_URL}/api/casts/${new_cast_id}" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"UpdatedSmoke","rating":4.2}')
echo "$cast_patch_resp" | jq .
patched_nickname=$(echo "$cast_patch_resp" | jq -r '.item.nickname')
if [ "$patched_nickname" != "UpdatedSmoke" ]; then
  echo "PATCH /api/casts failed: nickname not updated"
  exit 1
fi

# ä¸åœ¨ID 404 ã‚’æœŸå¾…
nf_code=$(curl -s -X PATCH "${BASE_URL}/api/casts/00000000-0000-0000-0000-000000000000" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"x"}' \
  -o /dev/null -w "%{http_code}")
if [ "$nf_code" -ne 404 ]; then
  echo "Expected 404 on PATCH non-existent cast, got $nf_code"
  exit 1
fi

echo "== shifts range & sort =="
body=$(curl -fsS -G "${BASE_URL}/api/shifts" \
  --data-urlencode "from=${FROM}" \
  --data-urlencode "to=${TO}" \
  --data-urlencode "sort=starts_at" )
echo "$body" | jq .

# æœ€ä½é™ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆtotal>=1 ã‚’æœŸå¾…ï¼‰
total=$(echo "$body" | jq -r '.total // 0')
if [ "$total" -lt 1 ]; then
  echo "Expected shifts.total >= 1 but got $total"
  exit 1
fi

# ä»£è¡¨ cast ã®åå‰å±•é–‹ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚Œã°OKï¼‰
cast_id=$(curl -fsS "${BASE_URL}/api/casts" | jq -r '.items[0].id')
if [ "$cast_id" != "null" ] && [ -n "$cast_id" ]; then
  echo "== shifts expand=names =="
  curl -fsS -G "${BASE_URL}/api/shifts" \
    --data-urlencode "cast_id=${cast_id}" \
    --data-urlencode "expand=names" | jq .
fi

# ---------------------------
# å›å¸°æ¤œçŸ¥: Shifts POST -> PATCH
# ---------------------------
echo "== shifts POST/PATCH smoke =="

# ä»»æ„ã® castï¼ˆå…ˆé ­ï¼‰ã‚’å–å¾—
first_cast=$(curl -fsS "${BASE_URL}/api/casts" | jq -r '.items[0].id')
if [ -z "${first_cast}" ] || [ "${first_cast}" = "null" ]; then
  echo "No cast found to run POST/PATCH smoke."
  exit 1
fi

START_AT="$(rel_utc "+10 days")"

# END_AT = START_AT + 4hï¼ˆGNU/BSD ä¸¡å¯¾å¿œï¼‰
if date -u -d "${START_AT} +4 hours" +"%Y-%m-%dT%H:%M:%SZ" >/dev/null 2>&1; then
  END_AT=$(date -u -d "${START_AT} +4 hours" +"%Y-%m-%dT%H:%M:%SZ")
else
  # BSD: START_AT ã‚’åŸºæº–ã« +4H
  END_AT=$(date -u -j -f "%Y-%m-%dT%H:%M:%SZ" "${START_AT}" +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || echo "${START_AT}")
  END_AT=$(date -u -v+4H -j -f "%Y-%m-%dT%H:%M:%SZ" "${END_AT}" +"%Y-%m-%dT%H:%M:%SZ")
fi

post_payload=$(cat <<JSON
{
  "cast_id": "${first_cast}",
  "store_id": "${first_store}",
  "starts_at": "${START_AT}",
  "ends_at": "${END_AT}",
  "status": "scheduled",
  "role": "cast",
  "pay_rate": 2500,
  "memo": "smoke"
}
JSON
)

# POST /api/shifts
post_resp=$(curl -sS -X POST "${BASE_URL}/api/shifts" \
  -H "Content-Type: application/json" \
  -d "${post_payload}")
echo "${post_resp}" | jq .
new_id=$(echo "${post_resp}" | jq -r '.item.id')
if [ -z "${new_id}" ] || [ "${new_id}" = "null" ]; then
  echo "POST /api/shifts did not return item.id"
  exit 1
fi

# PATCH -> canceled
patch_code=$(curl -sS -o /dev/null -w "%{http_code}" -X PATCH "${BASE_URL}/api/shifts/${new_id}" \
  -H "Content-Type: application/json" \
  -d '{"status":"canceled","memo":"smoke canceled"}')
if [ "$patch_code" -ne 200 ]; then
  echo "PATCH /api/shifts/${new_id} failed (HTTP ${patch_code})"
  exit 1
fi

# å–å¾—ã—ã¦ canceled ã‚’ç¢ºèª
get_one=$(curl -fsS -G "${BASE_URL}/api/shifts" \
  --data-urlencode "cast_id=${first_cast}" \
  --data-urlencode "from=$(rel_utc '+9 days')" \
  --data-urlencode "to=$(rel_utc '+11 days')" \
  --data-urlencode "sort=starts_at")
echo "${get_one}" | jq .
status=$(echo "${get_one}" | jq -r '.items[] | select(.id=="'"${new_id}"'") | .status')
if [ "${status}" != "canceled" ]; then
  echo "Expected status=canceled for ${new_id}, got ${status:-<empty>}"
  exit 1
fi

echo "âœ… smoke tests passed"
</file>

<file path="pages/index.tsx">
import Head from "next/head";
import Link from "next/link";

export default function Home() {
  return (
    <>
      <Head>
        <title>Tiara System Portal</title>
      </Head>
      <main style={{ fontFamily: "system-ui, sans-serif", padding: "2rem" }}>
        <h1>Tiara System é–‹ç™ºãƒãƒ¼ã‚¿ãƒ«</h1>
        <p>ä¸­æ´²äººææ´¾é£ã€Œãƒ†ã‚£ã‚¢ãƒ©ãƒãƒƒãƒˆã€ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã¾ã¨ã‚ã‚µã‚¤ãƒˆ</p>

        <h2>ğŸ“Œ æ¦‚è¦</h2>
        <ul>
          <li>å¯¾è±¡ï¼šä¸­æ´²ã€Œãƒ†ã‚£ã‚¢ãƒ©ãƒãƒƒãƒˆã€</li>
          <li>æä¾›å½¢æ…‹ï¼šPWAï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰ï¼‹ Webç®¡ç†</li>
          <li>å¹´å†…ãƒªãƒªãƒ¼ã‚¹ç¯„å›²ï¼šã‚­ãƒ£ã‚¹ãƒˆ/ã‚¹ã‚¿ãƒƒãƒ•/åº—èˆ—ï¼ˆAIé™¤ãï¼‰</li>
          <li>ç¿Œå¹´ä»¥é™ï¼šAIãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½</li>
        </ul>

        <h2>ğŸ”— ãƒšãƒ¼ã‚¸ä¸€è¦§</h2>
        <ul>
          <li><Link href="/wbs">WBS & ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆğŸ†•9/28</Link></li>
          <li><Link href="/erd">ERDå›³ğŸ†•10/17</Link></li>
          <li><Link href="/rules">é–‹ç™ºãƒ«ãƒ¼ãƒ«</Link></li>
          <li><Link href="/docs/coding-rules">ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«</Link></li> {/* â† è¿½åŠ  */}
          <li><Link href="/actions">æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ğŸ†•9/24</Link></li>
          <li><a href="/questionnaire">è³ªå•ç¥¨</a></li>
        </ul>
      </main>
    </>
  );
}
</file>

<file path="pages/erd.tsx">
import Head from "next/head";

export default function ERD() {
  return (
    <>
      <Head>
        <title>ERDå›³</title>
      </Head>
      <main style={{ fontFamily: "system-ui, sans-serif", padding: "2rem" }}>
        <h1>ğŸ—‚ ERDå›³</h1>
        <p>æœ€æ–°ã®ERDå›³ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å‚ç…§ã§ãã¾ã™ã€‚</p>

        <ul>
          <li>
            <a
              href="https://mermaid.live/edit#pako:eNrFWmlTG0ca_itTqk2VvQaPOWIbVeUDAdmm4gAGvNlKyE4NMy1potGMMgc2sakCKcbC4A2bw_FBDq-xTZwYJ_Fmw4KP_5JhJPEpf2Hf7jk0PYdAJKlQLkvq-72e9-i-lBJUEaXSKaQNSnxO44uTCsO88grzmvfHjL3eP8CwTP_5iTPNVjzK1JGmM5fwV4bRDU1ScgzH6QZvmDrHMZMpe-Orxr0rtc2qNf_y12dVVOQlmZUlBXG6OcWcHx46dz7z67PFyZSzhGlKInzAf6NvUIvyppHnSpo6LYlIo3r8xSZTznKMYsoyPyUjb1F3INkb_95rYInX9QuqJnJ5Xs_Te6k5SeHgdJOpne3t2ocfAUkDQy4ZjDX_pLb6yKE4QJM7F7OKM2ZKCCbzYlFSWGBTNssKvG6wel4tcXhEaJLDSadpSlXx8YumbnBCnldyiPNO6gwwpCKCCcWS8UGTBmekyPFGdJAMW3MOTXHdgoZ4I2GqWRIDfbOTCv7QVBm1ow1Y71iFL6IERYiqAZ7RFGCIWWSlUKd7MsL8do9HJkniETwPC33PQ5Lf7izmVLDRW8JpDBxKZy5f7uxULwVPmGZA8Zr8jBsA0pVyChKdhShbHegfn6CNFGtYW2LBakE47Sr2EWbgTGbgDeYf7_R3vv3uO8c6-9691NXRM_sXwISdzTl760Fj_bG9cdt-sQw2sLN53V5bDLPJY8voGx2nQjL1t2v-gX29WEr3d3X3wBbuKfBeeOWQ1EVJL8n8DIel73RgzcT2ImlGHn93WiXFwB98DtHAIooa0nUaAPKqgqLYQZmhCO0FTi1QjSA3Dl0sIU1CikCvANiVlUAJYG1D5UzNXc1AF_GxFNU7JmWAwBRO0nWTGBowxSo_tSrPrMpi_dZW4-5y7VbZrm6H0cuckiWBZqiPeCzTuLteX9uqf7rurwUSbyz9UPvse_ujJ1Zl-9wYdAakR6FKc23qXNFFrfmNuDMeGF6C1nL5sqvSaQbkxAE7ibg8VYdJwIkp02jL2O2vtmqr39k_fFmbewjUW3NlR8IymkYym-clDciWVQ2jPGh7Y726s3kNqKwt3bWf_dQSEcihAohANDGPpFwe9L5I24KsGnn4wunSB0G9Bf-ASJs_gWgcUGOoaqBBQcC0kiQUzBJtJE1agHQF-MVeQHyBVQuY9O8Xal_cdwiJ-q0A6a5ZMrvbH7ON5f-yu1f_Bex4ZM1_k7TKbBN_XBgLS8gFO194JQ1lkYbNpy3pbS7XVu-ArtV_esDCx-6NT-zNJ6xVXrcqj6zyv-uPFx2h1r7aBqCqP932xQgyhDXaF6CIdEkDbudVMOaZmI6iqhh5r8dHAUwd7hX5GT2IdcybqtLxFhI7TmlS2KL9SdhEuCleEb1JXSfTx451dvfA_4mTeLCzINhg7cLhBsYcnepoNjgqSijjwNcAQCIRn9QRcpqxKgtW-R4w1qp847DU4b13iOD8rKxi3WHo-V9alYpVmd_ZXNq9tRI3TUCSjAlJmHYtMC1Ccg4pAOqBiY21qwBwIPOB8b_VKk_hvKA0p18HBfmfVbmG1yxjbXlsVe5ZlRX4Bkj4jVW5wfKyHDAJx8ZUCJdkQc2rMuB_4HwtVT6o12Gdn-KFQk5TTUVsR-f7SyUAY96QVOWXhY8HYCFmd26hcW_V3gA3XLbK1_YKVcJ67Vm8eoHL4tNQrUXVkKbJblQz4BU4dvCqiiAh2o2C3unAKyGvqjrtDIn-6UhGAl6PK6kgeL0F84IMCjAvGveMnhmZGBmPhj-O223J3UDoXgVYqH-6fUD26T1cAdFmX5AU0XfFWV5A4FDkLJuF_MMFUMoCYJ6qGRyE716uk-w3k9TNoTeJWcRPw7_PsZqX14ghPwVjsFeWIauJ4Z-gFkHbeFBf-KroSDH-YGYSU5NEjFKgjFoOiYH2IsR7EPeBt9SJ_y-pYAmIslEOlAVpoJcc8X1wQrpb1EzwiNA3TXeBiRq8zAGtU4A_xgw9S0ZZyJjMXM4PI91JJSywksoL-chOwB-EDE4XVNPwO4MChZwbBeIgLzB1WqVSXCuJprHRtdKBOJmlnRXidKK2fNVeuW5vgU5sD5-Gzxg1yPLTxHm0L_xf5rYPuTLuIOYviYcZOo3bl16QRneBsOUlRNH7sZcmYWlGlgoOkjkNrYaJ3NRMAMiVXDsA3nj53L72NWsvgi9b6x8dAr7X79wDd2pVHlvl73fn7tlLn7VrN634o4NnDaUlDkYfkGmYXD9ZjTIr0B1RtvEzI6MhnN5Tr0LsIx5VMEwNsQIYKjM0PJj5-94lhGaeGAwbyDp0KO4bP50pcrjgtEe6SOKP36GgQuTIgw3rqG2Lu21X70Ne1li_CXrVePQYmLazvQEWvpdGJSgPOQYX4R6QJNKQB05M59RsVhIkXva1h1IPiq6AipB2Db2PHSiuXrWjDjvPV2vVFQhDdzbnakvfOcYFpNfu_Kd2A0K_h_aVdfvK_dqdlwdkgHumFhRRJ2-l-cxY5tz5obHMm5nhiRgrwAuZkEMU93KzIRaMnp9gT2cmGMCSX5995JGxv7JVAtEBTY6mklxRUtygJphShmIZlxjIlEBVwAkq-8v3Y9nb5EoSe-07WxDd7165Dql8DGez0kXYpt2K2OjIOOEsO5g5m5nINJl7xIPfgzG5VRi5b2cWZVSQSB-fKfhOGhZhZ__o6Nmhgf6JoZHhcYZlBkcGQvrKN7OQdjiqQxRjP3lhv1wFZuLcZf-pi4fPeV5RkJxYLg9yTUOQTU4nIC9QoKlJnRp6D3xDoNMp56JpCV2AEIyU8EF4IUjMSfCV8ASCeCkHVjKZIogIgb9aDN834DQgCqxZE2byCn-AmmbL-mWLuqdXuWhWDGKLnUFo0BnqbzLlZ9rYBKufW3PlN5EGu4ukXPak8ei72s1_0jUXlwo378f1U8EIJJpeiTQXrVjgqUjDsqD6KPlhWSAtIEFvu7YKcHEluJY1HZf8-a-t-eU4ouNrO1lNLbbqN1TqTLGlJldmkdogs5_qIM1dkZtGmpR17ZtrQpLn6DF8aNqMl1-0KiO4ayaUEXCuggzJUHGtsekinDkxhQS3J7GQ4I9w6hMJ2tF2QBZAO05UhXYQD4Y713_1jbv1lQWITIIY2NpvBLeNegp_ZcoQQTak0gCfBWBbQWKBT1kJsYQj4XvGaM1CyCOhoJvFOM7IKi-2Yg1EQAUuD4YH6IcO6hZ-C0ucAqcPqTTCXHDxMubgbm30Tz9y3A0h5WnTng8SI044OtxRVT8S2Gt0SHr7nuczLzn0HTo1gd8RTExkhgf7hwcy4QhNyv7RdaXYOCyo3fCpGbGIgJSQE8GKxJUAXrBiBdrB9ZOyFN4mJj4BOkoyDl5E1os9WAGXaWSQJv0QwgOoqRmaAKYZtQS69h3VtHn1FgodiZDi8_5wJ6XAfqe7ffIA7_CugRoGsJ7f60ooNgk-N8bifPBWuVbdhrDSmv92f7battoQuOQSXlJoyDA1xbktda98qENt1Fbn6j-VnbtSfJ1V_aK-CPjyxL5-E0Ym3MY6W6qmES4dFpGRV0UmHJoBV9kir5i8zL4f_9AkMsXTU7IVrkYqbIkHmTVbYHuWn8LOn5VxXJpKuNd2IwYIFLKSVkRivHIFRR2vYTEjghe_bh_Ri9-IJJ4KBF4sEOt2qAX7Nng52txzTGzTptzr7OjpCXnNu20KSoczb6WZ_vHxodPDpIiAleb5J7XP79uLP8IXiC7snzdqd15a81WgKyYRdl6QFA9SyL8d3In192HtDx_ZV6r21oPfxbgcl9nkCenC7ndlGb85ubplL63ZC1fAeJyDwAG991wJ9uI9miFRNl6JzNu9sWQ_XDq0s1W1N26zQGx988XhltMN1bn0I9PBbHe2FujpHYzzOuxwgpEF8N9dk8U-F4awpGaPDN8jBFyCG8SUNAn8sjGDT7BwHdKM-vMNn_OH7LWHrzm_DodM0Q2iAVY1TRLxK7T6z9dqc_d9-UFQWv_0h0Oho_9-biOkdMFHTLHlQWqsm8HrYX-QPOOChBM5jviUuFgkfE2oqzoHGZDy5wcgGEaockOeV0TZvWtIqHb4yK_rfjVAMYuQvQkM4LJkmGK4VVVyfnOMvJrsSHD1kQERHo8CQL01MjbIjGXGM6FHaf4DRQ3pCKNpAbVVQJqYOGvNr5OL-mdW5VurMmeVH1iVpy0fk7ot4Sd67nbkDIFHn1Tsd7EEmbYer_r6vsKs2Ui8E8-DxFLc-cGhEBN5U5TIC852n_cdxU-4jjo2CwE5aVJyR_8K30lVsJPoAvx2bqet8seN9Zu7yz_umeIIOINv8teLIxJe2vJCpBAACuVfvJAlnQZOEkOhSXjJ9wDdphhRymYZJhLHQBxCXvsyIsrypmwwl2b3BriowAL8DkSxqY5UDiA1lTY0E3Wkik69K5VOEZlMpiDfxjW_NHwVeY2Ux2dhTolX3lbVojdNU81cPpXO8rIOvxzRuO-x_SEI32kP4PpIKn2ijyyRSl9KXUylO3tPdB3t6e7uefX4id7uY6_2dnekZlLprhN9R_t6e44fO9nd3XW8t6_v5GxH6gOya9fRrq7evhNdvd0nuru7X-0-fnL2_1ROtTc"
              target="_blank"
              rel="noopener noreferrer"
            >
              âœï¸ Mermaid Live Editorï¼ˆç·¨é›†ç”¨ï¼‰ğŸ’¡2025/10/17æ›´æ–°
            </a>
          </li>
          <li>
            <a
              href="https://mermaidchart.com/play?utm_source=mermaid_live_editor&utm_medium=share#pako:eNrFWmlTG0ca_itTqk2VvQaPOWIbVeUDAdmm4gAGvNlKyE4NMy1potGMMgc2sakCKcbC4A2bw_FBDq-xTZwYJ_Fmw4KP_5JhJPEpf2Hf7jk0PYdAJKlQLkvq-72e9-i-lBJUEaXSKaQNSnxO44uTCsO88grzmvfHjL3eP8CwTP_5iTPNVjzK1JGmM5fwV4bRDU1ScgzH6QZvmDrHMZMpe-Orxr0rtc2qNf_y12dVVOQlmZUlBXG6OcWcHx46dz7z67PFyZSzhGlKInzAf6NvUIvyppHnSpo6LYlIo3r8xSZTznKMYsoyPyUjb1F3INkb_95rYInX9QuqJnJ5Xs_Te6k5SeHgdJOpne3t2ocfAUkDQy4ZjDX_pLb6yKE4QJM7F7OKM2ZKCCbzYlFSWGBTNssKvG6wel4tcXhEaJLDSadpSlXx8YumbnBCnldyiPNO6gwwpCKCCcWS8UGTBmekyPFGdJAMW3MOTXHdgoZ4I2GqWRIDfbOTCv7QVBm1ow1Y71iFL6IERYiqAZ7RFGCIWWSlUKd7MsL8do9HJkniETwPC33PQ5Lf7izmVLDRW8JpDBxKZy5f7uxULwVPmGZA8Zr8jBsA0pVyChKdhShbHegfn6CNFGtYW2LBakE47Sr2EWbgTGbgDeYf7_R3vv3uO8c6-9691NXRM_sXwISdzTl760Fj_bG9cdt-sQw2sLN53V5bDLPJY8voGx2nQjL1t2v-gX29WEr3d3X3wBbuKfBeeOWQ1EVJL8n8DIel73RgzcT2ImlGHn93WiXFwB98DtHAIooa0nUaAPKqgqLYQZmhCO0FTi1QjSA3Dl0sIU1CikCvANiVlUAJYG1D5UzNXc1AF_GxFNU7JmWAwBRO0nWTGBowxSo_tSrPrMpi_dZW4-5y7VbZrm6H0cuckiWBZqiPeCzTuLteX9uqf7rurwUSbyz9UPvse_ujJ1Zl-9wYdAakR6FKc23qXNFFrfmNuDMeGF6C1nL5sqvSaQbkxAE7ibg8VYdJwIkp02jL2O2vtmqr39k_fFmbewjUW3NlR8IymkYym-clDciWVQ2jPGh7Y726s3kNqKwt3bWf_dQSEcihAohANDGPpFwe9L5I24KsGnn4wunSB0G9Bf-ASJs_gWgcUGOoaqBBQcC0kiQUzBJtJE1agHQF-MVeQHyBVQuY9O8Xal_cdwiJ-q0A6a5ZMrvbH7ON5f-yu1f_Bex4ZM1_k7TKbBN_XBgLS8gFO194JQ1lkYbNpy3pbS7XVu-ArtV_esDCx-6NT-zNJ6xVXrcqj6zyv-uPFx2h1r7aBqCqP932xQgyhDXaF6CIdEkDbudVMOaZmI6iqhh5r8dHAUwd7hX5GT2IdcybqtLxFhI7TmlS2KL9SdhEuCleEb1JXSfTx451dvfA_4mTeLCzINhg7cLhBsYcnepoNjgqSijjwNcAQCIRn9QRcpqxKgtW-R4w1qp847DU4b13iOD8rKxi3WHo-V9alYpVmd_ZXNq9tRI3TUCSjAlJmHYtMC1Ccg4pAOqBiY21qwBwIPOB8b_VKk_hvKA0p18HBfmfVbmG1yxjbXlsVe5ZlRX4Bkj4jVW5wfKyHDAJx8ZUCJdkQc2rMuB_4HwtVT6o12Gdn-KFQk5TTUVsR-f7SyUAY96QVOWXhY8HYCFmd26hcW_V3gA3XLbK1_YKVcJ67Vm8eoHL4tNQrUXVkKbJblQz4BU4dvCqiiAh2o2C3unAKyGvqjrtDIn-6UhGAl6PK6kgeL0F84IMCjAvGveMnhmZGBmPhj-O223J3UDoXgVYqH-6fUD26T1cAdFmX5AU0XfFWV5A4FDkLJuF_MMFUMoCYJ6qGRyE716uk-w3k9TNoTeJWcRPw7_PsZqX14ghPwVjsFeWIauJ4Z-gFkHbeFBf-KroSDH-YGYSU5NEjFKgjFoOiYH2IsR7EPeBt9SJ_y-pYAmIslEOlAVpoJcc8X1wQrpb1EzwiNA3TXeBiRq8zAGtU4A_xgw9S0ZZyJjMXM4PI91JJSywksoL-chOwB-EDE4XVNPwO4MChZwbBeIgLzB1WqVSXCuJprHRtdKBOJmlnRXidKK2fNVeuW5vgU5sD5-Gzxg1yPLTxHm0L_xf5rYPuTLuIOYviYcZOo3bl16QRneBsOUlRNH7sZcmYWlGlgoOkjkNrYaJ3NRMAMiVXDsA3nj53L72NWsvgi9b6x8dAr7X79wDd2pVHlvl73fn7tlLn7VrN634o4NnDaUlDkYfkGmYXD9ZjTIr0B1RtvEzI6MhnN5Tr0LsIx5VMEwNsQIYKjM0PJj5-94lhGaeGAwbyDp0KO4bP50pcrjgtEe6SOKP36GgQuTIgw3rqG2Lu21X70Ne1li_CXrVePQYmLazvQEWvpdGJSgPOQYX4R6QJNKQB05M59RsVhIkXva1h1IPiq6AipB2Db2PHSiuXrWjDjvPV2vVFQhDdzbnakvfOcYFpNfu_Kd2A0K_h_aVdfvK_dqdlwdkgHumFhRRJ2-l-cxY5tz5obHMm5nhiRgrwAuZkEMU93KzIRaMnp9gT2cmGMCSX5995JGxv7JVAtEBTY6mklxRUtygJphShmIZlxjIlEBVwAkq-8v3Y9nb5EoSe-07WxDd7165Dql8DGez0kXYpt2K2OjIOOEsO5g5m5nINJl7xIPfgzG5VRi5b2cWZVSQSB-fKfhOGhZhZ__o6Nmhgf6JoZHhcYZlBkcGQvrKN7OQdjiqQxRjP3lhv1wFZuLcZf-pi4fPeV5RkJxYLg9yTUOQTU4nIC9QoKlJnRp6D3xDoNMp56JpCV2AEIyU8EF4IUjMSfCV8ASCeCkHVjKZIogIgb9aDN834DQgCqxZE2byCn-AmmbL-mWLuqdXuWhWDGKLnUFo0BnqbzLlZ9rYBKufW3PlN5EGu4ukXPak8ei72s1_0jUXlwo378f1U8EIJJpeiTQXrVjgqUjDsqD6KPlhWSAtIEFvu7YKcHEluJY1HZf8-a-t-eU4ouNrO1lNLbbqN1TqTLGlJldmkdogs5_qIM1dkZtGmpR17ZtrQpLn6DF8aNqMl1-0KiO4ayaUEXCuggzJUHGtsekinDkxhQS3J7GQ4I9w6hMJ2tF2QBZAO05UhXYQD4Y713_1jbv1lQWITIIY2NpvBLeNegp_ZcoQQTak0gCfBWBbQWKBT1kJsYQj4XvGaM1CyCOhoJvFOM7IKi-2Yg1EQAUuD4YH6IcO6hZ-C0ucAqcPqTTCXHDxMubgbm30Tz9y3A0h5WnTng8SI044OtxRVT8S2Gt0SHr7nuczLzn0HTo1gd8RTExkhgf7hwcy4QhNyv7RdaXYOCyo3fCpGbGIgJSQE8GKxJUAXrBiBdrB9ZOyFN4mJj4BOkoyDl5E1os9WAGXaWSQJv0QwgOoqRmaAKYZtQS69h3VtHn1FgodiZDi8_5wJ6XAfqe7ffIA7_CugRoGsJ7f60ooNgk-N8bifPBWuVbdhrDSmv92f7battoQuOQSXlJoyDA1xbktda98qENt1Fbn6j-VnbtSfJ1V_aK-CPjyxL5-E0Ym3MY6W6qmES4dFpGRV0UmHJoBV9kir5i8zL4f_9AkMsXTU7IVrkYqbIkHmTVbYHuWn8LOn5VxXJpKuNd2IwYIFLKSVkRivHIFRR2vYTEjghe_bh_Ri9-IJJ4KBF4sEOt2qAX7Nng52txzTGzTptzr7OjpCXnNu20KSoczb6WZ_vHxodPDpIiAleb5J7XP79uLP8IXiC7snzdqd15a81WgKyYRdl6QFA9SyL8d3In192HtDx_ZV6r21oPfxbgcl9nkCenC7ndlGb85ubplL63ZC1fAeJyDwAG991wJ9uI9miFRNl6JzNu9sWQ_XDq0s1W1N26zQGx988XhltMN1bn0I9PBbHe2FujpHYzzOuxwgpEF8N9dk8U-F4awpGaPDN8jBFyCG8SUNAn8sjGDT7BwHdKM-vMNn_OH7LWHrzm_DodM0Q2iAVY1TRLxK7T6z9dqc_d9-UFQWv_0h0Oho_9-biOkdMFHTLHlQWqsm8HrYX-QPOOChBM5jviUuFgkfE2oqzoHGZDy5wcgGEaockOeV0TZvWtIqHb4yK_rfjVAMYuQvQkM4LJkmGK4VVVyfnOMvJrsSHD1kQERHo8CQL01MjbIjGXGM6FHaf4DRQ3pCKNpAbVVQJqYOGvNr5OL-mdW5VurMmeVH1iVpy0fk7ot4Sd67nbkDIFHn1Tsd7EEmbYer_r6vsKs2Ui8E8-DxFLc-cGhEBN5U5TIC852n_cdxU-4jjo2CwE5aVJyR_8K30lVsJPoAvx2bqet8seN9Zu7yz_umeIIOINv8teLIxJe2vJCpBAACuVfvJAlnQZOEkOhSXjJ9wDdphhRymYZJhLHQBxCXvsyIsrypmwwl2b3BriowAL8DkSxqY5UDiA1lTY0E3Wkik69K5VOEZlMpiDfxjW_NHwVeY2Ux2dhTolX3lbVojdNU81cPpXO8rIOvxzRuO-x_SEI32kP4PpIKn2ijyyRSl9KXUylO3tPdB3t6e7uefX4id7uY6_2dnekZlLprhN9R_t6e44fO9nd3XW8t6_v5GxH6gOya9fRrq7evhNdvd0nuru7X-0-fnL2_1ROtTc"
              target="_blank"
              rel="noopener noreferrer"
            >
              ğŸ‘€ Mermaid Chart Playgroundï¼ˆé–²è¦§ç”¨ï¼‰ğŸ’¡2025/10/17æ›´æ–°
            </a>
          </li>
        </ul>
        <h1>å‚™è€ƒ</h1>
        <p>å®Ÿè£…é †åºã¯ã€</p>
        <p>ã¾ãšå¿œå‹Ÿãƒ‡ãƒ¼ã‚¿ ï¼ˆapplicationsï¼‰ ã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆæœ¬ç™»éŒ²ï¼ˆcastsï¼‰ ã¸ã®ç§»è¡Œãƒ•ãƒ­ãƒ¼ã‚’å…ˆã«ä½œã£ã¦ã„ã¾ã™ã€‚</p>
        <p>ç†ç”±ã¯ã€å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ã§å…¥åŠ›ã•ã‚ŒãŸå†…å®¹ã‚’ã©ã®ã‚ˆã†ã«ã‚­ãƒ£ã‚¹ãƒˆæœ¬ç™»éŒ²ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã‹ã‚’å…ˆã«å›ºã‚ã‚‹ã“ã¨ã§ã€</p>
        <p>å¾Œç¶šã®ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†ç”»é¢ã‚„APIã®è¦ä»¶ãŒè‡ªç„¶ã«æ±ºã¾ã‚‹ãŸã‚ã§ã™ã€‚</p>
        <p>å…ˆã«ç§»è¡Œéƒ¨åˆ†ã‚’è»½å‚™ã—ã¦ãŠãã“ã¨ã§ã€å¾Œã‹ã‚‰ç”»é¢ã‚’ä½œã‚‹éš›ã«ä»•æ§˜ã®è¿·ã„ã‚„ä¿®æ­£ãŒå°‘ãªããªã‚Šã€å…¨ä½“ã®é–‹ç™ºåŠ¹ç‡ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</p>
        <h1>ã¾ã¨ã‚</h1>
        <p>ãƒ»ä»Šã¯ã€Œå¿œå‹Ÿâ†’æœ¬ç™»éŒ²ã€ã¸ã®æ©‹æ¸¡ã—ã‚’å…ˆã«å®Ÿè£…</p>
        <p>ãƒ»ã“ã‚Œã«ã‚ˆã‚Šã€å¾Œç¶šã®ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½é–‹ç™ºã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ç‹™ã„</p>
      </main>
    </>
  );
}
</file>

</files>
